{"version":3,"sources":["../../../../../src/lib/transactions/sendWalletTransaction.ts"],"names":[],"mappings":";;;;;AAiBA,eAAsB,qBAAA,CAAsB;AAAA,EAC1C,OAAA;AAAA,EACA,MAAA;AAAA,EACA,GAAA;AAAA,EACA,EAAA;AAAA,EACA,QAAA;AAAA,EACA,KAAA;AAAA,EACA,QAAA;AAAA,EACA,YAAA;AAAA,EACA,aAAA;AAAA,EACA,KAAA;AAAA,EACA;AACF,CAAA,EAaG;AACD,EAAA,MAAM,OAAO,MAAA,CAAO,OAAA;AACpB,EAAA,MAAM,YAAA,GAAe,IAAI,eAAA,CAA8B,EAAE,CAAA;AAEzD,EAAA,IAAI;AAEF,IAAA,MAAM,kBAAkB,QAAA,GACpB,OAAA,CAAQ,QAAQ,QAAQ,CAAA,GACxB,iBAAiB,GAAA,EAAK;AAAA,MACpB,EAAA;AAAA,MACA,IAAA;AAAA,MACA,IAAA,EAAM,QAAA;AAAA,MACN;AAAA,KACD,CAAA,CAAE,KAAA,CAAM,MAAM,KAAA,CAAS,CAAA;AAE5B,IAAA,MAAM,mBAAA,GAAsB,YAAA,GACxB,OAAA,CAAQ,OAAA,CAAQ,YAAY,CAAA,GAC5B,WAAA,CAAY,OAAA,EAAS,GAAI,CAAA,CAAE,KAAA,CAAM,MAAM,KAAA,CAAS,CAAA;AAEpD,IAAA,MAAM,CAAC,cAAA,EAAgB,kBAAkB,CAAA,GAAI,MAAM,QAAQ,GAAA,CAAI;AAAA,MAC7D,eAAA;AAAA,MACA,mBAAA;AAAA,MACA,aAAA,KAAkB,IAAA,CAAK,MAAM,WAAW,YAAA,CAAa,SAAA,EAAW,CAAC;AAAA,KAClE,CAAA;AAED,IAAA,QAAA,GAAW,YAAA,CAAa,SAAS,CAAA;AAEjC,IAAA,MAAM,OAAA,GAA8B;AAAA,MAClC,EAAA;AAAA,MACA,IAAA,EAAM,QAAA;AAAA,MACN,KAAA;AAAA,MACA,IAAA;AAAA,MACA,KAAA,EAAO,KAAA,KAAU,KAAA,CAAA,GAAY,MAAA,CAAO,KAAK,CAAA,GAAI,KAAA,CAAA;AAAA,MAC7C,QAAA,EAAU,cAAA;AAAA,MACV,GAAI,sBAAsB;AAAC,KAC7B;AAEA,IAAA,MAAM,GAAA,GAAM,MAAM,MAAA,CAAO,eAAA,CAAgB,OAAO,CAAA,CAAE,KAAA,CAAM,CAAC,KAAA,KAAU;AACjE,MAAA,MAAM,YAAY,KAAA,EAAO;AAAA,QACvB,YAAA,EAAc;AAAA,OACf,CAAA;AAAA,IACH,CAAC,CAAA;AAED,IAAA,QAAA;AAAA,MACE,aAAa,IAAA,CAAK;AAAA,QAChB,IAAA,EAAM,QAAA;AAAA,QACN,iBAAiB,GAAA,CAAI;AAAA,OACtB;AAAA,KACH;AAEA,IAAA,OAAO;AAAA,MACL,iBAAiB,GAAA,CAAI,IAAA;AAAA,MACrB,IAAA,EAAM,yBAAA,CAA0B,GAAA,CAAI,IAAA,EAAM,GAAG;AAAA,KAC/C;AAAA,EACF,SAAS,KAAA,EAAY;AACnB,IAAA,QAAA,GAAW,YAAA,CAAa,KAAA,CAAM,KAAK,CAAC,CAAA;AAEpC,IAAA,MAAM,KAAA;AAAA,EACR;AACF;AAEA,SAAS,yBAAA,CAA0B,MAAc,GAAA,EAA0B;AACzE,EAAA,OAAO,YAAY;AACjB,IAAA,MAAM,OAAA,GAAU,MAAM,GAAA,CAAI,IAAA,EAAK;AAC/B,IAAA,OAAO;AAAA,MACL,eAAA,EAAiB,IAAA;AAAA,MACjB,aAAa,OAAA,EAAS,WAAA;AAAA,MACtB,MAAA,EAAQ,OAAA,EAAS,MAAA,KAAW,CAAA,GAAI,SAAA,GAAY;AAAA,KAC9C;AAAA,EACF,CAAA;AACF","file":"sendWalletTransaction.js","sourcesContent":["import { TransactionRequest, TransactionResponse } from \"ethers\";\n\nimport { extendError } from \"lib/errors\";\nimport { estimateGasLimit } from \"lib/gas/estimateGasLimit\";\nimport { GasPriceData, getGasPrice } from \"lib/gas/gasPrice\";\nimport { iRpc } from \"lib/rpc/types\";\nimport { ISigner } from \"lib/signing/signing\";\n\nimport { TransactionWaiterResult, TxnCallback, TxnEventBuilder } from \"./types\";\n\nexport type WalletTxnCtx = {};\n\nexport type WalletTxnResult = {\n  transactionHash: string;\n  wait: () => Promise<TransactionWaiterResult>;\n};\n\nexport async function sendWalletTransaction({\n  chainId,\n  signer,\n  rpc,\n  to,\n  callData,\n  value,\n  gasLimit,\n  gasPriceData,\n  runSimulation,\n  nonce,\n  callback,\n}: {\n  chainId: number;\n  signer: ISigner;\n  rpc: iRpc;\n  to: string;\n  callData: string;\n  value?: bigint;\n  gasLimit?: bigint | number;\n  gasPriceData?: GasPriceData;\n  nonce?: number | bigint;\n  msg?: string;\n  runSimulation?: () => Promise<void>;\n  callback?: TxnCallback<WalletTxnCtx>;\n}) {\n  const from = signer.address;\n  const eventBuilder = new TxnEventBuilder<WalletTxnCtx>({});\n\n  try {\n    // TODO: move outside somehow\n    const gasLimitPromise = gasLimit\n      ? Promise.resolve(gasLimit)\n      : estimateGasLimit(rpc, {\n          to,\n          from,\n          data: callData,\n          value,\n        }).catch(() => undefined);\n\n    const gasPriceDataPromise = gasPriceData\n      ? Promise.resolve(gasPriceData)\n      : getGasPrice(chainId, rpc!).catch(() => undefined);\n\n    const [gasLimitResult, gasPriceDataResult] = await Promise.all([\n      gasLimitPromise,\n      gasPriceDataPromise,\n      runSimulation?.().then(() => callback?.(eventBuilder.Simulated())),\n    ]);\n\n    callback?.(eventBuilder.Sending());\n\n    const txnData: TransactionRequest = {\n      to,\n      data: callData,\n      value,\n      from,\n      nonce: nonce !== undefined ? Number(nonce) : undefined,\n      gasLimit: gasLimitResult,\n      ...(gasPriceDataResult ?? {}),\n    };\n\n    const res = await signer.sendTransaction(txnData).catch((error) => {\n      throw extendError(error, {\n        errorContext: \"sending\",\n      });\n    });\n\n    callback?.(\n      eventBuilder.Sent({\n        type: \"wallet\",\n        transactionHash: res.hash,\n      })\n    );\n\n    return {\n      transactionHash: res.hash,\n      wait: makeWalletTxnResultWaiter(res.hash, res),\n    };\n  } catch (error: any) {\n    callback?.(eventBuilder.Error(error));\n\n    throw error;\n  }\n}\n\nfunction makeWalletTxnResultWaiter(hash: string, txn: TransactionResponse) {\n  return async () => {\n    const receipt = await txn.wait();\n    return {\n      transactionHash: hash,\n      blockNumber: receipt?.blockNumber,\n      status: receipt?.status === 1 ? \"success\" : \"failed\",\n    };\n  };\n}\n"]}