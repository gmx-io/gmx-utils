{"version":3,"sources":["../../../../../src/lib/gas/gasPrice.ts"],"names":[],"mappings":";;;;;;;AAyBA,eAAsB,WAAA,CACpB,SACA,GAAA,EACuB;AACvB,EAAA,IAAI;AACF,IAAA,IAAI,YAAA,GAAe,gBAAgB,OAA2B,CAAA;AAE9D,IAAA,MAAM,OAAA,GACJ,kBAAA,CAAmB,OAA2B,CAAA,IAAK,EAAA;AAErD,IAAA,MAAM,UAAU,MAAM,SAAA;AAAA,MACpB,MACE,IAAI,kBAAA,CAAmB;AAAA,QACrB;AAAA,OACD,CAAA;AAAA,MACH;AAAA,QACE,KAAA,EAAO,GAAA;AAAA,QACP,UAAA,EAAY,CAAA;AAAA,QACZ,WAAA,EAAa,CAAC,EAAE,KAAA,EAAM,KAAM;AAC1B,UAAA,MAAM,mBAAA,GAAsB,OAAO,OAAA,EAAS,QAAA;AAAA,YAC1C;AAAA,WACF;AAEA,UAAA,IAAI,mBAAA,EAAqB;AACvB,YAAA,iBAAA,CAAkB,EAAE,KAAA,EAAO,6BAAA,EAA+B,CAAA;AAAA,UAC5D;AAEA,UAAA,OAAO,mBAAA;AAAA,QACT;AAAA;AACF,KACF;AAEA,IAAA,MAAM,WAAW,OAAA,CAAQ,QAAA;AAEzB,IAAA,IAAI,iBAAiB,KAAA,CAAA,EAAW;AAC9B,MAAA,IAAI,QAAA,KAAa,KAAA,CAAA,IAAa,QAAA,KAAa,IAAA,EAAM;AAC/C,QAAA,YAAA,GAAe,OAAA,CAAQ,GAAA,CAAI,QAAA,EAAU,YAAY,CAAA;AAAA,MACnD;AAGA,MAAA,MAAM,QAAQ,MAAM,GAAA,CAAI,SAAS,EAAE,QAAA,EAAU,WAAW,CAAA;AACxD,MAAA,IAAI,KAAA,CAAM,aAAA,KAAkB,KAAA,CAAA,IAAa,KAAA,CAAM,kBAAkB,IAAA,EAAM;AACrE,QAAA,MAAM,gBAAgB,KAAA,CAAM,aAAA;AAE5B,QAAA,MAAM,uBAAuB,OAAA,CAAQ,GAAA;AAAA,UACnC,QAAQ,oBAAA,IAAwB,EAAA;AAAA,UAChC,uBAAA,CAAwB,OAA2B,CAAA,IAAK;AAAA,SAC1D;AAGA,QAAA,MAAM,sBAAA,GACJ,gBAAgB,oBAAA,GAAuB,OAAA;AAEzC,QAAA,OAAO;AAAA,UACL,YAAA,EAAc,OAAA,CAAQ,GAAA,CAAI,YAAA,EAAc,sBAAsB,CAAA;AAAA,UAC9D,sBAAsB,oBAAA,GAAuB;AAAA,SAC/C;AAAA,MACF;AAAA,IACF;AAEA,IAAA,IAAI,QAAA,KAAa,IAAA,IAAQ,QAAA,KAAa,KAAA,CAAA,EAAW;AAC/C,MAAA,MAAM,IAAI,MAAM,uBAAuB,CAAA;AAAA,IACzC;AAEA,IAAA,MAAM,SAAA,GACJ,iBAAA,CAAkB,OAA2B,CAAA,IAAK,EAAA;AAEpD,IAAA,MAAM,SAAS,OAAA,CAAQ,MAAA;AAAA,MACrB,QAAA;AAAA,MACA,SAAA;AAAA,MACA;AAAA,KACF;AAEA,IAAA,OAAO;AAAA,MACL,QAAA,EAAU,WAAW,MAAA,GAAS;AAAA,KAChC;AAAA,EACF,SAAS,KAAA,EAAY;AACnB,IAAA,MAAM,YAAY,KAAA,EAAO;AAAA,MACvB,YAAA,EAAc;AAAA,KACf,CAAA;AAAA,EACH;AACF","file":"gasPrice.js","sourcesContent":["import { withRetry } from \"viem\";\n\nimport {\n  ContractsChainId,\n  getGasPriceBuffer,\n  getGasPricePremium,\n  getMaxFeePerGas,\n  getMaxPriorityFeePerGas,\n} from \"configs/chains\";\nimport { bigMath } from \"lib/bigmath\";\nimport { extendError } from \"lib/errors\";\nimport { emitMetricCounter } from \"lib/metrics\";\nimport { BASIS_POINTS_DIVISOR_BIGINT } from \"lib/numbers\";\nimport { iRpc } from \"lib/rpc/types\";\n\nexport type GasPriceData =\n  | {\n      gasPrice: bigint;\n    }\n  // Avalanche\n  | {\n      maxFeePerGas: bigint;\n      maxPriorityFeePerGas: bigint;\n    };\n\nexport async function getGasPrice(\n  chainId: number,\n  rpc: iRpc\n): Promise<GasPriceData> {\n  try {\n    let maxFeePerGas = getMaxFeePerGas(chainId as ContractsChainId);\n\n    const premium: bigint =\n      getGasPricePremium(chainId as ContractsChainId) || 0n;\n\n    const feeData = await withRetry(\n      () =>\n        rpc.estimateFeesPerGas({\n          chainId,\n        }),\n      {\n        delay: 200,\n        retryCount: 2,\n        shouldRetry: ({ error }) => {\n          const isInvalidBlockError = error?.message?.includes(\n            \"invalid value for value.hash\"\n          );\n\n          if (isInvalidBlockError) {\n            emitMetricCounter({ event: \"error.getFeeData.value.hash\" });\n          }\n\n          return isInvalidBlockError;\n        },\n      }\n    );\n\n    const gasPrice = feeData.gasPrice;\n\n    if (maxFeePerGas !== undefined) {\n      if (gasPrice !== undefined && gasPrice !== null) {\n        maxFeePerGas = bigMath.max(gasPrice, maxFeePerGas);\n      }\n\n      // Fetch the latest block to get baseFeePerGas for EIP-1559 fee data\n      const block = await rpc.getBlock({ blockTag: \"pending\" });\n      if (block.baseFeePerGas !== undefined && block.baseFeePerGas !== null) {\n        const baseFeePerGas = block.baseFeePerGas;\n\n        const maxPriorityFeePerGas = bigMath.max(\n          feeData.maxPriorityFeePerGas ?? 0n,\n          getMaxPriorityFeePerGas(chainId as ContractsChainId) || 0n\n        );\n\n        // Calculate maxFeePerGas\n        const calculatedMaxFeePerGas =\n          baseFeePerGas + maxPriorityFeePerGas + premium;\n\n        return {\n          maxFeePerGas: bigMath.max(maxFeePerGas, calculatedMaxFeePerGas),\n          maxPriorityFeePerGas: maxPriorityFeePerGas + premium,\n        };\n      }\n    }\n\n    if (gasPrice === null || gasPrice === undefined) {\n      throw new Error(\"Can't fetch gas price\");\n    }\n\n    const bufferBps: bigint =\n      getGasPriceBuffer(chainId as ContractsChainId) || 0n;\n\n    const buffer = bigMath.mulDiv(\n      gasPrice,\n      bufferBps,\n      BASIS_POINTS_DIVISOR_BIGINT\n    );\n\n    return {\n      gasPrice: gasPrice + buffer + premium,\n    };\n  } catch (error: any) {\n    throw extendError(error, {\n      errorContext: \"gasPrice\",\n    });\n  }\n}\n"]}