{"version":3,"sources":["../../../../../src/domain/pricing/priceImpact.ts"],"names":[],"mappings":"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","file":"priceImpact.js","sourcesContent":["import { TradeFees } from \"domain/fees/types\";\nimport { MarketInfo } from \"domain/markets/types\";\nimport {\n  getOpenInterestForBalance,\n  getTokenPoolType,\n} from \"domain/markets/utils\";\nimport { TokenData } from \"domain/tokens/types\";\nimport {\n  convertToTokenAmount,\n  convertToUsd,\n  getMidPrice,\n} from \"domain/tokens/utils\";\nimport { bigNumberify } from \"domain/tradeHistory/tradeHistory\";\nimport { bigMath } from \"lib/bigmath\";\nimport {\n  applyFactor,\n  expandDecimals,\n  getBasisPoints,\n  roundUpMagnitudeDivision,\n} from \"lib/numbers\";\n\nexport function getPriceImpactByAcceptablePrice(p: {\n  sizeDeltaUsd: bigint;\n  acceptablePrice: bigint;\n  indexPrice: bigint;\n  isLong: boolean;\n  isIncrease: boolean;\n}) {\n  const {\n    sizeDeltaUsd,\n    acceptablePrice,\n    indexPrice: markPrice,\n    isLong,\n    isIncrease,\n  } = p;\n\n  const shouldFlipPriceDiff = isIncrease ? !isLong : isLong;\n\n  const priceDelta =\n    (markPrice - acceptablePrice) * (shouldFlipPriceDiff ? -1n : 1n);\n  const acceptablePriceDeltaBps =\n    markPrice === 0n ? 0n : getBasisPoints(priceDelta, markPrice);\n\n  const priceImpactDeltaUsd =\n    acceptablePrice === 0n ? 0n : (sizeDeltaUsd * priceDelta) / acceptablePrice;\n\n  const priceImpactDeltaAmount =\n    markPrice === 0n ? 0n : priceImpactDeltaUsd / markPrice;\n\n  return {\n    priceImpactDeltaUsd,\n    priceImpactDeltaAmount,\n    priceDelta,\n    acceptablePriceDeltaBps,\n  };\n}\n\nexport function applySwapImpactWithCap(\n  marketInfo: MarketInfo,\n  token: TokenData,\n  priceImpactDeltaUsd: bigint\n) {\n  const tokenPoolType = getTokenPoolType(marketInfo, token.address);\n\n  if (!tokenPoolType) {\n    throw new Error(\n      `Token ${token.address} is not a collateral of the market ${marketInfo.marketTokenAddress}`\n    );\n  }\n\n  const isLongCollateral = tokenPoolType === \"long\";\n  const price =\n    priceImpactDeltaUsd > 0 ? token.prices.maxPrice : token.prices.minPrice;\n\n  let impactDeltaAmount: bigint;\n  let cappedDiffUsd = 0n;\n\n  if (priceImpactDeltaUsd > 0) {\n    // round positive impactAmount down, this will be deducted from the swap impact pool for the user\n    impactDeltaAmount = convertToTokenAmount(\n      priceImpactDeltaUsd,\n      token.decimals,\n      price\n    )!;\n\n    const maxImpactAmount = isLongCollateral\n      ? marketInfo.swapImpactPoolAmountLong\n      : marketInfo.swapImpactPoolAmountShort;\n\n    if (impactDeltaAmount > maxImpactAmount) {\n      cappedDiffUsd = bigMath.mulDiv(\n        impactDeltaAmount - maxImpactAmount,\n        price,\n        expandDecimals(1, token.decimals)\n      );\n      impactDeltaAmount = maxImpactAmount;\n    }\n  } else {\n    // round negative impactAmount up, this will be deducted from the user\n    impactDeltaAmount = roundUpMagnitudeDivision(\n      priceImpactDeltaUsd * expandDecimals(1, token.decimals),\n      price\n    );\n  }\n\n  return { impactDeltaAmount, cappedDiffUsd };\n}\n\nexport function getCappedPositionImpactUsd(\n  marketInfo: MarketInfo,\n  sizeDeltaUsd: bigint,\n  isLong: boolean,\n  isIncrease: boolean,\n  opts: { fallbackToZero?: boolean; shouldCapNegativeImpact?: boolean } = {}\n) {\n  sizeDeltaUsd = isIncrease ? sizeDeltaUsd : sizeDeltaUsd * -1n;\n\n  const { priceImpactDeltaUsd, balanceWasImproved } = getPriceImpactForPosition(\n    marketInfo,\n    sizeDeltaUsd,\n    isLong,\n    opts\n  );\n\n  if (priceImpactDeltaUsd < 0 && !opts.shouldCapNegativeImpact) {\n    return { priceImpactDeltaUsd, balanceWasImproved };\n  }\n\n  const cappedImpactUsd = capPositionImpactUsdByMaxPriceImpactFactor(\n    marketInfo,\n    sizeDeltaUsd,\n    priceImpactDeltaUsd\n  );\n\n  return {\n    priceImpactDeltaUsd: cappedImpactUsd,\n    balanceWasImproved,\n  };\n}\n\nexport function capPositionImpactUsdByMaxImpactPool(\n  marketInfo: MarketInfo,\n  positionImpactDeltaUsd: bigint\n) {\n  if (positionImpactDeltaUsd < 0) {\n    return positionImpactDeltaUsd;\n  }\n\n  const { indexToken } = marketInfo;\n  const impactPoolAmount = marketInfo.positionImpactPoolAmount;\n  const maxPriceImpactUsdBasedOnImpactPool = convertToUsd(\n    impactPoolAmount,\n    indexToken.decimals,\n    indexToken.prices.minPrice\n  )!;\n\n  if (positionImpactDeltaUsd > maxPriceImpactUsdBasedOnImpactPool) {\n    positionImpactDeltaUsd = maxPriceImpactUsdBasedOnImpactPool;\n  }\n\n  return positionImpactDeltaUsd;\n}\n\nexport function capPositionImpactUsdByMaxPriceImpactFactor(\n  marketInfo: MarketInfo,\n  sizeDeltaUsd: bigint,\n  positionImpactDeltaUsd: bigint\n) {\n  const { maxPositiveImpactFactor, maxNegativeImpactFactor } =\n    getMaxPositionImpactFactors(marketInfo);\n\n  const maxPriceImapctFactor =\n    positionImpactDeltaUsd > 0\n      ? maxPositiveImpactFactor\n      : maxNegativeImpactFactor;\n\n  const maxPriceImpactUsdBasedOnMaxPriceImpactFactor = applyFactor(\n    bigMath.abs(sizeDeltaUsd),\n    maxPriceImapctFactor\n  );\n\n  if (\n    bigMath.abs(positionImpactDeltaUsd) >\n    maxPriceImpactUsdBasedOnMaxPriceImpactFactor\n  ) {\n    positionImpactDeltaUsd =\n      maxPriceImpactUsdBasedOnMaxPriceImpactFactor *\n      (positionImpactDeltaUsd > 0 ? 1n : -1n);\n  }\n\n  return positionImpactDeltaUsd;\n}\n\nexport function getMaxPositionImpactFactors(marketInfo: MarketInfo) {\n  let maxPositiveImpactFactor = marketInfo.maxPositionImpactFactorPositive;\n  const maxNegativeImpactFactor = marketInfo.maxPositionImpactFactorNegative;\n\n  if (maxPositiveImpactFactor > maxNegativeImpactFactor) {\n    maxPositiveImpactFactor = maxNegativeImpactFactor;\n  }\n\n  return { maxPositiveImpactFactor, maxNegativeImpactFactor };\n}\n\nexport function getPriceImpactForPosition(\n  marketInfo: MarketInfo,\n  sizeDeltaUsd: bigint,\n  isLong: boolean,\n  opts: { fallbackToZero?: boolean } = {}\n) {\n  const longInterestUsd = getOpenInterestForBalance(marketInfo, true);\n  const shortInterestUsd = getOpenInterestForBalance(marketInfo, false);\n\n  const { currentLongUsd, currentShortUsd, nextLongUsd, nextShortUsd } =\n    getNextOpenInterestParams({\n      currentLongUsd: longInterestUsd,\n      currentShortUsd: shortInterestUsd,\n      usdDelta: sizeDeltaUsd,\n      isLong: isLong!,\n    });\n\n  const { priceImpactDeltaUsd, balanceWasImproved } = getPriceImpactUsd({\n    currentLongUsd,\n    currentShortUsd,\n    nextLongUsd,\n    nextShortUsd,\n    factorPositive: marketInfo.positionImpactFactorPositive,\n    factorNegative: marketInfo.positionImpactFactorNegative,\n    exponentFactorPositive: marketInfo.positionImpactExponentFactorPositive,\n    exponentFactorNegative: marketInfo.positionImpactExponentFactorNegative,\n    fallbackToZero: opts.fallbackToZero,\n  });\n\n  if (priceImpactDeltaUsd > 0) {\n    return {\n      priceImpactDeltaUsd,\n      balanceWasImproved,\n    };\n  }\n\n  if (bigMath.abs(marketInfo.virtualInventoryForPositions) <= 0) {\n    return {\n      priceImpactDeltaUsd,\n      balanceWasImproved,\n    };\n  }\n\n  const virtualInventoryParams = getNextOpenInterestForVirtualInventory({\n    virtualInventory: marketInfo.virtualInventoryForPositions,\n    usdDelta: sizeDeltaUsd,\n    isLong: isLong!,\n  });\n\n  const { priceImpactDeltaUsd: priceImpactUsdForVirtualInventory } =\n    getPriceImpactUsd({\n      currentLongUsd: virtualInventoryParams.currentLongUsd,\n      currentShortUsd: virtualInventoryParams.currentShortUsd,\n      nextLongUsd: virtualInventoryParams.nextLongUsd,\n      nextShortUsd: virtualInventoryParams.nextShortUsd,\n      factorPositive: marketInfo.positionImpactFactorPositive,\n      factorNegative: marketInfo.positionImpactFactorNegative,\n      exponentFactorPositive: marketInfo.positionImpactExponentFactorPositive,\n      exponentFactorNegative: marketInfo.positionImpactExponentFactorNegative,\n      fallbackToZero: opts.fallbackToZero,\n    });\n\n  return {\n    priceImpactDeltaUsd:\n      priceImpactUsdForVirtualInventory < priceImpactDeltaUsd!\n        ? priceImpactUsdForVirtualInventory\n        : priceImpactDeltaUsd!,\n    balanceWasImproved,\n  };\n}\n\nexport function getProportionalPendingImpactValues({\n  sizeInUsd,\n  pendingImpactAmount,\n  sizeDeltaUsd,\n  indexToken,\n}: {\n  sizeInUsd: bigint;\n  pendingImpactAmount: bigint;\n  sizeDeltaUsd: bigint;\n  indexToken: TokenData;\n}) {\n  const proportionalPendingImpactDeltaAmount =\n    sizeDeltaUsd !== 0n && sizeInUsd !== 0n\n      ? bigMath.mulDiv(\n          pendingImpactAmount,\n          sizeDeltaUsd,\n          sizeInUsd,\n          pendingImpactAmount < 0n\n        )\n      : 0n;\n\n  const proportionalPendingImpactDeltaUsd = convertToUsd(\n    proportionalPendingImpactDeltaAmount,\n    indexToken.decimals,\n    proportionalPendingImpactDeltaAmount > 0\n      ? indexToken.prices.minPrice\n      : indexToken.prices.maxPrice\n  )!;\n\n  return {\n    proportionalPendingImpactDeltaAmount,\n    proportionalPendingImpactDeltaUsd,\n  };\n}\n\nexport function getPriceImpactForSwap(\n  marketInfo: MarketInfo,\n  tokenA: TokenData,\n  tokenB: TokenData,\n  usdDeltaTokenA: bigint,\n  usdDeltaTokenB: bigint,\n  opts: { fallbackToZero?: boolean } = {}\n) {\n  const tokenAPoolType = getTokenPoolType(marketInfo, tokenA.address);\n  const tokenBPoolType = getTokenPoolType(marketInfo, tokenB.address);\n\n  if (\n    tokenAPoolType === undefined ||\n    tokenBPoolType === undefined ||\n    (tokenAPoolType === tokenBPoolType && !marketInfo.isSameCollaterals)\n  ) {\n    throw new Error(\n      `Invalid tokens to swap ${marketInfo.marketTokenAddress} ${tokenA.address} ${tokenB.address}`\n    );\n  }\n\n  const [longToken, shortToken] =\n    tokenAPoolType === \"long\" ? [tokenA, tokenB] : [tokenB, tokenA];\n  const [longDeltaUsd, shortDeltaUsd] =\n    tokenAPoolType === \"long\"\n      ? [usdDeltaTokenA, usdDeltaTokenB]\n      : [usdDeltaTokenB, usdDeltaTokenA];\n\n  const { longPoolUsd, shortPoolUsd, nextLongPoolUsd, nextShortPoolUsd } =\n    getNextPoolAmountsParams({\n      longToken,\n      shortToken,\n      longPoolAmount: marketInfo.longPoolAmount,\n      shortPoolAmount: marketInfo.shortPoolAmount,\n      longDeltaUsd,\n      shortDeltaUsd,\n    });\n\n  const { priceImpactDeltaUsd, balanceWasImproved } = getPriceImpactUsd({\n    currentLongUsd: longPoolUsd,\n    currentShortUsd: shortPoolUsd,\n    nextLongUsd: nextLongPoolUsd,\n    nextShortUsd: nextShortPoolUsd,\n    factorPositive: marketInfo.swapImpactFactorPositive,\n    factorNegative: marketInfo.swapImpactFactorNegative,\n    exponentFactorPositive: marketInfo.swapImpactExponentFactor,\n    exponentFactorNegative: marketInfo.swapImpactExponentFactor,\n    fallbackToZero: opts.fallbackToZero,\n  });\n\n  if (priceImpactDeltaUsd > 0) {\n    return {\n      priceImpactDeltaUsd,\n      balanceWasImproved,\n    };\n  }\n\n  const virtualInventoryLong = marketInfo.virtualPoolAmountForLongToken;\n  const virtualInventoryShort = marketInfo.virtualPoolAmountForShortToken;\n\n  if (virtualInventoryLong <= 0 || virtualInventoryShort <= 0) {\n    return {\n      priceImpactDeltaUsd,\n      balanceWasImproved,\n    };\n  }\n\n  const virtualInventoryParams = getNextPoolAmountsParams({\n    longToken,\n    shortToken,\n    longPoolAmount: virtualInventoryLong,\n    shortPoolAmount: virtualInventoryShort,\n    longDeltaUsd,\n    shortDeltaUsd,\n  });\n\n  const { priceImpactDeltaUsd: priceImpactUsdForVirtualInventory } =\n    getPriceImpactUsd({\n      currentLongUsd: virtualInventoryParams.longPoolUsd,\n      currentShortUsd: virtualInventoryParams.shortPoolUsd,\n      nextLongUsd: virtualInventoryParams.nextLongPoolUsd,\n      nextShortUsd: virtualInventoryParams.nextShortPoolUsd,\n      factorPositive: marketInfo.swapImpactFactorPositive,\n      factorNegative: marketInfo.swapImpactFactorNegative,\n      exponentFactorPositive: marketInfo.swapImpactExponentFactor,\n      exponentFactorNegative: marketInfo.swapImpactExponentFactor,\n      fallbackToZero: opts.fallbackToZero,\n    });\n\n  return {\n    priceImpactDeltaUsd:\n      priceImpactUsdForVirtualInventory < priceImpactDeltaUsd!\n        ? priceImpactUsdForVirtualInventory\n        : priceImpactDeltaUsd!,\n    balanceWasImproved,\n  };\n}\n\nfunction getNextOpenInterestForVirtualInventory(p: {\n  virtualInventory: bigint;\n  usdDelta: bigint;\n  isLong: boolean;\n}) {\n  const { virtualInventory, usdDelta, isLong } = p;\n\n  let currentLongUsd = 0n;\n  let currentShortUsd = 0n;\n\n  if (virtualInventory > 0) {\n    currentShortUsd = virtualInventory;\n  } else {\n    currentLongUsd = virtualInventory * -1n;\n  }\n\n  if (usdDelta < 0) {\n    const offset = bigMath.abs(usdDelta);\n    currentLongUsd = currentLongUsd + offset;\n    currentShortUsd = currentShortUsd + offset;\n  }\n\n  return getNextOpenInterestParams({\n    currentLongUsd,\n    currentShortUsd,\n    usdDelta,\n    isLong,\n  });\n}\n\nfunction getNextOpenInterestParams(p: {\n  currentLongUsd: bigint;\n  currentShortUsd: bigint;\n  usdDelta: bigint;\n  isLong: boolean;\n}) {\n  const { currentLongUsd, currentShortUsd, usdDelta, isLong } = p;\n\n  let nextLongUsd = currentLongUsd;\n  let nextShortUsd = currentShortUsd;\n\n  if (isLong) {\n    nextLongUsd = (currentLongUsd ?? 0n) + (usdDelta ?? 0n);\n  } else {\n    nextShortUsd = (currentShortUsd ?? 0n) + (usdDelta ?? 0n);\n  }\n\n  return {\n    currentLongUsd,\n    currentShortUsd,\n    nextLongUsd,\n    nextShortUsd,\n  };\n}\n\nexport function getNextPoolAmountsParams(p: {\n  longToken: TokenData;\n  shortToken: TokenData;\n  longPoolAmount: bigint;\n  shortPoolAmount: bigint;\n  longDeltaUsd: bigint;\n  shortDeltaUsd: bigint;\n}) {\n  const {\n    longToken,\n    shortToken,\n    longPoolAmount,\n    shortPoolAmount,\n    longDeltaUsd,\n    shortDeltaUsd,\n  } = p;\n\n  const longPrice = getMidPrice(longToken.prices);\n  const shortPrice = getMidPrice(shortToken.prices);\n\n  const longPoolUsd = convertToUsd(\n    longPoolAmount,\n    longToken.decimals,\n    longPrice\n  )!;\n  const shortPoolUsd = convertToUsd(\n    shortPoolAmount,\n    shortToken.decimals,\n    shortPrice\n  )!;\n\n  const nextLongPoolUsd = longPoolUsd + longDeltaUsd;\n  const nextShortPoolUsd = shortPoolUsd + shortDeltaUsd;\n\n  return {\n    longPoolUsd,\n    shortPoolUsd,\n    nextLongPoolUsd,\n    nextShortPoolUsd,\n  };\n}\n\n/**\n * @see https://github.com/gmx-io/gmx-synthetics/blob/updates/contracts/pricing/SwapPricingUtils.sol\n */\nexport function getPriceImpactUsd(p: {\n  currentLongUsd: bigint;\n  currentShortUsd: bigint;\n  nextLongUsd: bigint;\n  nextShortUsd: bigint;\n  factorPositive: bigint;\n  factorNegative: bigint;\n  exponentFactorPositive: bigint;\n  exponentFactorNegative: bigint;\n  fallbackToZero?: boolean;\n}) {\n  const { nextLongUsd, nextShortUsd } = p;\n\n  if (nextLongUsd < 0 || nextShortUsd < 0) {\n    if (p.fallbackToZero) {\n      return {\n        priceImpactDeltaUsd: 0n,\n        balanceWasImproved: false,\n      };\n    } else {\n      throw new Error(\"Negative pool amount\");\n    }\n  }\n\n  const currentDiff = bigMath.abs(p.currentLongUsd - p.currentShortUsd);\n  const nextDiff = bigMath.abs(nextLongUsd - nextShortUsd);\n  const isSameSideRebalance =\n    p.currentLongUsd < p.currentShortUsd === nextLongUsd < nextShortUsd;\n  const balanceWasImproved = nextDiff < currentDiff;\n\n  let priceImpactDeltaUsd: bigint;\n\n  if (isSameSideRebalance) {\n    const hasPositiveImpact = nextDiff < currentDiff;\n    const factor = hasPositiveImpact ? p.factorPositive : p.factorNegative;\n    const exponentFactor = hasPositiveImpact\n      ? p.exponentFactorPositive\n      : p.exponentFactorNegative;\n\n    priceImpactDeltaUsd = calculateImpactForSameSideRebalance({\n      currentDiff,\n      nextDiff,\n      hasPositiveImpact,\n      factor,\n      exponentFactor,\n    });\n  } else {\n    priceImpactDeltaUsd = calculateImpactForCrossoverRebalance({\n      currentDiff,\n      nextDiff,\n      factorPositive: p.factorPositive,\n      factorNegative: p.factorNegative,\n      exponentFactorPositive: p.exponentFactorPositive,\n      exponentFactorNegative: p.exponentFactorNegative,\n    });\n  }\n\n  return {\n    priceImpactDeltaUsd,\n    balanceWasImproved,\n  };\n}\n\n/**\n *  @see https://github.com/gmx-io/gmx-synthetics/blob/5fd9991ff2c37ae5f24f03bc9c132730b012ebf2/contracts/pricing/PricingUtils.sol\n */\nexport function calculateImpactForSameSideRebalance(p: {\n  currentDiff: bigint;\n  nextDiff: bigint;\n  hasPositiveImpact: boolean;\n  factor: bigint;\n  exponentFactor: bigint;\n}) {\n  const { currentDiff, nextDiff, hasPositiveImpact, factor, exponentFactor } =\n    p;\n\n  const currentImpact = applyImpactFactor(currentDiff, factor, exponentFactor);\n  const nextImpact = applyImpactFactor(nextDiff, factor, exponentFactor);\n\n  const deltaDiff = bigMath.abs(currentImpact - nextImpact);\n\n  return hasPositiveImpact ? deltaDiff : -deltaDiff;\n}\n\n/**\n *  @see  https://github.com/gmx-io/gmx-synthetics/blob/5fd9991ff2c37ae5f24f03bc9c132730b012ebf2/contracts/pricing/PricingUtils.sol\n */\nexport function calculateImpactForCrossoverRebalance(p: {\n  currentDiff: bigint;\n  nextDiff: bigint;\n  factorPositive: bigint;\n  factorNegative: bigint;\n  exponentFactorPositive: bigint;\n  exponentFactorNegative: bigint;\n}) {\n  const {\n    currentDiff,\n    nextDiff,\n    factorNegative,\n    factorPositive,\n    exponentFactorPositive,\n    exponentFactorNegative,\n  } = p;\n\n  const positiveImpact = applyImpactFactor(\n    currentDiff,\n    factorPositive,\n    exponentFactorPositive\n  );\n  const negativeImpactUsd = applyImpactFactor(\n    nextDiff,\n    factorNegative,\n    exponentFactorNegative\n  );\n\n  const deltaDiffUsd = bigMath.abs(positiveImpact - negativeImpactUsd);\n\n  return positiveImpact > negativeImpactUsd ? deltaDiffUsd : -deltaDiffUsd;\n}\n\nexport function applyImpactFactor(\n  diff: bigint,\n  factor: bigint,\n  exponent: bigint\n) {\n  // Convert diff and exponent to float js numbers\n  const _diff = Number(diff) / 10 ** 30;\n  const _exponent = Number(exponent) / 10 ** 30;\n\n  // Pow and convert back to BigInt with 30 decimals\n  let result = bigNumberify(BigInt(Math.round(_diff ** _exponent * 10 ** 30)))!;\n\n  result = (result * factor) / expandDecimals(1, 30);\n\n  return result;\n}\n\nexport function getCappedPriceImpactPercentageFromFees({\n  fees,\n  isSwap,\n}: {\n  fees: TradeFees | undefined;\n  isSwap: boolean;\n}): bigint | undefined {\n  if (isSwap) {\n    return fees?.swapPriceImpact?.precisePercentage ?? 0n;\n  }\n\n  return fees?.positionNetPriceImpact?.precisePercentage ?? 0n;\n}\n"]}