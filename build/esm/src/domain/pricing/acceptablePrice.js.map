{"version":3,"sources":["../../../../../src/domain/pricing/acceptablePrice.ts"],"names":[],"mappings":"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","file":"acceptablePrice.js","sourcesContent":["import { DEFAULT_ACCEPTABLE_PRICE_IMPACT_BUFFER } from \"configs/factors\";\nimport {\n  getCappedPositionImpactUsd,\n  getPriceImpactByAcceptablePrice,\n} from \"domain/executionFee\";\nimport { MarketInfo } from \"domain/markets/types\";\nimport { convertToTokenAmount } from \"domain/tokens/utils\";\nimport { bigMath } from \"lib/bigmath\";\nimport { BASIS_POINTS_DIVISOR_BIGINT } from \"lib/numbers\";\nimport {\n  expandDecimals,\n  getBasisPoints,\n  roundUpMagnitudeDivision,\n} from \"lib/numbers\";\n\nimport { getShouldUseMaxPrice } from \"./utils\";\n\nexport function getAcceptablePriceInfo(p: {\n  marketInfo: MarketInfo;\n  isIncrease: boolean;\n  isLimit: boolean;\n  isLong: boolean;\n  indexPrice: bigint;\n  sizeDeltaUsd: bigint;\n  maxNegativePriceImpactBps?: bigint;\n}) {\n  const {\n    marketInfo,\n    isIncrease,\n    isLong,\n    indexPrice,\n    sizeDeltaUsd,\n    maxNegativePriceImpactBps,\n  } = p;\n  const { indexToken } = marketInfo;\n\n  const values = {\n    acceptablePrice: 0n,\n    acceptablePriceDeltaBps: 0n,\n    priceImpactDeltaAmount: 0n,\n    priceImpactDeltaUsd: 0n,\n    priceImpactDiffUsd: 0n,\n    balanceWasImproved: false,\n  };\n\n  if (sizeDeltaUsd <= 0 || indexPrice == 0n) {\n    return values;\n  }\n\n  const shouldFlipPriceImpact = getShouldUseMaxPrice(p.isIncrease, p.isLong);\n\n  // For Limit / Trigger orders\n  if (\n    maxNegativePriceImpactBps !== undefined &&\n    maxNegativePriceImpactBps > 0\n  ) {\n    let priceDelta = bigMath.mulDiv(\n      indexPrice,\n      maxNegativePriceImpactBps,\n      BASIS_POINTS_DIVISOR_BIGINT\n    );\n    priceDelta = shouldFlipPriceImpact ? priceDelta * -1n : priceDelta;\n\n    values.acceptablePrice = indexPrice - priceDelta;\n    values.acceptablePriceDeltaBps = maxNegativePriceImpactBps * -1n;\n\n    const priceImpact = getPriceImpactByAcceptablePrice({\n      sizeDeltaUsd,\n      acceptablePrice: values.acceptablePrice,\n      indexPrice,\n      isLong,\n      isIncrease,\n    });\n\n    values.priceImpactDeltaUsd = priceImpact.priceImpactDeltaUsd;\n    values.priceImpactDeltaAmount = priceImpact.priceImpactDeltaAmount;\n\n    return values;\n  }\n\n  const { priceImpactDeltaUsd, balanceWasImproved } =\n    getCappedPositionImpactUsd(marketInfo, sizeDeltaUsd, isLong, isIncrease, {\n      fallbackToZero: !isIncrease,\n      shouldCapNegativeImpact: false,\n    });\n\n  /**\n   * We display this value as price impact on action (increase or decrease)\n   * But for acceptable price calculation uncapped price impact is used\n   * Also on decrease action we calculate totalImpactUsd which will be deducted from the collateral\n   */\n  values.priceImpactDeltaUsd = priceImpactDeltaUsd;\n  values.balanceWasImproved = balanceWasImproved;\n\n  if (values.priceImpactDeltaUsd > 0) {\n    values.priceImpactDeltaAmount = convertToTokenAmount(\n      values.priceImpactDeltaUsd,\n      indexToken.decimals,\n      indexToken.prices.maxPrice\n    )!;\n  } else {\n    values.priceImpactDeltaAmount = roundUpMagnitudeDivision(\n      values.priceImpactDeltaUsd * expandDecimals(1, indexToken.decimals),\n      indexToken.prices.minPrice\n    );\n  }\n\n  // Use uncapped price impact for the acceptable price calculation\n  const { priceImpactDeltaUsd: priceImpactDeltaUsdForAcceptablePrice } =\n    getCappedPositionImpactUsd(marketInfo, sizeDeltaUsd, isLong, isIncrease, {\n      fallbackToZero: !isIncrease,\n      shouldCapNegativeImpact: false,\n    });\n\n  const acceptablePriceValues = getAcceptablePriceByPriceImpact({\n    isIncrease,\n    isLong,\n    indexPrice,\n    sizeDeltaUsd,\n    priceImpactDeltaUsd: priceImpactDeltaUsdForAcceptablePrice,\n  });\n\n  values.acceptablePrice = acceptablePriceValues.acceptablePrice;\n  values.acceptablePriceDeltaBps =\n    acceptablePriceValues.acceptablePriceDeltaBps;\n\n  return values;\n}\n\nexport function getAcceptablePriceByPriceImpact(p: {\n  isIncrease: boolean;\n  isLong: boolean;\n  indexPrice: bigint;\n  sizeDeltaUsd: bigint;\n  priceImpactDeltaUsd: bigint;\n}) {\n  const { indexPrice, sizeDeltaUsd, priceImpactDeltaUsd } = p;\n\n  if (sizeDeltaUsd <= 0 || indexPrice == 0n) {\n    return {\n      acceptablePrice: indexPrice,\n      acceptablePriceDeltaBps: 0n,\n      priceDelta: 0n,\n    };\n  }\n\n  const shouldFlipPriceImpact = getShouldUseMaxPrice(p.isIncrease, p.isLong);\n\n  const priceImpactForPriceAdjustment = shouldFlipPriceImpact\n    ? priceImpactDeltaUsd * -1n\n    : priceImpactDeltaUsd;\n  const acceptablePrice = bigMath.mulDiv(\n    indexPrice,\n    sizeDeltaUsd + priceImpactForPriceAdjustment,\n    sizeDeltaUsd\n  );\n\n  const priceDelta =\n    (indexPrice - acceptablePrice) * (shouldFlipPriceImpact ? 1n : -1n);\n  const acceptablePriceDeltaBps = getBasisPoints(priceDelta, p.indexPrice);\n\n  return {\n    acceptablePrice,\n    acceptablePriceDeltaBps,\n    priceDelta,\n  };\n}\n\nexport function getDefaultAcceptablePriceImpactBps(p: {\n  isIncrease: boolean;\n  isLong: boolean;\n  indexPrice: bigint;\n  sizeDeltaUsd: bigint;\n  priceImpactDeltaUsd: bigint;\n  acceptablePriceImapctBuffer?: number;\n}) {\n  const {\n    indexPrice,\n    sizeDeltaUsd,\n    priceImpactDeltaUsd,\n    acceptablePriceImapctBuffer = DEFAULT_ACCEPTABLE_PRICE_IMPACT_BUFFER,\n  } = p;\n\n  if (priceImpactDeltaUsd > 0) {\n    return BigInt(acceptablePriceImapctBuffer);\n  }\n\n  const baseAcceptablePriceValues = getAcceptablePriceByPriceImpact({\n    isIncrease: p.isIncrease,\n    isLong: p.isLong,\n    indexPrice,\n    sizeDeltaUsd,\n    priceImpactDeltaUsd,\n  });\n\n  if (baseAcceptablePriceValues.acceptablePriceDeltaBps < 0) {\n    return (\n      bigMath.abs(baseAcceptablePriceValues.acceptablePriceDeltaBps) +\n      BigInt(acceptablePriceImapctBuffer)\n    );\n  }\n\n  return BigInt(acceptablePriceImapctBuffer);\n}\n\nexport function getNextPositionExecutionPrice(p: {\n  triggerPrice: bigint;\n  priceImpactUsd: bigint;\n  sizeDeltaUsd: bigint;\n  isLong: boolean;\n  isIncrease: boolean;\n}): bigint | null {\n  if (p.sizeDeltaUsd == 0n) {\n    return null;\n  }\n\n  const adjustedPriceImpactUsd = p.isIncrease\n    ? p.isLong\n      ? -p.priceImpactUsd\n      : p.priceImpactUsd\n    : p.isLong\n    ? p.priceImpactUsd\n    : -p.priceImpactUsd;\n\n  const adjustment = bigMath.mulDiv(\n    p.triggerPrice,\n    adjustedPriceImpactUsd,\n    p.sizeDeltaUsd\n  );\n\n  return p.triggerPrice + adjustment;\n}\n"]}