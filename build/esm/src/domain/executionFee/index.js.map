{"version":3,"sources":["../../../../../src/domain/executionFee/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import { HIGH_PRICE_IMPACT_BPS } from \"configs/factors\";\nimport { FeeItem } from \"domain/fees/types\";\nimport { MarketInfo } from \"domain/markets/types\";\nimport { getOpenInterestForBalance } from \"domain/markets/utils\";\nimport { SwapStats } from \"domain/swap/types\";\nimport { bigMath } from \"lib/bigmath\";\nimport { applyFactor, getBasisPoints, PRECISION } from \"lib/numbers\";\n\nexport * from \"./estimateOraclePriceCount\";\nexport * from \"./executionFee\";\nexport * from \"domain/pricing/priceImpact\";\n\nexport function getSwapFee(\n  marketInfo: MarketInfo,\n  swapAmount: bigint,\n  balanceWasImproved: boolean,\n  isAtomicSwap: boolean\n) {\n  let factor: bigint;\n\n  if (isAtomicSwap) {\n    factor = marketInfo.atomicSwapFeeFactor;\n  } else {\n    factor = balanceWasImproved\n      ? marketInfo.swapFeeFactorForBalanceWasImproved\n      : marketInfo.swapFeeFactorForBalanceWasNotImproved;\n  }\n\n  return applyFactor(swapAmount, factor);\n}\n\nexport function getPositionFee(\n  marketInfo: MarketInfo,\n  sizeDeltaUsd: bigint,\n  balanceWasImproved: boolean,\n  referralInfo:\n    | { totalRebateFactor: bigint; discountFactor: bigint }\n    | undefined,\n  uiFeeFactor?: bigint\n) {\n  const factor = balanceWasImproved\n    ? marketInfo.positionFeeFactorForBalanceWasImproved\n    : marketInfo.positionFeeFactorForBalanceWasNotImproved;\n\n  let positionFeeUsd = applyFactor(sizeDeltaUsd, factor);\n  const uiFeeUsd = applyFactor(sizeDeltaUsd, uiFeeFactor ?? 0n);\n\n  if (!referralInfo) {\n    return { positionFeeUsd, discountUsd: 0n, totalRebateUsd: 0n };\n  }\n\n  const totalRebateUsd = applyFactor(\n    positionFeeUsd,\n    referralInfo.totalRebateFactor\n  );\n  const discountUsd = applyFactor(totalRebateUsd, referralInfo.discountFactor);\n\n  positionFeeUsd = positionFeeUsd - discountUsd;\n\n  return {\n    positionFeeUsd,\n    discountUsd,\n    totalRebateUsd,\n    uiFeeUsd,\n  };\n}\n\nexport function getFundingFactorPerPeriod(\n  marketInfo: MarketInfo,\n  isLong: boolean,\n  periodInSeconds: number\n) {\n  const { fundingFactorPerSecond, longsPayShorts } = marketInfo;\n\n  const longInterestUsd = getOpenInterestForBalance(marketInfo, true);\n  const shortInterestUsd = getOpenInterestForBalance(marketInfo, false);\n\n  const payingInterestUsd = longsPayShorts ? longInterestUsd : shortInterestUsd;\n  const receivingInterestUsd = longsPayShorts\n    ? shortInterestUsd\n    : longInterestUsd;\n\n  const fundingForPayingSide = fundingFactorPerSecond;\n  let fundingForReceivingSide = 0n;\n  if (receivingInterestUsd !== 0n) {\n    fundingForReceivingSide = bigMath.mulDiv(\n      fundingForPayingSide,\n      payingInterestUsd,\n      receivingInterestUsd\n    );\n  }\n\n  if ((longsPayShorts && isLong) || (!longsPayShorts && !isLong)) {\n    // paying side\n    return fundingForPayingSide * BigInt(periodInSeconds) * -1n;\n  } else {\n    // receiving side\n    return fundingForReceivingSide * BigInt(periodInSeconds);\n  }\n}\n\nexport function getFundingFeeRateUsd(\n  marketInfo: MarketInfo,\n  isLong: boolean,\n  sizeInUsd: bigint,\n  periodInSeconds: number\n) {\n  const factor = getFundingFactorPerPeriod(marketInfo, isLong, periodInSeconds);\n\n  return applyFactor(sizeInUsd, factor);\n}\n\nexport function getBorrowingFactorPerPeriod(\n  marketInfo: MarketInfo,\n  isLong: boolean,\n  periodInSeconds: number\n) {\n  const factorPerSecond = isLong\n    ? marketInfo.borrowingFactorPerSecondForLongs\n    : marketInfo.borrowingFactorPerSecondForShorts;\n\n  return factorPerSecond * BigInt(periodInSeconds || 1);\n}\n\nexport function getBorrowingFeeRateUsd(\n  marketInfo: MarketInfo,\n  isLong: boolean,\n  sizeInUsd: bigint,\n  periodInSeconds: number\n) {\n  const factor = getBorrowingFactorPerPeriod(\n    marketInfo,\n    isLong,\n    periodInSeconds\n  );\n\n  return applyFactor(sizeInUsd, factor);\n}\n\nexport function getIsHighPriceImpact(\n  positionPriceImpact?: FeeItem,\n  swapPriceImpact?: FeeItem\n) {\n  const totalPriceImpact = getTotalFeeItem([\n    positionPriceImpact,\n    swapPriceImpact,\n  ]);\n  return (\n    totalPriceImpact.deltaUsd < 0 &&\n    bigMath.abs(totalPriceImpact.bps) >= HIGH_PRICE_IMPACT_BPS\n  );\n}\n\nexport function getFeeItem(\n  feeDeltaUsd?: bigint,\n  basis?: bigint,\n  opts: { shouldRoundUp?: boolean } = {}\n): FeeItem | undefined {\n  const { shouldRoundUp = false } = opts;\n  if (feeDeltaUsd === undefined) return undefined;\n\n  return {\n    deltaUsd: feeDeltaUsd,\n    bps:\n      basis !== undefined && basis > 0\n        ? getBasisPoints(feeDeltaUsd, basis, shouldRoundUp)\n        : 0n,\n    precisePercentage:\n      basis !== undefined && basis > 0\n        ? bigMath.mulDiv(feeDeltaUsd, PRECISION, basis)\n        : 0n,\n  };\n}\n\nexport function getTotalFeeItem(feeItems: (FeeItem | undefined)[]): FeeItem {\n  const totalFeeItem: FeeItem = {\n    deltaUsd: 0n,\n    bps: 0n,\n    precisePercentage: 0n,\n  };\n\n  (feeItems.filter(Boolean) as FeeItem[]).forEach((feeItem) => {\n    totalFeeItem.deltaUsd = totalFeeItem.deltaUsd + feeItem.deltaUsd;\n    totalFeeItem.bps = totalFeeItem.bps + feeItem.bps;\n    totalFeeItem.precisePercentage =\n      totalFeeItem.precisePercentage + feeItem.precisePercentage;\n  });\n\n  return totalFeeItem;\n}\n\nexport function getTotalSwapVolumeFromSwapStats(swapSteps?: SwapStats[]) {\n  if (!swapSteps) return 0n;\n\n  return swapSteps.reduce((acc, curr) => {\n    return acc + curr.usdIn;\n  }, 0n);\n}\n"]}