{"version":3,"sources":["../../../../../../src/domain/fees/rebates/utils.ts"],"names":[],"mappings":";;;;AAYO,SAAS,mBAAA,CACd,gBACA,kBAAA,EACmB;AACnB,EAAA,IAAI,CAAC,kBAAA,EAAoB;AACvB,IAAA,OAAO;AAAA,MACL,gCAAgC,EAAC;AAAA,MACjC,kCAAkC;AAAC,KACrC;AAAA,EACF;AAEA,EAAA,MAAM,GAAA,GAAyB;AAAA,IAC7B,gCAAgC,EAAC;AAAA,IACjC,kCAAkC;AAAC,GACrC;AAEA,EAAA,cAAA,EAAgB,OAAA,CAAQ,CAAC,aAAA,KAAkB;AACzC,IAAA,MAAM,YAAA,GAAe,MAAA,CAAO,aAAA,CAAc,YAAY,CAAA;AACtD,IAAA,MAAM,eAAA,GAAkB,MAAA,CAAO,aAAA,CAAc,eAAe,CAAA;AAC5D,IAAA,MAAM,OAAA,GAAU,MAAA,CAAO,aAAA,CAAc,OAAO,CAAA;AAC5C,IAAA,MAAM,KAAA,GAAQ,MAAA,CAAO,aAAA,CAAc,KAAK,CAAA;AAExC,IAAA,IAAI,MAAA,GAAS,MAAA,CAAO,aAAA,CAAc,MAAM,CAAA;AAExC,IAAA,IAAI,eAAe,MAAA,EAAQ;AACzB,MAAA,MAAA,GAAS,YAAA;AAAA,IACX;AAEA,IAAA,MAAM,WACJ,MAAA,CAAO,YAAA,EAAc,CAAA,GACrB,UAAU,kBAAA,CAAmB,8BAAA;AAE/B,IAAA,IACE,WAAW,EAAA,IACX,eAAA,KAAoB,EAAA,IACpB,QAAA,GAAW,mBAAmB,wBAAA,EAC9B;AACA,MAAA,MAAA,GAAS,SAAA;AAAA,IACX;AAEA,IAAA,IAAI,SAAS,eAAA,EAAiB;AAC5B,MAAA,MAAA,IAAU,eAAA;AAAA,IACZ,CAAA,MAAO;AACL,MAAA,MAAA,GAAS,EAAA;AAAA,IACX;AAEA,IAAA,IAAI,aAAA,GAAiB,KAAA,GAAQ,MAAA,GAAU,cAAA,CAAe,GAAG,EAAE,CAAA;AAE3D,IAAA,MAAM,UAAA,GAA6B;AAAA,MACjC,MAAA;AAAA,MACA,KAAA;AAAA,MACA,aAAA;AAAA,MACA,OAAA,EAAS,aAAA,CAAc,OAAA,CAAQ,QAAA,EAAS;AAAA,MACxC,aAAA,EAAe,UAAA,CAAW,aAAA,CAAc,aAAa,CAAA;AAAA,MACrD,YAAA,EAAc,UAAA,CAAW,aAAA,CAAc,YAAY,CAAA;AAAA,MACnD,eAAA;AAAA,MACA,IAAI,aAAA,CAAc;AAAA,KACpB;AAEA,IAAA,IAAI,MAAA,GAAS,EAAA,IAAM,aAAA,KAAkB,EAAA,EAAI;AACvC,MAAA;AAAA,IACF;AAEA,IAAA,IAAI,UAAA,CAAW,WAAW,EAAA,EAAI;AAC5B,MAAA,GAAA,CAAI,8BAAA,CAA+B,KAAK,UAAU,CAAA;AAAA,IACpD,CAAA,MAAO;AACL,MAAA,GAAA,CAAI,gCAAA,CAAiC,KAAK,UAAU,CAAA;AAAA,IACtD;AAAA,EACF,CAAC,CAAA;AAED,EAAA,OAAO,GAAA;AACT","file":"utils.js","sourcesContent":["import { getAddress } from \"viem\";\n\nimport { expandDecimals, PRECISION } from \"lib/numbers\";\nimport { nowInSeconds } from \"lib/time\";\n\nimport type {\n  ClaimableCollateralRaw,\n  PositionsConstants,\n  RebateInfoItem,\n  RebatesInfoResult,\n} from \"./types\";\n\nexport function calculateRebateInfo(\n  rawRebatesData: ClaimableCollateralRaw[] | undefined,\n  positionsConstants: PositionsConstants | undefined\n): RebatesInfoResult {\n  if (!positionsConstants) {\n    return {\n      accruedPositionPriceImpactFees: [],\n      claimablePositionPriceImpactFees: [],\n    };\n  }\n\n  const res: RebatesInfoResult = {\n    accruedPositionPriceImpactFees: [],\n    claimablePositionPriceImpactFees: [],\n  };\n\n  rawRebatesData?.forEach((rawRebateInfo) => {\n    const factorByTime = BigInt(rawRebateInfo.factorByTime);\n    const reductionFactor = BigInt(rawRebateInfo.reductionFactor);\n    const timeKey = BigInt(rawRebateInfo.timeKey);\n    const value = BigInt(rawRebateInfo.value);\n\n    let factor = BigInt(rawRebateInfo.factor);\n\n    if (factorByTime > factor) {\n      factor = factorByTime;\n    }\n\n    const timeDiff =\n      BigInt(nowInSeconds()) -\n      timeKey * positionsConstants.claimableCollateralTimeDivisor;\n\n    if (\n      factor === 0n &&\n      reductionFactor === 0n &&\n      timeDiff > positionsConstants.claimableCollateralDelay\n    ) {\n      factor = PRECISION;\n    }\n\n    if (factor > reductionFactor) {\n      factor -= reductionFactor;\n    } else {\n      factor = 0n;\n    }\n\n    let valueByFactor = (value * factor) / expandDecimals(1, 30);\n\n    const rebateInfo: RebateInfoItem = {\n      factor,\n      value,\n      valueByFactor,\n      timeKey: rawRebateInfo.timeKey.toString(),\n      marketAddress: getAddress(rawRebateInfo.marketAddress),\n      tokenAddress: getAddress(rawRebateInfo.tokenAddress),\n      reductionFactor,\n      id: rawRebateInfo.id,\n    };\n\n    if (factor > 0n && valueByFactor === 0n) {\n      return;\n    }\n\n    if (rebateInfo.factor === 0n) {\n      res.accruedPositionPriceImpactFees.push(rebateInfo);\n    } else {\n      res.claimablePositionPriceImpactFees.push(rebateInfo);\n    }\n  });\n\n  return res;\n}\n"]}