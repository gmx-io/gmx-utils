{"version":3,"sources":["../../../../../src/domain/decrease/decrease.ts"],"names":["positionFeeInfo","totalFeesUsd"],"mappings":"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","file":"decrease.js","sourcesContent":["import { DEFAULT_ACCEPTABLE_PRICE_IMPACT_BUFFER } from \"configs/factors\";\nimport { DecreasePositionAmounts } from \"domain/decrease/types\";\nimport { getPositionFee } from \"domain/executionFee\";\nimport { MarketInfo } from \"domain/markets/types\";\nimport { OrderType } from \"domain/orders/types\";\nimport { NextPositionValues } from \"domain/positions/types\";\nimport { PositionInfo, PositionInfoLoaded } from \"domain/positions/types\";\nimport {\n  getLeverage,\n  getLiquidationPrice,\n  getMinCollateralFactorForPosition,\n  getNetPriceImpactDeltaUsdForDecrease,\n  getPositionPnlUsd,\n} from \"domain/positions/utils\";\nimport {\n  getAcceptablePriceInfo,\n  getDefaultAcceptablePriceImpactBps,\n} from \"domain/pricing/acceptablePrice\";\nimport { getMarkPrice, getOrderThresholdType } from \"domain/pricing/utils\";\nimport { UserReferralInfo } from \"domain/referrals/types\";\nimport { getSwapStats } from \"domain/swap/swapStats\";\nimport { TokenData } from \"domain/tokens/types\";\nimport {\n  convertToTokenAmount,\n  convertToUsd,\n  getIsEquivalentTokens,\n} from \"domain/tokens/utils\";\nimport { bigMath } from \"lib/bigmath\";\nimport {\n  applyFactor,\n  BASIS_POINTS_DIVISOR_BIGINT,\n  expandDecimals,\n  getBasisPoints,\n  roundUpDivision,\n  USD_DECIMALS,\n  MaxUint256,\n} from \"lib/numbers\";\n\nimport { DecreasePositionSwapType } from \"./types\";\n\nexport function getDecreasePositionAmounts(p: {\n  marketInfo: MarketInfo;\n  collateralToken: TokenData;\n  isLong: boolean;\n  position: PositionInfoLoaded | undefined;\n  closeSizeUsd: bigint;\n  keepLeverage: boolean;\n  triggerPrice?: bigint;\n  fixedAcceptablePriceImpactBps?: bigint;\n  acceptablePriceImpactBuffer?: number;\n  userReferralInfo: UserReferralInfo | undefined;\n  minCollateralUsd: bigint;\n  minPositionSizeUsd: bigint;\n  uiFeeFactor: bigint;\n  isLimit?: boolean;\n  limitPrice?: bigint;\n  triggerOrderType?: DecreasePositionAmounts[\"triggerOrderType\"];\n  isSetAcceptablePriceImpactEnabled: boolean;\n\n  receiveToken?: TokenData;\n}) {\n  const {\n    marketInfo,\n    collateralToken,\n    isLong,\n    position,\n    closeSizeUsd,\n    keepLeverage,\n    triggerPrice,\n    fixedAcceptablePriceImpactBps,\n    acceptablePriceImpactBuffer,\n    userReferralInfo,\n    minCollateralUsd,\n    minPositionSizeUsd,\n    uiFeeFactor,\n    triggerOrderType: orderType,\n    receiveToken: receiveTokenArg,\n    isSetAcceptablePriceImpactEnabled,\n  } = p;\n\n  const { indexToken } = marketInfo;\n  const receiveToken = receiveTokenArg ?? collateralToken;\n\n  const values: DecreasePositionAmounts = {\n    isFullClose: false,\n    sizeDeltaUsd: 0n,\n    sizeDeltaInTokens: 0n,\n    collateralDeltaUsd: 0n,\n    collateralDeltaAmount: 0n,\n\n    indexPrice: 0n,\n    collateralPrice: 0n,\n    triggerPrice: 0n,\n    acceptablePrice: 0n,\n\n    proportionalPendingImpactDeltaUsd: 0n,\n    closePriceImpactDeltaUsd: 0n,\n    totalPendingImpactDeltaUsd: 0n,\n    priceImpactDiffUsd: 0n,\n    balanceWasImproved: false,\n    acceptablePriceDeltaBps: 0n,\n    recommendedAcceptablePriceDeltaBps: 0n,\n\n    estimatedPnl: 0n,\n    estimatedPnlPercentage: 0n,\n    realizedPnl: 0n,\n    realizedPnlPercentage: 0n,\n\n    positionFeeUsd: 0n,\n    uiFeeUsd: 0n,\n    swapUiFeeUsd: 0n,\n    borrowingFeeUsd: 0n,\n    fundingFeeUsd: 0n,\n    feeDiscountUsd: 0n,\n    swapProfitFeeUsd: 0n,\n    payedOutputUsd: 0n,\n    payedRemainingCollateralUsd: 0n,\n    payedRemainingCollateralAmount: 0n,\n\n    receiveTokenAmount: 0n,\n    receiveUsd: 0n,\n\n    triggerOrderType: orderType,\n    triggerThresholdType: undefined,\n    decreaseSwapType: DecreasePositionSwapType.NoSwap,\n  };\n\n  const pnlToken = isLong ? marketInfo.longToken : marketInfo.shortToken;\n\n  values.decreaseSwapType = getDecreaseSwapType(\n    pnlToken,\n    collateralToken,\n    receiveToken\n  );\n\n  const markPrice = getMarkPrice({\n    prices: indexToken.prices,\n    isIncrease: false,\n    isLong,\n  });\n  const isTrigger = orderType !== undefined;\n\n  if (orderType) {\n    values.triggerPrice = triggerPrice;\n    values.indexPrice = triggerPrice ?? markPrice;\n\n    values.collateralPrice = getIsEquivalentTokens(indexToken, collateralToken)\n      ? triggerPrice ?? markPrice\n      : collateralToken.prices.minPrice;\n\n    values.triggerThresholdType = getOrderThresholdType(orderType, isLong);\n  } else {\n    values.indexPrice = markPrice;\n    values.collateralPrice = collateralToken.prices.minPrice;\n  }\n\n  if (closeSizeUsd <= 0) {\n    return values;\n  }\n\n  values.sizeDeltaUsd = closeSizeUsd;\n\n  if (!position || position.sizeInUsd <= 0 || position.sizeInTokens <= 0) {\n    applyAcceptablePrice({\n      position,\n      marketInfo,\n      isLong,\n      isTrigger,\n      fixedAcceptablePriceImpactBps,\n      acceptablePriceImpactBuffer,\n      values,\n      isSetAcceptablePriceImpactEnabled,\n    });\n\n    const positionFeeInfo = getPositionFee(\n      marketInfo,\n      values.sizeDeltaUsd,\n      values.balanceWasImproved,\n      userReferralInfo\n    );\n\n    values.positionFeeUsd = positionFeeInfo.positionFeeUsd;\n    values.feeDiscountUsd = positionFeeInfo.discountUsd;\n    values.uiFeeUsd = applyFactor(values.sizeDeltaUsd, uiFeeFactor);\n\n    const totalFeesUsd = getTotalFeesUsdForDecrease({\n      positionFeeUsd: values.positionFeeUsd,\n      borrowingFeeUsd: 0n,\n      fundingFeeUsd: 0n,\n      swapProfitFeeUsd: 0n,\n      swapUiFeeUsd: 0n,\n      uiFeeUsd: values.uiFeeUsd,\n      pnlUsd: 0n,\n      totalPendingImpactDeltaUsd: values.totalPendingImpactDeltaUsd,\n    });\n\n    values.payedOutputUsd = totalFeesUsd;\n\n    return values;\n  }\n\n  const estimatedCollateralUsd = convertToUsd(\n    position.collateralAmount,\n    collateralToken.decimals,\n    values.collateralPrice\n  )!;\n\n  let estimatedCollateralDeltaUsd = 0n;\n\n  if (keepLeverage) {\n    estimatedCollateralDeltaUsd = bigMath.mulDiv(\n      values.sizeDeltaUsd,\n      estimatedCollateralUsd,\n      position.sizeInUsd\n    );\n  }\n\n  values.isFullClose = getIsFullClose({\n    position,\n    sizeDeltaUsd: values.sizeDeltaUsd,\n    indexPrice: values.indexPrice,\n    remainingCollateralUsd:\n      estimatedCollateralUsd - estimatedCollateralDeltaUsd,\n    minCollateralUsd,\n    minPositionSizeUsd,\n  });\n\n  if (values.isFullClose) {\n    values.sizeDeltaUsd = position.sizeInUsd;\n    values.sizeDeltaInTokens = position.sizeInTokens;\n  } else {\n    if (position.isLong) {\n      values.sizeDeltaInTokens = roundUpDivision(\n        position.sizeInTokens * values.sizeDeltaUsd,\n        position.sizeInUsd\n      );\n    } else {\n      values.sizeDeltaInTokens = bigMath.mulDiv(\n        position.sizeInTokens,\n        values.sizeDeltaUsd,\n        position.sizeInUsd\n      );\n    }\n  }\n\n  // PNL\n  values.estimatedPnl = getPositionPnlUsd({\n    marketInfo,\n    sizeInUsd: position.sizeInUsd,\n    sizeInTokens: position.sizeInTokens,\n    markPrice: values.indexPrice,\n    isLong,\n  });\n\n  values.realizedPnl = bigMath.mulDiv(\n    values.estimatedPnl,\n    values.sizeDeltaInTokens,\n    position.sizeInTokens\n  );\n  values.realizedPnlPercentage =\n    estimatedCollateralUsd !== 0n\n      ? getBasisPoints(values.realizedPnl, estimatedCollateralUsd)\n      : 0n;\n  values.estimatedPnlPercentage =\n    estimatedCollateralUsd !== 0n\n      ? getBasisPoints(values.estimatedPnl, estimatedCollateralUsd)\n      : 0n;\n\n  applyAcceptablePrice({\n    position,\n    marketInfo,\n    isLong,\n    isTrigger,\n    fixedAcceptablePriceImpactBps,\n    acceptablePriceImpactBuffer,\n    values,\n    isSetAcceptablePriceImpactEnabled,\n  });\n\n  // Profit\n  let profitUsd = 0n;\n  if (values.realizedPnl > 0) {\n    profitUsd = profitUsd + values.realizedPnl;\n  }\n  if (values.totalPendingImpactDeltaUsd > 0) {\n    profitUsd = profitUsd + values.totalPendingImpactDeltaUsd;\n  }\n  const profitAmount = convertToTokenAmount(\n    profitUsd,\n    collateralToken.decimals,\n    values.collateralPrice\n  )!;\n\n  // Fees\n  const positionFeeInfo = getPositionFee(\n    marketInfo,\n    values.sizeDeltaUsd,\n    values.balanceWasImproved,\n    userReferralInfo\n  );\n  const estimatedPositionFeeCost = estimateCollateralCost(\n    positionFeeInfo.positionFeeUsd,\n    collateralToken,\n    values.collateralPrice\n  );\n  const estimatedDiscountCost = estimateCollateralCost(\n    positionFeeInfo.discountUsd,\n    collateralToken,\n    values.collateralPrice\n  );\n\n  values.positionFeeUsd = estimatedPositionFeeCost.usd;\n  values.feeDiscountUsd = estimatedDiscountCost.usd;\n  values.uiFeeUsd = applyFactor(values.sizeDeltaUsd, uiFeeFactor);\n\n  const borrowFeeCost = estimateCollateralCost(\n    position.pendingBorrowingFeesUsd,\n    collateralToken,\n    values.collateralPrice\n  );\n\n  values.borrowingFeeUsd = borrowFeeCost.usd;\n\n  const fundingFeeCost = estimateCollateralCost(\n    position.pendingFundingFeesUsd,\n    collateralToken,\n    values.collateralPrice\n  );\n\n  values.fundingFeeUsd = fundingFeeCost.usd;\n\n  if (\n    profitUsd > 0 &&\n    values.decreaseSwapType ===\n      DecreasePositionSwapType.SwapPnlTokenToCollateralToken\n  ) {\n    const swapProfitStats = getSwapStats({\n      marketInfo,\n      tokenInAddress: pnlToken.address,\n      tokenOutAddress: collateralToken.address,\n      usdIn: profitUsd,\n      shouldApplyPriceImpact: true,\n      isAtomicSwap: false,\n    });\n\n    values.swapProfitFeeUsd =\n      swapProfitStats.swapFeeUsd - swapProfitStats.priceImpactDeltaUsd;\n    values.swapUiFeeUsd = applyFactor(swapProfitStats.usdIn, uiFeeFactor);\n  } else {\n    values.swapProfitFeeUsd = 0n;\n  }\n\n  const totalFeesUsd = getTotalFeesUsdForDecrease({\n    positionFeeUsd: values.positionFeeUsd,\n    borrowingFeeUsd: values.borrowingFeeUsd,\n    fundingFeeUsd: values.fundingFeeUsd,\n    swapProfitFeeUsd: values.swapProfitFeeUsd,\n    swapUiFeeUsd: values.swapUiFeeUsd,\n    uiFeeUsd: values.uiFeeUsd,\n    pnlUsd: values.realizedPnl,\n    totalPendingImpactDeltaUsd: values.totalPendingImpactDeltaUsd,\n  });\n\n  const payedInfo = payForCollateralCost({\n    initialCostUsd: totalFeesUsd,\n    collateralToken,\n    collateralPrice: values.collateralPrice,\n    outputAmount: profitAmount,\n    remainingCollateralAmount: position.collateralAmount,\n  });\n\n  values.payedOutputUsd = convertToUsd(\n    payedInfo.paidOutputAmount,\n    collateralToken.decimals,\n    values.collateralPrice\n  )!;\n  values.payedRemainingCollateralAmount =\n    payedInfo.paidRemainingCollateralAmount;\n  values.payedRemainingCollateralUsd = convertToUsd(\n    payedInfo.paidRemainingCollateralAmount,\n    collateralToken.decimals,\n    values.collateralPrice\n  )!;\n\n  // Collateral delta\n  if (values.isFullClose) {\n    values.collateralDeltaUsd = estimatedCollateralUsd;\n    values.collateralDeltaAmount = position.collateralAmount;\n    values.receiveTokenAmount =\n      payedInfo.outputAmount + payedInfo.remainingCollateralAmount;\n  } else if (\n    keepLeverage &&\n    position.sizeInUsd > 0 &&\n    estimatedCollateralUsd > 0 &&\n    payedInfo.remainingCollateralAmount > 0\n  ) {\n    const remainingCollateralUsd = convertToUsd(\n      payedInfo.remainingCollateralAmount,\n      collateralToken.decimals,\n      values.collateralPrice\n    )!;\n    const nextSizeInUsd = position.sizeInUsd - values.sizeDeltaUsd;\n    const leverageWithoutPnl = getLeverage({\n      sizeInUsd: position.sizeInUsd,\n      collateralUsd: estimatedCollateralUsd,\n      pendingBorrowingFeesUsd: position.pendingBorrowingFeesUsd,\n      pendingFundingFeesUsd: position.pendingFundingFeesUsd,\n      pnl: undefined,\n    });\n\n    values.collateralDeltaUsd =\n      /**\n       * 1. @see https://app.asana.com/0/1204313444805313/1207549197964321/f\n       * 2. leverageWithoutPnl may be zero if sizeInUsd is defaulted to 0n when position not ready yet\n       */\n      leverageWithoutPnl !== undefined && leverageWithoutPnl !== 0n\n        ? remainingCollateralUsd -\n          bigMath.mulDiv(\n            nextSizeInUsd,\n            BASIS_POINTS_DIVISOR_BIGINT,\n            leverageWithoutPnl\n          )\n        : 0n;\n    values.collateralDeltaAmount = convertToTokenAmount(\n      values.collateralDeltaUsd,\n      collateralToken.decimals,\n      values.collateralPrice\n    )!;\n    values.receiveTokenAmount =\n      payedInfo.outputAmount + values.collateralDeltaAmount;\n  } else {\n    values.collateralDeltaUsd = 0n;\n    values.collateralDeltaAmount = 0n;\n    values.receiveTokenAmount = payedInfo.outputAmount;\n  }\n\n  values.receiveUsd = convertToUsd(\n    values.receiveTokenAmount,\n    collateralToken.decimals,\n    values.collateralPrice\n  )!;\n\n  return values;\n}\n\nexport function getIsFullClose(p: {\n  position: PositionInfoLoaded;\n  sizeDeltaUsd: bigint;\n  indexPrice: bigint;\n  remainingCollateralUsd: bigint;\n  minCollateralUsd: bigint;\n  minPositionSizeUsd: bigint;\n}) {\n  const {\n    position,\n    sizeDeltaUsd,\n    indexPrice,\n    remainingCollateralUsd,\n    minCollateralUsd,\n    minPositionSizeUsd,\n  } = p;\n  const { marketInfo, isLong } = position;\n\n  if (position.sizeInUsd - sizeDeltaUsd < expandDecimals(1, USD_DECIMALS)) {\n    return true;\n  }\n\n  const estimatedPnl = getPositionPnlUsd({\n    marketInfo,\n    sizeInUsd: position.sizeInUsd,\n    sizeInTokens: position.sizeInTokens,\n    markPrice: indexPrice,\n    isLong,\n  });\n\n  const realizedPnl = bigMath.mulDiv(\n    estimatedPnl,\n    sizeDeltaUsd,\n    position.sizeInUsd\n  );\n\n  const estimatedRemainingPnl = estimatedPnl - realizedPnl;\n\n  if (realizedPnl < 0) {\n    const estimatedRemainingCollateralUsd =\n      remainingCollateralUsd - realizedPnl;\n\n    let minCollateralFactor = isLong\n      ? marketInfo.minCollateralFactorForOpenInterestLong\n      : marketInfo.minCollateralFactorForOpenInterestShort;\n\n    const minCollateralFactorForMarket = marketInfo.minCollateralFactor;\n\n    if (minCollateralFactorForMarket > minCollateralFactor) {\n      minCollateralFactor = minCollateralFactorForMarket;\n    }\n\n    const minCollateralUsdForLeverage = applyFactor(\n      position.sizeInUsd,\n      minCollateralFactor\n    );\n    const willCollateralBeSufficient =\n      estimatedRemainingCollateralUsd >= minCollateralUsdForLeverage;\n\n    if (!willCollateralBeSufficient) {\n      if (\n        estimatedRemainingCollateralUsd + estimatedRemainingPnl <\n          minCollateralUsd ||\n        position.sizeInUsd - sizeDeltaUsd < minPositionSizeUsd\n      ) {\n        return true;\n      }\n    }\n  }\n\n  return false;\n}\n\nexport function getMinCollateralUsdForLeverage(\n  position: PositionInfoLoaded,\n  openInterestDelta: bigint\n) {\n  const minCollateralFactor = getMinCollateralFactorForPosition(\n    position,\n    openInterestDelta\n  );\n  return applyFactor(position.sizeInUsd, minCollateralFactor);\n}\n\nexport function payForCollateralCost(p: {\n  initialCostUsd: bigint;\n  collateralToken: TokenData;\n  collateralPrice: bigint;\n  outputAmount: bigint;\n  remainingCollateralAmount: bigint;\n}) {\n  const {\n    initialCostUsd,\n    collateralToken,\n    collateralPrice,\n    outputAmount,\n    remainingCollateralAmount,\n  } = p;\n\n  const values = {\n    outputAmount: BigInt(outputAmount),\n    remainingCollateralAmount: BigInt(remainingCollateralAmount),\n    paidOutputAmount: 0n,\n    paidRemainingCollateralAmount: 0n,\n  };\n\n  let remainingCostAmount = convertToTokenAmount(\n    initialCostUsd,\n    collateralToken.decimals,\n    collateralPrice\n  )!;\n\n  if (remainingCostAmount == 0n) {\n    return values;\n  }\n\n  if (values.outputAmount > 0) {\n    if (values.outputAmount > remainingCostAmount) {\n      values.outputAmount = values.outputAmount - remainingCostAmount;\n      values.paidOutputAmount = remainingCostAmount;\n      remainingCostAmount = 0n;\n    } else {\n      remainingCostAmount = remainingCostAmount - values.outputAmount;\n      values.paidOutputAmount = values.outputAmount;\n      values.outputAmount = 0n;\n    }\n  }\n\n  if (remainingCostAmount == 0n) {\n    return values;\n  }\n\n  if (values.remainingCollateralAmount > remainingCostAmount) {\n    values.remainingCollateralAmount =\n      values.remainingCollateralAmount - remainingCostAmount;\n    values.paidRemainingCollateralAmount = remainingCostAmount;\n    remainingCostAmount = 0n;\n  } else {\n    remainingCostAmount = remainingCostAmount - remainingCollateralAmount;\n    values.paidRemainingCollateralAmount = values.remainingCollateralAmount;\n    values.remainingCollateralAmount = 0n;\n  }\n\n  return values;\n}\n\nfunction applyAcceptablePrice(p: {\n  position: PositionInfoLoaded | undefined;\n  marketInfo: MarketInfo;\n  isLong: boolean;\n  isTrigger: boolean;\n  fixedAcceptablePriceImpactBps?: bigint;\n  acceptablePriceImpactBuffer?: number;\n  values: DecreasePositionAmounts;\n  isSetAcceptablePriceImpactEnabled: boolean;\n}) {\n  const {\n    position,\n    marketInfo,\n    isLong,\n    values,\n    isTrigger,\n    fixedAcceptablePriceImpactBps,\n    acceptablePriceImpactBuffer,\n    isSetAcceptablePriceImpactEnabled,\n  } = p;\n\n  const acceptablePriceInfo = getAcceptablePriceInfo({\n    marketInfo,\n    isIncrease: false,\n    isLimit: false,\n    isLong,\n    indexPrice: values.indexPrice,\n    sizeDeltaUsd: values.sizeDeltaUsd,\n  });\n\n  values.acceptablePrice = acceptablePriceInfo.acceptablePrice;\n  values.acceptablePriceDeltaBps = acceptablePriceInfo.acceptablePriceDeltaBps;\n  values.balanceWasImproved = acceptablePriceInfo.balanceWasImproved;\n\n  const totalImpactValues = getNetPriceImpactDeltaUsdForDecrease({\n    marketInfo,\n    sizeInUsd: position?.sizeInUsd ?? 0n,\n    pendingImpactAmount: position?.pendingImpactAmount ?? 0n,\n    sizeDeltaUsd: values.sizeDeltaUsd,\n    priceImpactDeltaUsd: acceptablePriceInfo.priceImpactDeltaUsd,\n  });\n\n  values.closePriceImpactDeltaUsd = acceptablePriceInfo.priceImpactDeltaUsd;\n  values.totalPendingImpactDeltaUsd = totalImpactValues.totalImpactDeltaUsd;\n  values.proportionalPendingImpactDeltaUsd =\n    totalImpactValues.proportionalPendingImpactDeltaUsd;\n  values.priceImpactDiffUsd = totalImpactValues.priceImpactDiffUsd;\n\n  if (isTrigger) {\n    if (\n      !isSetAcceptablePriceImpactEnabled ||\n      values.triggerOrderType === OrderType.StopLossDecrease\n    ) {\n      values.acceptablePrice = isLong ? 0n : MaxUint256;\n    } else {\n      let maxNegativePriceImpactBps = fixedAcceptablePriceImpactBps;\n      values.recommendedAcceptablePriceDeltaBps =\n        getDefaultAcceptablePriceImpactBps({\n          isIncrease: false,\n          isLong,\n          indexPrice: values.indexPrice,\n          sizeDeltaUsd: values.sizeDeltaUsd,\n          priceImpactDeltaUsd: values.closePriceImpactDeltaUsd,\n          acceptablePriceImapctBuffer:\n            acceptablePriceImpactBuffer ||\n            DEFAULT_ACCEPTABLE_PRICE_IMPACT_BUFFER,\n        });\n\n      if (maxNegativePriceImpactBps === undefined) {\n        maxNegativePriceImpactBps = values.recommendedAcceptablePriceDeltaBps;\n      }\n\n      const triggerAcceptablePriceInfo = getAcceptablePriceInfo({\n        marketInfo,\n        isIncrease: false,\n        isLimit: false,\n        isLong,\n        indexPrice: values.indexPrice,\n        sizeDeltaUsd: values.sizeDeltaUsd,\n        maxNegativePriceImpactBps,\n      });\n\n      values.acceptablePrice = triggerAcceptablePriceInfo.acceptablePrice;\n      values.acceptablePriceDeltaBps =\n        triggerAcceptablePriceInfo.acceptablePriceDeltaBps;\n    }\n  }\n\n  return values;\n}\n\nexport function estimateCollateralCost(\n  baseUsd: bigint,\n  collateralToken: TokenData,\n  collateralPrice: bigint\n) {\n  const amount = convertToTokenAmount(\n    baseUsd,\n    collateralToken.decimals,\n    collateralToken.prices.minPrice\n  )!;\n  const usd = convertToUsd(amount, collateralToken.decimals, collateralPrice)!;\n\n  return {\n    amount,\n    usd,\n  };\n}\n\nexport function getTotalFeesUsdForDecrease({\n  positionFeeUsd,\n  borrowingFeeUsd,\n  fundingFeeUsd,\n  swapProfitFeeUsd,\n  swapUiFeeUsd,\n  uiFeeUsd,\n  pnlUsd,\n  totalPendingImpactDeltaUsd,\n}: {\n  positionFeeUsd: bigint;\n  borrowingFeeUsd: bigint;\n  fundingFeeUsd: bigint;\n  swapProfitFeeUsd: bigint;\n  swapUiFeeUsd: bigint;\n  uiFeeUsd: bigint;\n  pnlUsd: bigint;\n  totalPendingImpactDeltaUsd: bigint;\n}) {\n  const negativePriceImpactUsd =\n    totalPendingImpactDeltaUsd < 0\n      ? bigMath.abs(totalPendingImpactDeltaUsd)\n      : 0n;\n  const negativePnlUsd = pnlUsd < 0 ? bigMath.abs(pnlUsd) : 0n;\n\n  const totalFeesUsd =\n    positionFeeUsd +\n    borrowingFeeUsd +\n    fundingFeeUsd +\n    swapProfitFeeUsd +\n    swapUiFeeUsd +\n    uiFeeUsd +\n    negativePnlUsd +\n    negativePriceImpactUsd;\n\n  return totalFeesUsd;\n}\n\nexport function getNextPositionValuesForDecreaseTrade(p: {\n  existingPosition?: PositionInfo;\n  marketInfo: MarketInfo;\n  collateralToken: TokenData;\n  sizeDeltaUsd: bigint;\n  sizeDeltaInTokens: bigint;\n  realizedPnl: bigint;\n  estimatedPnl: bigint;\n  collateralDeltaUsd: bigint;\n  collateralDeltaAmount: bigint;\n  payedRemainingCollateralUsd: bigint;\n  payedRemainingCollateralAmount: bigint;\n  proportionalPendingImpactDeltaUsd: bigint;\n  showPnlInLeverage: boolean;\n  isLong: boolean;\n  minCollateralUsd: bigint;\n  userReferralInfo: UserReferralInfo | undefined;\n}): NextPositionValues {\n  const {\n    existingPosition,\n    marketInfo,\n    collateralToken,\n    sizeDeltaUsd,\n    sizeDeltaInTokens,\n    realizedPnl,\n    estimatedPnl,\n    collateralDeltaUsd,\n    collateralDeltaAmount,\n    payedRemainingCollateralUsd,\n    payedRemainingCollateralAmount,\n    showPnlInLeverage,\n    proportionalPendingImpactDeltaUsd,\n    isLong,\n    minCollateralUsd,\n    userReferralInfo,\n  } = p;\n\n  const nextSizeUsd = existingPosition\n    ? existingPosition.sizeInUsd - sizeDeltaUsd\n    : 0n;\n  const nextSizeInTokens = existingPosition\n    ? existingPosition.sizeInTokens - sizeDeltaInTokens\n    : 0n;\n\n  let nextCollateralUsd = existingPosition\n    ? existingPosition.collateralUsd -\n      collateralDeltaUsd -\n      payedRemainingCollateralUsd\n    : 0n;\n\n  if (nextCollateralUsd < 0) {\n    nextCollateralUsd = 0n;\n  }\n\n  let nextCollateralAmount = existingPosition\n    ? existingPosition.collateralAmount -\n      collateralDeltaAmount -\n      payedRemainingCollateralAmount\n    : 0n;\n\n  if (nextCollateralAmount < 0) {\n    nextCollateralAmount = 0n;\n  }\n\n  const nextPnl = estimatedPnl ? estimatedPnl - realizedPnl : 0n;\n\n  const nextPnlPercentage =\n    nextCollateralUsd !== 0n ? getBasisPoints(nextPnl, nextCollateralUsd) : 0n;\n\n  const nextLeverage = getLeverage({\n    sizeInUsd: nextSizeUsd,\n    collateralUsd: nextCollateralUsd,\n    pnl: showPnlInLeverage ? nextPnl : undefined,\n    pendingBorrowingFeesUsd: 0n, // deducted on order\n    pendingFundingFeesUsd: 0n, // deducted on order\n  });\n\n  const nextLiqPrice = getLiquidationPrice({\n    marketInfo,\n    collateralToken,\n    sizeInTokens: nextSizeInTokens,\n    sizeInUsd: nextSizeUsd,\n    collateralUsd: nextCollateralUsd,\n    collateralAmount: nextCollateralAmount,\n    minCollateralUsd,\n    userReferralInfo,\n    pendingImpactAmount: existingPosition?.pendingImpactAmount ?? 0n,\n    pendingBorrowingFeesUsd: 0n, // deducted on order\n    pendingFundingFeesUsd: 0n, // deducted on order\n    isLong: isLong,\n  });\n\n  const nextPendingImpactDeltaUsd =\n    existingPosition?.pendingImpactUsd !== undefined &&\n    proportionalPendingImpactDeltaUsd !== undefined\n      ? existingPosition.pendingImpactUsd - proportionalPendingImpactDeltaUsd\n      : 0n;\n\n  return {\n    nextSizeUsd,\n    nextCollateralUsd,\n    nextLiqPrice,\n    nextPnl,\n    nextPnlPercentage,\n    nextLeverage,\n    nextPendingImpactDeltaUsd,\n  };\n}\n\nfunction getDecreaseSwapType(\n  pnlToken: TokenData,\n  collateralToken: TokenData,\n  receiveToken: TokenData\n) {\n  if (getIsEquivalentTokens(pnlToken, collateralToken)) {\n    return DecreasePositionSwapType.NoSwap;\n  } else if (getIsEquivalentTokens(pnlToken, receiveToken)) {\n    return DecreasePositionSwapType.SwapCollateralTokenToPnlToken;\n  } else {\n    return DecreasePositionSwapType.SwapPnlTokenToCollateralToken;\n  }\n}\n"]}