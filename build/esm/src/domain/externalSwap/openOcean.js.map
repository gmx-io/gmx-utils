{"version":3,"sources":["../../../../../src/domain/externalSwap/openOcean.ts"],"names":[],"mappings":"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","file":"openOcean.js","sourcesContent":["import { ContractsChainId } from \"configs/chains\";\nimport { getContract } from \"configs/contracts\";\nimport { convertTokenAddress, getToken } from \"configs/tokens\";\nimport { buildUrl } from \"lib/buildUrl\";\nimport { formatTokenAmount, numberToBigint, USD_DECIMALS } from \"lib/numbers\";\n\ntype OpenOceanTxnResponse = {\n  code: number;\n  error?: string;\n  data?: {\n    inToken: {\n      address: string;\n      decimals: number;\n      symbol: string;\n      name: string;\n      usd: string;\n      volume: string;\n    };\n    outToken: {\n      address: string;\n      decimals: number;\n      symbol: string;\n      name: string;\n      usd: string;\n      volume: string;\n    };\n    inAmount: string;\n    outAmount: string;\n    minOutAmount: string;\n    estimatedGas: string;\n    value: string;\n    gasPrice: string;\n    to: string;\n    data: string;\n    price_impact: string;\n  };\n};\n\nexport type OpenOceanQuote = {\n  to: string;\n  data: string;\n  value: bigint;\n  estimatedGas: bigint;\n  usdIn: bigint;\n  usdOut: bigint;\n  priceIn: bigint;\n  priceOut: bigint;\n  gasPrice: bigint;\n  amountIn: bigint;\n  outputAmount: bigint;\n};\n\nexport async function getOpenOceanTxnData({\n  chainId,\n  tokenInAddress,\n  tokenOutAddress,\n  amountIn,\n  senderAddress,\n  receiverAddress,\n  gasPrice,\n  slippage,\n  openOceanUrl,\n  openOceanReferrer,\n  disabledDexIds = [],\n  onError,\n}: {\n  senderAddress: string;\n  receiverAddress: string;\n  chainId: ContractsChainId;\n  tokenInAddress: string;\n  tokenOutAddress: string;\n  amountIn: bigint;\n  gasPrice: bigint;\n  slippage: number;\n  openOceanUrl: string;\n  disabledDexIds?: number[];\n  openOceanReferrer?: string;\n  onError?: (error: Error, url: string) => void;\n}): Promise<OpenOceanQuote | undefined> {\n  const tokenIn = getToken(chainId, tokenInAddress);\n\n  const gweiGasPrice = formatTokenAmount(gasPrice, 18 - 9, undefined, {\n    displayDecimals: 8,\n  });\n\n  const url = buildUrl(openOceanUrl, \"/swap_quote\", {\n    inTokenAddress: convertTokenAddress(chainId, tokenInAddress, \"wrapped\"),\n    outTokenAddress: convertTokenAddress(chainId, tokenOutAddress, \"wrapped\"),\n    amount: formatTokenAmount(amountIn, tokenIn.decimals, undefined, {\n      showAllSignificant: true,\n      isStable: tokenIn.isStable,\n    }),\n    gasPrice: gweiGasPrice,\n    slippage: (slippage / 100).toString(),\n    sender: senderAddress,\n    account: receiverAddress,\n    referrer: openOceanReferrer,\n    disabledDexIds: disabledDexIds.join(\",\"),\n    disableRfq: true,\n  });\n\n  try {\n    const res = await fetch(url);\n\n    if (res.status === 403) {\n      throw new Error(`IP is banned ${await res.text()}`);\n    }\n\n    const parsed = (await res.json()) as OpenOceanTxnResponse;\n\n    if (!parsed.data || parsed.code !== 200) {\n      throw new Error(\n        `Failed to build transaction: ${parsed.code} ${parsed.error}`\n      );\n    }\n\n    if (parsed.data.to !== getContract(chainId, \"OpenOceanRouter\")) {\n      throw new Error(`Invalid OpenOceanRouter address: ${parsed.data.to}`);\n    }\n\n    return {\n      to: parsed.data.to as string,\n      data: parsed.data.data as string,\n      value: BigInt(parsed.data.value),\n      estimatedGas: BigInt(parsed.data.estimatedGas),\n      usdIn: numberToBigint(\n        parseFloat(parsed.data.inToken.volume),\n        USD_DECIMALS\n      ),\n      usdOut: numberToBigint(\n        parseFloat(parsed.data.outToken.volume),\n        USD_DECIMALS\n      ),\n      priceIn: numberToBigint(\n        parseFloat(parsed.data.inToken.usd),\n        USD_DECIMALS\n      ),\n      priceOut: numberToBigint(\n        parseFloat(parsed.data.outToken.usd),\n        USD_DECIMALS\n      ),\n      gasPrice: BigInt(parsed.data.gasPrice),\n      amountIn,\n      outputAmount: BigInt(parsed.data.minOutAmount),\n    };\n  } catch (e) {\n    const error = e as Error;\n    error.message += ` URL: ${url.replace(receiverAddress, \"...\")}`;\n    if (onError) {\n      onError(error, url);\n    }\n    return undefined;\n  }\n}\n"]}