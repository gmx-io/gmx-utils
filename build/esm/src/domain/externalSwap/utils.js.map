{"version":3,"sources":["../../../../../src/domain/externalSwap/utils.ts"],"names":[],"mappings":"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","file":"utils.js","sourcesContent":["import { getFeeItem, getPositionFee } from \"domain/executionFee\";\nimport { getIncreasePositionPrices, leverageBySizeValues } from \"domain/increase/increase\";\nimport { MarketInfo, MarketsInfoData } from \"domain/markets/types\";\nimport { PositionInfo } from \"domain/positions/types\";\nimport { UserReferralInfo } from \"domain/referrals/types\";\nimport { getSwapAmountsByFromValue, getSwapAmountsByToValue } from \"domain/swap/swapValues\";\nimport { SwapAmounts, FindSwapPath } from \"domain/swap/types\";\nimport { TokenData } from \"domain/tokens/types\";\nimport { convertToTokenAmount, convertToUsd } from \"domain/tokens/utils\";\nimport { applyFactor } from \"lib/numbers\";\n\nimport { ExternalSwapInputs, ExternalSwapQuote } from \"./types\";\n\nexport function getExternalSwapInputsByFromValue({\n  tokenIn,\n  tokenOut,\n  amountIn,\n  findSwapPath,\n  uiFeeFactor,\n  marketsInfoData,\n  chainId,\n}: {\n  tokenIn: TokenData;\n  tokenOut: TokenData;\n  amountIn: bigint;\n  findSwapPath: FindSwapPath;\n  uiFeeFactor: bigint;\n  marketsInfoData: MarketsInfoData | undefined;\n  chainId: number;\n}): ExternalSwapInputs {\n  const swapAmounts = getSwapAmountsByFromValue({\n    tokenIn,\n    tokenOut,\n    amountIn,\n    isLimit: false,\n    findSwapPath,\n    uiFeeFactor,\n    marketsInfoData,\n    chainId,\n    externalSwapQuoteParams: undefined,\n  });\n\n  const internalSwapTotalFeesDeltaUsd = swapAmounts.swapStrategy.swapPathStats\n    ? swapAmounts.swapStrategy.swapPathStats.totalFeesDeltaUsd\n    : undefined;\n\n  const internalSwapTotalFeeItem = getFeeItem(internalSwapTotalFeesDeltaUsd, swapAmounts.usdIn);\n\n  return {\n    amountIn,\n    priceIn: swapAmounts.priceIn,\n    priceOut: swapAmounts.priceOut,\n    usdIn: swapAmounts.usdIn,\n    usdOut: swapAmounts.usdOut,\n    strategy: \"byFromValue\",\n    internalSwapTotalFeeItem,\n    internalSwapTotalFeesDeltaUsd,\n    internalSwapAmounts: swapAmounts,\n  };\n}\n\nexport function getExternalSwapInputsByLeverageSize({\n  marketInfo,\n  tokenIn,\n  collateralToken,\n  indexTokenAmount,\n  findSwapPath,\n  uiFeeFactor,\n  triggerPrice,\n  existingPosition,\n  leverage,\n  isLong,\n  userReferralInfo,\n  marketsInfoData,\n  chainId,\n}: {\n  tokenIn: TokenData;\n  collateralToken: TokenData;\n  marketInfo: MarketInfo;\n  indexTokenAmount: bigint;\n  uiFeeFactor: bigint;\n  triggerPrice?: bigint;\n  existingPosition?: PositionInfo;\n  leverage: bigint;\n  isLong: boolean;\n  findSwapPath: FindSwapPath;\n  userReferralInfo: UserReferralInfo | undefined;\n  marketsInfoData: MarketsInfoData | undefined;\n  chainId: number;\n}): ExternalSwapInputs {\n  const prices = getIncreasePositionPrices({\n    triggerPrice,\n    indexToken: marketInfo.indexToken,\n    initialCollateralToken: tokenIn,\n    collateralToken,\n    isLong,\n  });\n\n  const sizeDeltaUsd = convertToUsd(indexTokenAmount, marketInfo.indexToken.decimals, prices.indexPrice)!;\n\n  const positionFeeInfo = getPositionFee(marketInfo, sizeDeltaUsd, false, userReferralInfo);\n\n  const positionFeeUsd = positionFeeInfo.positionFeeUsd;\n  const uiFeeUsd = applyFactor(sizeDeltaUsd, uiFeeFactor);\n\n  const { baseCollateralAmount } = leverageBySizeValues({\n    collateralToken,\n    leverage,\n    sizeDeltaUsd,\n    collateralPrice: prices.collateralPrice,\n    uiFeeFactor,\n    positionFeeUsd,\n    fundingFeeUsd: existingPosition?.pendingFundingFeesUsd || 0n,\n    borrowingFeeUsd: existingPosition?.pendingBorrowingFeesUsd || 0n,\n    uiFeeUsd,\n    swapUiFeeUsd: 0n,\n  });\n\n  const usdOut = convertToUsd(baseCollateralAmount, collateralToken.decimals, collateralToken.prices.maxPrice)!;\n  const baseUsdIn = usdOut;\n  const baseAmountIn = convertToTokenAmount(baseUsdIn, tokenIn.decimals, tokenIn.prices.minPrice)!;\n\n  const swapAmounts = getSwapAmountsByToValue({\n    tokenIn,\n    tokenOut: collateralToken,\n    amountOut: baseCollateralAmount,\n    isLimit: false,\n    findSwapPath,\n    uiFeeFactor,\n    marketsInfoData,\n    chainId,\n    externalSwapQuoteParams: undefined,\n  });\n\n  const internalSwapTotalFeesDeltaUsd = swapAmounts.swapStrategy.swapPathStats\n    ? swapAmounts.swapStrategy.swapPathStats.totalFeesDeltaUsd\n    : undefined;\n\n  const internalSwapTotalFeeItem = getFeeItem(internalSwapTotalFeesDeltaUsd, swapAmounts.usdIn);\n\n  return {\n    amountIn: baseAmountIn,\n    priceIn: swapAmounts.priceIn,\n    priceOut: swapAmounts.priceOut,\n    usdIn: baseUsdIn,\n    usdOut: swapAmounts.usdOut,\n    strategy: \"leverageBySize\",\n    internalSwapTotalFeeItem,\n    internalSwapTotalFeesDeltaUsd,\n    internalSwapAmounts: swapAmounts,\n  };\n}\n\nexport function getBestSwapStrategy({\n  internalSwapAmounts,\n  externalSwapQuote,\n  forceExternalSwaps,\n}: {\n  internalSwapAmounts: SwapAmounts | undefined;\n  externalSwapQuote: ExternalSwapQuote | undefined;\n  forceExternalSwaps?: boolean;\n}) {\n  let amountIn: bigint;\n  let amountOut: bigint;\n  let usdIn: bigint;\n  let usdOut: bigint;\n\n  if (\n    externalSwapQuote &&\n    (externalSwapQuote.usdOut > (internalSwapAmounts?.swapStrategy.swapPathStats?.usdOut ?? 0n) || forceExternalSwaps)\n  ) {\n    amountIn = externalSwapQuote.amountIn;\n    amountOut = externalSwapQuote.amountOut;\n    usdIn = externalSwapQuote.usdIn;\n    usdOut = externalSwapQuote.usdOut;\n\n    return {\n      amountIn,\n      amountOut,\n      usdIn,\n      usdOut,\n      externalSwapQuote,\n    };\n  } else if (internalSwapAmounts?.swapStrategy.swapPathStats) {\n    amountIn = internalSwapAmounts.amountIn;\n    amountOut = internalSwapAmounts.amountOut;\n    usdIn = internalSwapAmounts.usdIn;\n    usdOut = internalSwapAmounts.usdOut;\n\n    return {\n      amountIn,\n      amountOut,\n      usdIn,\n      usdOut,\n      swapPath: internalSwapAmounts.swapStrategy.swapPathStats.swapPath,\n    };\n  } else {\n    return undefined;\n  }\n}\n\nexport function getIsInternalSwapBetter({\n  internalSwapAmounts,\n  externalSwapQuote,\n  forceExternalSwaps,\n}: {\n  internalSwapAmounts: SwapAmounts | undefined;\n  externalSwapQuote: ExternalSwapQuote | undefined;\n  forceExternalSwaps?: boolean;\n}) {\n  if (externalSwapQuote?.usdOut == undefined) {\n    return true;\n  }\n\n  if (forceExternalSwaps) {\n    return false;\n  }\n\n  return (\n    internalSwapAmounts?.swapStrategy.swapPathStats?.usdOut !== undefined &&\n    internalSwapAmounts!.swapStrategy!.swapPathStats!.usdOut! > (externalSwapQuote?.usdOut ?? 0n)\n  );\n}\n\n"]}