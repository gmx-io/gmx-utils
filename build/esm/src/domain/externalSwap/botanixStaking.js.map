{"version":3,"sources":["../../../../../src/domain/externalSwap/botanixStaking.ts"],"names":[],"mappings":"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","file":"botanixStaking.js","sourcesContent":["import { encodeFunctionData } from \"viem\";\n\nimport StBTCABI from \"abis/StBTC\";\nimport { BOTANIX } from \"configs/chains\";\nimport { getContract } from \"configs/contracts\";\nimport { TokensData } from \"domain/tokens/types\";\nimport { convertToUsd, getMidPrice, getTokenData } from \"domain/tokens/utils\";\nimport { bigMath } from \"lib/bigmath\";\nimport { BASIS_POINTS_DIVISOR_BIGINT, getBasisPoints } from \"lib/numbers\";\n\nimport {\n  AVAILABLE_BOTANIX_DEPOSIT_PAIRS,\n  AVAILABLE_BOTANIX_WITHDRAW_PAIRS,\n} from \"./externalSwapPath\";\nimport { ExternalSwapAggregator, ExternalSwapQuote } from \"./types\";\n\nconst COEF_REDUCER = getBasisPoints(1n, 10000n);\n\nexport const getBotanixStakingExternalSwapQuote = ({\n  tokenInAddress,\n  tokenOutAddress,\n  amountIn,\n  gasPrice,\n  receiverAddress,\n  tokensData,\n  assetsPerShare,\n}: {\n  tokenInAddress: string;\n  tokenOutAddress: string;\n  amountIn: bigint;\n  gasPrice: bigint;\n  receiverAddress: string;\n  tokensData: TokensData;\n  assetsPerShare: bigint;\n}): ExternalSwapQuote | undefined => {\n  const inTokenData = getTokenData(tokensData, tokenInAddress);\n  const outTokenData = getTokenData(tokensData, tokenOutAddress);\n\n  const assetsPerShareRate =\n    getBasisPoints(assetsPerShare, 10n ** 18n) - COEF_REDUCER;\n  const sharesPerAssetRate =\n    getBasisPoints(10n ** 18n, assetsPerShare) - COEF_REDUCER;\n\n  if (!inTokenData || !outTokenData) {\n    return undefined;\n  }\n\n  if (\n    AVAILABLE_BOTANIX_DEPOSIT_PAIRS.some(\n      (pair) => pair.from === tokenInAddress && pair.to === tokenOutAddress\n    )\n  ) {\n    const priceIn = getMidPrice(inTokenData.prices);\n    const priceOut = bigMath.mulDiv(\n      priceIn,\n      sharesPerAssetRate,\n      BASIS_POINTS_DIVISOR_BIGINT\n    );\n    const usdIn = convertToUsd(amountIn, inTokenData.decimals, priceIn);\n    const amountOut =\n      amountIn > 0n\n        ? bigMath.mulDiv(\n            amountIn,\n            sharesPerAssetRate,\n            BASIS_POINTS_DIVISOR_BIGINT\n          ) - gasPrice\n        : 0n;\n    const usdOut =\n      amountOut > 0n\n        ? convertToUsd(amountOut, outTokenData.decimals, priceOut)\n        : 0n;\n    return {\n      aggregator: ExternalSwapAggregator.BotanixStaking,\n      inTokenAddress: tokenInAddress,\n      outTokenAddress: tokenOutAddress,\n      receiver: receiverAddress,\n      amountIn,\n      amountOut,\n      usdIn: usdIn!,\n      usdOut: usdOut!,\n      priceIn,\n      priceOut,\n      feesUsd: gasPrice,\n      needSpenderApproval: true,\n      txnData: {\n        to: getContract(BOTANIX, \"StBTC\"),\n        data: encodeFunctionData({\n          abi: StBTCABI,\n          functionName: \"deposit\",\n          args: [amountIn, receiverAddress as `0x${string}`],\n        }),\n        value: 0n,\n        estimatedGas: gasPrice,\n        estimatedExecutionFee: gasPrice,\n      },\n    };\n  }\n\n  if (\n    AVAILABLE_BOTANIX_WITHDRAW_PAIRS.some(\n      (pair) => pair.from === tokenInAddress && pair.to === tokenOutAddress\n    )\n  ) {\n    const priceIn = getMidPrice(inTokenData.prices);\n    const priceOut = bigMath.mulDiv(\n      priceIn,\n      assetsPerShareRate,\n      BASIS_POINTS_DIVISOR_BIGINT\n    );\n    const usdIn = convertToUsd(amountIn, inTokenData.decimals, priceIn);\n    const amountOut =\n      amountIn > 0n\n        ? bigMath.mulDiv(\n            amountIn,\n            assetsPerShareRate,\n            BASIS_POINTS_DIVISOR_BIGINT\n          ) - gasPrice\n        : 0n;\n    const usdOut =\n      amountOut > 0n\n        ? convertToUsd(amountOut, outTokenData.decimals, priceOut)\n        : 0n;\n\n    return {\n      aggregator: ExternalSwapAggregator.BotanixStaking,\n      inTokenAddress: tokenInAddress,\n      outTokenAddress: tokenOutAddress,\n      receiver: receiverAddress,\n      amountIn,\n      amountOut,\n      usdIn: usdIn!,\n      usdOut: usdOut!,\n      priceIn,\n      priceOut,\n      feesUsd: gasPrice,\n      needSpenderApproval: true,\n      txnData: {\n        to: getContract(BOTANIX, \"StBTC\"),\n        data: encodeFunctionData({\n          abi: StBTCABI,\n          functionName: \"withdraw\",\n          args: [\n            amountIn,\n            receiverAddress as `0x${string}`,\n            getContract(BOTANIX, \"ExternalHandler\"),\n          ],\n        }),\n        value: 0n,\n        estimatedGas: gasPrice,\n        estimatedExecutionFee: gasPrice,\n      },\n    };\n  }\n};\n"]}