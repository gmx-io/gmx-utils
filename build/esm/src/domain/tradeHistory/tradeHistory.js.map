{"version":3,"sources":["../../../../../src/domain/tradeHistory/tradeHistory.ts"],"names":[],"mappings":"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","file":"tradeHistory.js","sourcesContent":["import { getAddress } from \"viem\";\n\nimport type { TradeAction as SubsquidTradeAction } from \"codegen/subsquid\";\nimport type { MarketsInfoData } from \"domain/markets/types\";\nimport { isIncreaseOrderType, isSwapOrderType } from \"domain/orders/utils\";\nimport { parseContractPrice } from \"domain/pricing/contractPrice\";\nimport { getSwapPathOutputAddresses } from \"domain/swap/swapStats\";\nimport { Token, TokensData } from \"domain/tokens/types\";\nimport type {\n  PositionTradeAction,\n  SwapTradeAction,\n} from \"domain/tradeHistory/types\";\nimport { getByKey } from \"lib/objects\";\n\nimport { TradeActionType } from \"./types\";\n\nexport function createRawTradeActionTransformer(\n  marketsInfoData: MarketsInfoData,\n  wrappedToken: Token,\n  tokensData: TokensData\n): (\n  value: SubsquidTradeAction,\n  index: number,\n  array: SubsquidTradeAction[]\n) => SwapTradeAction | PositionTradeAction | undefined {\n  return (rawAction) => {\n    const orderType = Number(rawAction.orderType);\n\n    if (isSwapOrderType(orderType)) {\n      const initialCollateralTokenAddress = getAddress(\n        rawAction.initialCollateralTokenAddress!\n      );\n      const swapPath = rawAction.swapPath!.map((address) =>\n        getAddress(address)\n      );\n\n      const swapPathOutputAddresses = getSwapPathOutputAddresses({\n        marketsInfoData,\n        swapPath,\n        initialCollateralAddress: initialCollateralTokenAddress,\n        wrappedNativeTokenAddress: wrappedToken.address,\n        shouldUnwrapNativeToken: rawAction.shouldUnwrapNativeToken!,\n        isIncrease: false,\n      });\n\n      const initialCollateralToken = getByKey(\n        tokensData,\n        initialCollateralTokenAddress\n      )!;\n      const targetCollateralToken = getByKey(\n        tokensData,\n        swapPathOutputAddresses.outTokenAddress\n      )!;\n\n      if (!initialCollateralToken || !targetCollateralToken) {\n        return undefined;\n      }\n\n      const tradeAction: SwapTradeAction = {\n        type: \"swap\",\n        id: rawAction.id,\n        srcChainId: rawAction.srcChainId\n          ? Number(rawAction.srcChainId)\n          : undefined,\n        eventName: rawAction.eventName as TradeActionType,\n        account: rawAction.account,\n        swapPath,\n        orderType,\n        orderKey: rawAction.orderKey,\n        initialCollateralTokenAddress: rawAction.initialCollateralTokenAddress!,\n        initialCollateralDeltaAmount: bigNumberify(\n          rawAction.initialCollateralDeltaAmount\n        )!,\n        minOutputAmount: bigNumberify(rawAction.minOutputAmount)!,\n        executionAmountOut: rawAction.executionAmountOut\n          ? bigNumberify(rawAction.executionAmountOut)\n          : undefined,\n        shouldUnwrapNativeToken: rawAction.shouldUnwrapNativeToken!,\n        targetCollateralToken,\n        initialCollateralToken,\n        timestamp: rawAction.timestamp,\n        transaction: rawAction.transaction,\n        reason: rawAction.reason ?? undefined,\n        reasonBytes: rawAction.reasonBytes ?? undefined,\n        twapParams:\n          rawAction.twapGroupId && rawAction.numberOfParts\n            ? {\n                twapGroupId: rawAction.twapGroupId,\n                numberOfParts: rawAction.numberOfParts,\n              }\n            : undefined,\n      };\n\n      return tradeAction;\n    } else {\n      const marketAddress = getAddress(rawAction.marketAddress!);\n      const marketInfo = getByKey(marketsInfoData, marketAddress);\n      const indexToken = marketInfo?.indexToken;\n      const initialCollateralTokenAddress = getAddress(\n        rawAction.initialCollateralTokenAddress!\n      );\n      const swapPath = rawAction.swapPath!.map((address) =>\n        getAddress(address)\n      );\n      const swapPathOutputAddresses = getSwapPathOutputAddresses({\n        marketsInfoData,\n        swapPath,\n        initialCollateralAddress: initialCollateralTokenAddress,\n        wrappedNativeTokenAddress: wrappedToken.address,\n        shouldUnwrapNativeToken: rawAction.shouldUnwrapNativeToken!,\n        isIncrease: isIncreaseOrderType(rawAction.orderType),\n      });\n      const initialCollateralToken = getByKey(\n        tokensData,\n        initialCollateralTokenAddress\n      );\n      const targetCollateralToken = getByKey(\n        tokensData,\n        swapPathOutputAddresses.outTokenAddress\n      );\n\n      if (\n        !marketInfo ||\n        !indexToken ||\n        !initialCollateralToken ||\n        !targetCollateralToken\n      ) {\n        return undefined;\n      }\n\n      const tradeAction: PositionTradeAction = {\n        type: \"position\",\n        id: rawAction.id,\n        eventName: rawAction.eventName as TradeActionType,\n        account: rawAction.account,\n        marketAddress,\n        marketInfo,\n        srcChainId: rawAction.srcChainId\n          ? Number(rawAction.srcChainId)\n          : undefined,\n        indexToken,\n        swapPath,\n        initialCollateralTokenAddress,\n        initialCollateralToken,\n        targetCollateralToken,\n        initialCollateralDeltaAmount: bigNumberify(\n          rawAction.initialCollateralDeltaAmount\n        )!,\n        sizeDeltaUsd: bigNumberify(rawAction.sizeDeltaUsd)!,\n        sizeDeltaInTokens: rawAction.sizeDeltaInTokens\n          ? bigNumberify(rawAction.sizeDeltaInTokens)\n          : undefined,\n        triggerPrice: rawAction.triggerPrice\n          ? parseContractPrice(\n              bigNumberify(rawAction.triggerPrice)!,\n              indexToken.decimals\n            )\n          : undefined,\n        acceptablePrice: parseContractPrice(\n          bigNumberify(rawAction.acceptablePrice)!,\n          indexToken.decimals\n        ),\n        executionPrice: rawAction.executionPrice\n          ? parseContractPrice(\n              bigNumberify(rawAction.executionPrice)!,\n              indexToken.decimals\n            )\n          : undefined,\n        minOutputAmount: bigNumberify(rawAction.minOutputAmount)!,\n\n        collateralTokenPriceMax: rawAction.collateralTokenPriceMax\n          ? parseContractPrice(\n              bigNumberify(rawAction.collateralTokenPriceMax)!,\n              initialCollateralToken.decimals\n            )\n          : undefined,\n\n        collateralTokenPriceMin: rawAction.collateralTokenPriceMin\n          ? parseContractPrice(\n              bigNumberify(rawAction.collateralTokenPriceMin)!,\n              initialCollateralToken.decimals\n            )\n          : undefined,\n\n        indexTokenPriceMin: rawAction.indexTokenPriceMin\n          ? parseContractPrice(\n              BigInt(rawAction.indexTokenPriceMin),\n              indexToken.decimals\n            )\n          : undefined,\n        indexTokenPriceMax: rawAction.indexTokenPriceMax\n          ? parseContractPrice(\n              BigInt(rawAction.indexTokenPriceMax),\n              indexToken.decimals\n            )\n          : undefined,\n\n        orderType,\n        orderKey: rawAction.orderKey,\n        isLong: rawAction.isLong!,\n        pnlUsd: rawAction.pnlUsd ? BigInt(rawAction.pnlUsd) : undefined,\n        basePnlUsd: rawAction.basePnlUsd\n          ? BigInt(rawAction.basePnlUsd)\n          : undefined,\n\n        priceImpactDiffUsd: rawAction.priceImpactDiffUsd\n          ? BigInt(rawAction.priceImpactDiffUsd)\n          : undefined,\n        priceImpactUsd: rawAction.priceImpactUsd\n          ? BigInt(rawAction.priceImpactUsd)\n          : undefined,\n        totalImpactUsd: rawAction.totalImpactUsd\n          ? BigInt(rawAction.totalImpactUsd)\n          : undefined,\n        positionFeeAmount: rawAction.positionFeeAmount\n          ? BigInt(rawAction.positionFeeAmount)\n          : undefined,\n        borrowingFeeAmount: rawAction.borrowingFeeAmount\n          ? BigInt(rawAction.borrowingFeeAmount)\n          : undefined,\n        fundingFeeAmount: rawAction.fundingFeeAmount\n          ? BigInt(rawAction.fundingFeeAmount)\n          : undefined,\n        liquidationFeeAmount: rawAction.liquidationFeeAmount\n          ? BigInt(rawAction.liquidationFeeAmount)\n          : undefined,\n\n        reason: rawAction.reason ?? undefined,\n        reasonBytes: rawAction.reasonBytes ?? undefined,\n\n        transaction: rawAction.transaction,\n        timestamp: rawAction.timestamp,\n        shouldUnwrapNativeToken: rawAction.shouldUnwrapNativeToken!,\n        twapParams:\n          rawAction.twapGroupId && rawAction.numberOfParts\n            ? {\n                twapGroupId: rawAction.twapGroupId,\n                numberOfParts: rawAction.numberOfParts,\n              }\n            : undefined,\n      };\n\n      return tradeAction;\n    }\n  };\n}\n\nexport function bigNumberify(n?: bigint | string | null | undefined) {\n  try {\n    if (n === undefined) throw new Error(\"n is undefined\");\n    if (n === null) throw new Error(\"n is null\");\n\n    return BigInt(n);\n  } catch (e) {\n    // eslint-disable-next-line no-console\n    console.error(\"bigNumberify error\", e);\n    return undefined;\n  }\n}\n"]}