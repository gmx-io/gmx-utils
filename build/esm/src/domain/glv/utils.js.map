{"version":3,"sources":["../../../../../src/domain/glv/utils.ts"],"names":["market"],"mappings":";;;;AASO,SAAS,4BAAA,CACd,QACA,OAAA,EACA;AACA,EAAA,IAAI,CAAC,OAAA,EAAS;AACZ,IAAA,OAAO,EAAA;AAAA,EACT;AAEA,EAAA,OAAO,OAAA,CAAQ,GAAA;AAAA,IACb,MAAA,CAAO,wBAAA;AAAA,IACP,YAAA;AAAA,MACE,MAAA,CAAO,8BAAA;AAAA,MACP,OAAA,CAAQ,QAAA;AAAA,MACR,QAAQ,MAAA,CAAO;AAAA,KACjB,IAAK;AAAA,GACP;AACF;AAEO,SAAS,oCAAA,CACd,MAAA,EACA,GAAA,EACA,YAAA,EACA,eACA,uBAAA,EASA;AACA,EAAA,MAAM,kBAAA,GAAqB,uBAAA;AAAA,IACzB,YAAA;AAAA,IACA;AAAA,GACF;AACA,EAAA,MAAM,aAAA,GAAgB,8BAAA;AAAA,IACpB,MAAA;AAAA,IACA,GAAA;AAAA,IACA;AAAA,GACF;AAEA,EAAA,OAAO,OAAA,CAAQ,GAAA,CAAI,kBAAA,EAAoB,WAAA,IAAe,IAAI,aAAa,CAAA;AACzE;AAEO,SAAS,8BAAA,CACd,MAAA,EACA,GAAA,EACA,OAAA,EACA;AACA,EAAA,MAAM,YAAA,GACJ,aAAa,MAAA,CAAO,SAAA,EAAW,QAAQ,QAAA,EAAU,OAAA,CAAQ,MAAA,CAAO,QAAQ,CAAA,IACxE,EAAA;AAEF,EAAA,OACE,OAAA,CAAQ,GAAA;AAAA,IACN,MAAA,CAAO,wBAAA;AAAA,IACP,YAAA;AAAA,MACE,MAAA,CAAO,8BAAA;AAAA,MACP,OAAA,CAAQ,QAAA;AAAA,MACR,QAAQ,MAAA,CAAO;AAAA,KACjB,IAAK;AAAA,GACP,GAAI,YAAA;AAER;AAEO,SAAS,kBAAA,CACd,KACA,gBAAA,EACA;AACA,EAAA,MAAM,WAAA,GAAc,GAAA,CAAI,QAAA,CAAS,MAAA,CAAO,QAAA;AAExC,EAAA,MAAM,SAAA,GAAY,OAAO,GAAA,CAAI,OAAO,EAAE,MAAA,CAAO,CAAC,KAAK,MAAA,KAAW;AAC5D,IAAA,MAAM,MAAA,GACJ,OACC,gBAAA,GACG,8BAAA;AAAA,MACE,MAAA;AAAA,MACA,GAAA;AAAA,MACA,gBAAA,CAAiB,OAAO,OAAO;AAAA,KACjC,GACA,EAAA,CAAA;AAEN,IAAA,OAAO,OAAA,CAAQ,GAAA,CAAI,MAAA,EAAQ,EAAE,CAAA;AAAA,EAC/B,GAAG,EAAE,CAAA;AAEL,EAAA,OAAO;AAAA,IACL,gBACE,oBAAA,CAAqB,SAAA,EAAW,IAAI,QAAA,CAAS,QAAA,EAAU,WAAW,CAAA,IAAK,EAAA;AAAA,IACzE,WAAA,EAAa;AAAA,GACf;AACF;AAEO,SAAS,0BAAA,CACd,SACA,WAAA,EACA;AACA,EAAA,MAAM,MAAA,GAAS,QAAQ,OAAA,CAAQ,IAAA;AAAA,IAC7B,CAACA,OAAAA,KAAWA,OAAAA,CAAO,OAAA,KAAY,WAAA,CAAY;AAAA,GAC7C;AAEA,EAAA,IAAI,CAAC,MAAA,EAAQ;AACX,IAAA,OAAO;AAAA,MACL,WAAA,EAAa,EAAA;AAAA,MACb,cAAA,EAAgB;AAAA,KAClB;AAAA,EACF;AAEA,EAAA,MAAM,WAAA,GACJ,YAAA;AAAA,IACE,MAAA,CAAO,SAAA;AAAA,IACP,WAAA,CAAY,QAAA;AAAA,IACZ,YAAY,MAAA,CAAO;AAAA,GACrB,IAAK,EAAA;AACP,EAAA,MAAM,cAAA,GACJ,oBAAA;AAAA,IACE,WAAA;AAAA,IACA,QAAQ,QAAA,CAAS,QAAA;AAAA,IACjB,OAAA,CAAQ,SAAS,MAAA,CAAO;AAAA,GAC1B,IAAK,EAAA;AAEP,EAAA,OAAO;AAAA,IACL,WAAA;AAAA,IACA;AAAA,GACF;AACF;AAEO,SAAS,uBAAA,CACd,GAAA,EACA,WAAA,EACA,UAAA,EACA,sBAAA,EASA;AACA,EAAA,MAAM,WAAA,GAAc,GAAA,CAAI,QAAA,CAAS,MAAA,CAAO,QAAA;AACxC,EAAA,MAAM,SAAA,GAAY,OAAO,GAAA,CAAI,OAAO,EAAE,MAAA,CAAO,CAAC,KAAK,MAAA,KAAW;AAC5D,IAAA,MAAM,UAAA,GAAa,WAAA,GAAc,MAAA,CAAO,OAAO,CAAA;AAE/C,IAAA,IAAI,CAAC,UAAA,IAAc,OAAA,IAAW,UAAA,EAAY;AACxC,MAAA,OAAO,GAAA;AAAA,IACT;AAEA,IAAA,MAAM,WAAA,GAAc,UAAA,GAAa,UAAA,CAAW,kBAAkB,CAAA;AAE9D,IAAA,IAAI,CAAC,WAAA,EAAa;AAChB,MAAA,OAAO,GAAA;AAAA,IACT;AAEA,IAAA,MAAM,iBAAA,GACJ,UAAA,IAAc,UAAA,CAAW,UAAA,EAAY,MAAA,GACjC,yBAAyB,UAAA,EAAY,WAAW,CAAA,EAAG,QAAA,IAAY,EAAA,GAC/D,EAAA;AACN,IAAA,MAAM,YAAA,GACJ,YAAA;AAAA,MACE,MAAA,CAAO,SAAA;AAAA,MACP,WAAA,CAAY,QAAA;AAAA,MACZ,YAAY,MAAA,CAAO;AAAA,KACrB,IAAK,EAAA;AAEP,IAAA,OAAO,GAAA,GAAM,OAAA,CAAQ,GAAA,CAAI,iBAAA,EAAmB,YAAY,CAAA;AAAA,EAC1D,GAAG,EAAE,CAAA;AAEL,EAAA,OAAO;AAAA,IACL,aACE,oBAAA,CAAqB,SAAA,EAAW,IAAI,QAAA,CAAS,QAAA,EAAU,WAAW,CAAA,IAAK,EAAA;AAAA,IACzE,QAAA,EAAU;AAAA,GACZ;AACF;AAEO,SAAS,UAAU,MAAA,EAA6C;AACrE,EAAA,OAAO,OAAA,CAAQ,MAAA,IAAU,OAAA,IAAW,MAAA,IAAW,OAAe,KAAK,CAAA;AACrE;AAEO,SAAS,kBAAkB,GAAA,EAAc;AAC9C,EAAA,OAAO,IAAI,IAAA,KAAS,MAAA,GAAY,CAAA,KAAA,EAAQ,GAAA,CAAI,IAAI,CAAA,CAAA,GAAK,KAAA;AACvD;AAMO,SAAS,sBACd,eAAA,EACoB;AACpB,EAAA,IAAI,CAAC,eAAA,EAAiB;AACpB,IAAA,OAAO,MAAA;AAAA,EACT;AAEA,EAAA,IAAI,SAAA,CAAU,eAAe,CAAA,EAAG;AAC9B,IAAA,OAAO,eAAA,CAAgB,eAAA;AAAA,EACzB;AAEA,EAAA,OAAQ,eAAA,CAA+B,kBAAA;AACzC","file":"utils.js","sourcesContent":["import values from \"lodash/values\";\n\nimport type { MarketInfo } from \"domain/markets/types\";\nimport type { TokenData, TokensData } from \"domain/tokens/types\";\nimport { convertToTokenAmount, convertToUsd } from \"domain/tokens/utils\";\nimport { bigMath } from \"lib/bigmath\";\n\nimport type { GlvInfo, GlvMarket, GlvOrMarketInfo } from \"./types\";\n\nexport function getMaxUsdCapUsdInGmGlvMarket(\n  market: GlvMarket,\n  gmToken?: TokenData\n) {\n  if (!gmToken) {\n    return 0n;\n  }\n\n  return bigMath.min(\n    market.maxMarketTokenBalanceUsd,\n    convertToUsd(\n      market.glvMaxMarketTokenBalanceAmount,\n      gmToken.decimals,\n      gmToken.prices.minPrice\n    ) ?? 0n\n  );\n}\n\nexport function getMaxUsdBuyableAmountInMarketWithGm(\n  market: GlvMarket,\n  glv: GlvInfo,\n  gmMarketInfo: MarketInfo,\n  gmMarketToken: TokenData,\n  getMintableMarketTokens: (\n    marketInfo: MarketInfo,\n    marketToken: TokenData\n  ) =>\n    | {\n        mintableAmount: bigint;\n        mintableUsd: bigint;\n      }\n    | undefined\n) {\n  const mintableInGmMarket = getMintableMarketTokens(\n    gmMarketInfo,\n    gmMarketToken\n  );\n  const maxUsdInGmGlv = getMaxUsdBuyableAmountInMarket(\n    market,\n    glv,\n    gmMarketToken\n  );\n\n  return bigMath.min(mintableInGmMarket?.mintableUsd ?? 0n, maxUsdInGmGlv);\n}\n\nexport function getMaxUsdBuyableAmountInMarket(\n  market: GlvMarket,\n  glv: GlvInfo,\n  gmToken: TokenData\n) {\n  const gmBalanceUsd =\n    convertToUsd(market.gmBalance, gmToken.decimals, gmToken.prices.maxPrice) ??\n    0n;\n\n  return (\n    bigMath.min(\n      market.maxMarketTokenBalanceUsd,\n      convertToUsd(\n        market.glvMaxMarketTokenBalanceAmount,\n        gmToken.decimals,\n        gmToken.prices.maxPrice\n      ) ?? 0n\n    ) - gmBalanceUsd\n  );\n}\n\nexport function getMintableInfoGlv(\n  glv: GlvInfo,\n  marketTokensData: TokensData | undefined\n) {\n  const glvPriceUsd = glv.glvToken.prices.maxPrice;\n\n  const amountUsd = values(glv.markets).reduce((acc, market) => {\n    const result =\n      acc +\n      (marketTokensData\n        ? getMaxUsdBuyableAmountInMarket(\n            market,\n            glv,\n            marketTokensData[market.address]\n          )\n        : 0n);\n\n    return bigMath.max(result, 0n);\n  }, 0n);\n\n  return {\n    mintableAmount:\n      convertToTokenAmount(amountUsd, glv.glvToken.decimals, glvPriceUsd) ?? 0n,\n    mintableUsd: amountUsd,\n  };\n}\n\nexport function getSellableInfoGlvInMarket(\n  glvInfo: GlvInfo,\n  marketToken: TokenData\n) {\n  const market = glvInfo.markets.find(\n    (market) => market.address === marketToken.address\n  );\n\n  if (!market) {\n    return {\n      sellableUsd: 0n,\n      sellableAmount: 0n,\n    };\n  }\n\n  const sellableUsd =\n    convertToUsd(\n      market.gmBalance,\n      marketToken.decimals,\n      marketToken.prices.minPrice\n    ) ?? 0n;\n  const sellableAmount =\n    convertToTokenAmount(\n      sellableUsd,\n      glvInfo.glvToken.decimals,\n      glvInfo.glvToken.prices.minPrice\n    ) ?? 0n;\n\n  return {\n    sellableUsd,\n    sellableAmount,\n  };\n}\n\nexport function getTotalSellableInfoGlv(\n  glv: GlvInfo,\n  marketsData: Record<string, MarketInfo | GlvInfo> | undefined,\n  tokensData: TokensData | undefined,\n  getSellableMarketToken: (\n    marketInfo: MarketInfo,\n    marketToken: TokenData\n  ) =>\n    | {\n        totalUsd: bigint;\n        totalAmount: bigint;\n      }\n    | undefined\n) {\n  const glvPriceUsd = glv.glvToken.prices.minPrice;\n  const amountUsd = values(glv.markets).reduce((acc, market) => {\n    const marketInfo = marketsData?.[market.address] as MarketInfo | undefined;\n\n    if (!marketInfo || \"isGlv\" in marketInfo) {\n      return acc;\n    }\n\n    const marketToken = tokensData?.[marketInfo.marketTokenAddress];\n\n    if (!marketToken) {\n      return acc;\n    }\n\n    const marketSellableUsd =\n      marketInfo && marketInfo.indexToken?.prices\n        ? getSellableMarketToken?.(marketInfo, marketToken)?.totalUsd ?? 0n\n        : 0n;\n    const gmBalanceUsd =\n      convertToUsd(\n        market.gmBalance,\n        marketToken.decimals,\n        marketToken.prices.minPrice\n      ) ?? 0n;\n\n    return acc + bigMath.min(marketSellableUsd, gmBalanceUsd);\n  }, 0n);\n\n  return {\n    totalAmount:\n      convertToTokenAmount(amountUsd, glv.glvToken.decimals, glvPriceUsd) ?? 0n,\n    totalUsd: amountUsd,\n  };\n}\n\nexport function isGlvInfo(market?: GlvOrMarketInfo): market is GlvInfo {\n  return Boolean(market && \"isGlv\" in market && (market as any).isGlv);\n}\n\nexport function getGlvDisplayName(glv: GlvInfo) {\n  return glv.name !== undefined ? `GLV: ${glv.name}` : \"GLV\";\n}\n\nexport function getGlvOrMarketAddress(\n  marketOrGlvInfo: MarketInfo | GlvInfo\n): string;\nexport function getGlvOrMarketAddress(marketOrGlvInfo?: undefined): undefined;\nexport function getGlvOrMarketAddress(\n  marketOrGlvInfo?: GlvOrMarketInfo\n): string | undefined {\n  if (!marketOrGlvInfo) {\n    return undefined;\n  }\n\n  if (isGlvInfo(marketOrGlvInfo)) {\n    return marketOrGlvInfo.glvTokenAddress;\n  }\n\n  return (marketOrGlvInfo as MarketInfo).marketTokenAddress;\n}\n"]}