{"version":3,"sources":["../../../../../src/domain/positions/utils.ts"],"names":[],"mappings":"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","file":"utils.js","sourcesContent":["import {\n  capPositionImpactUsdByMaxImpactPool,\n  capPositionImpactUsdByMaxPriceImpactFactor,\n  getMaxPositionImpactFactors,\n  getPositionFee,\n  getPriceImpactForPosition,\n  getProportionalPendingImpactValues,\n} from \"domain/executionFee\";\nimport { MarketInfo } from \"domain/markets/types\";\nimport {\n  getCappedPoolPnl,\n  getMarketPnl,\n  getOpenInterestUsd,\n  getPoolUsdWithoutPnl,\n} from \"domain/markets/utils\";\nimport { UserReferralInfo } from \"domain/referrals/types\";\nimport { Token, TokenData } from \"domain/tokens/types\";\nimport { convertToUsd } from \"domain/tokens/utils\";\nimport { getIsEquivalentTokens } from \"domain/tokens/utils\";\nimport { bigMath } from \"lib/bigmath\";\nimport { BASIS_POINTS_DIVISOR_BIGINT } from \"lib/numbers\";\nimport { applyFactor, expandDecimals, PRECISION } from \"lib/numbers\";\n\nimport { PositionInfoLoaded } from \"./types\";\n\nexport function getPositionKey(\n  account: string,\n  marketAddress: string,\n  collateralAddress: string,\n  isLong: boolean\n) {\n  return `${account}:${marketAddress}:${collateralAddress}:${isLong}`;\n}\n\nexport function parsePositionKey(positionKey: string) {\n  const [account, marketAddress, collateralAddress, isLong] =\n    positionKey.split(\":\");\n\n  return {\n    account,\n    marketAddress,\n    collateralAddress,\n    isLong: isLong === \"true\",\n  };\n}\n\nexport function getEntryPrice(p: {\n  sizeInUsd: bigint;\n  sizeInTokens: bigint;\n  indexToken: Token;\n}) {\n  const { sizeInUsd, sizeInTokens, indexToken } = p;\n\n  if (sizeInTokens <= 0) {\n    return undefined;\n  }\n\n  return bigMath.mulDiv(\n    sizeInUsd,\n    expandDecimals(1, indexToken.decimals),\n    sizeInTokens\n  );\n}\n\nexport function getPositionPnlUsd(p: {\n  marketInfo: MarketInfo;\n  sizeInUsd: bigint;\n  sizeInTokens: bigint;\n  markPrice: bigint;\n  isLong: boolean;\n}) {\n  const { marketInfo, sizeInUsd, sizeInTokens, markPrice, isLong } = p;\n\n  const positionValueUsd = getPositionValueUsd({\n    indexToken: marketInfo.indexToken,\n    sizeInTokens,\n    markPrice,\n  });\n\n  let totalPnl = isLong\n    ? positionValueUsd - sizeInUsd\n    : sizeInUsd - positionValueUsd;\n\n  if (totalPnl <= 0) {\n    return totalPnl;\n  }\n\n  const poolPnl = getMarketPnl(marketInfo, isLong, true);\n  const poolUsd = getPoolUsdWithoutPnl(marketInfo, isLong, \"minPrice\");\n\n  const cappedPnl = getCappedPoolPnl({\n    marketInfo,\n    poolUsd,\n    poolPnl,\n    isLong,\n  });\n\n  const WEI_PRECISION = expandDecimals(1, 18);\n\n  if (cappedPnl !== poolPnl && cappedPnl > 0 && poolPnl > 0) {\n    totalPnl = bigMath.mulDiv(\n      totalPnl,\n      cappedPnl / WEI_PRECISION,\n      poolPnl / WEI_PRECISION\n    );\n  }\n\n  return totalPnl;\n}\n\nexport function getPositionValueUsd(p: {\n  indexToken: Token;\n  sizeInTokens: bigint;\n  markPrice: bigint;\n}) {\n  const { indexToken, sizeInTokens, markPrice } = p;\n\n  return convertToUsd(sizeInTokens, indexToken.decimals, markPrice)!;\n}\n\nexport function getPositionPendingFeesUsd(p: {\n  pendingFundingFeesUsd: bigint;\n  pendingBorrowingFeesUsd: bigint;\n}) {\n  const { pendingFundingFeesUsd, pendingBorrowingFeesUsd } = p;\n\n  return pendingBorrowingFeesUsd + pendingFundingFeesUsd;\n}\n\nexport function getPositionNetValue(p: {\n  totalPendingImpactDeltaUsd: bigint;\n  priceImpactDiffUsd: bigint;\n  collateralUsd: bigint;\n  pendingFundingFeesUsd: bigint;\n  pendingBorrowingFeesUsd: bigint;\n  pnl: bigint;\n  closingFeeUsd: bigint;\n  uiFeeUsd: bigint;\n}) {\n  const {\n    pnl,\n    closingFeeUsd,\n    collateralUsd,\n    uiFeeUsd,\n    totalPendingImpactDeltaUsd,\n    priceImpactDiffUsd,\n  } = p;\n\n  const pendingFeesUsd = getPositionPendingFeesUsd(p);\n\n  return (\n    collateralUsd -\n    pendingFeesUsd -\n    closingFeeUsd -\n    uiFeeUsd +\n    pnl +\n    totalPendingImpactDeltaUsd +\n    priceImpactDiffUsd\n  );\n}\n\nexport function getPositionPnlAfterFees({\n  pnl,\n  pendingBorrowingFeesUsd,\n  pendingFundingFeesUsd,\n  closingFeeUsd,\n  uiFeeUsd,\n  totalPendingImpactDeltaUsd,\n  priceImpactDiffUsd,\n}: {\n  pnl: bigint;\n  pendingBorrowingFeesUsd: bigint;\n  pendingFundingFeesUsd: bigint;\n  closingFeeUsd: bigint;\n  uiFeeUsd: bigint;\n  totalPendingImpactDeltaUsd: bigint;\n  priceImpactDiffUsd: bigint;\n}) {\n  const pnlAfterFees =\n    pnl -\n    pendingBorrowingFeesUsd -\n    pendingFundingFeesUsd -\n    closingFeeUsd -\n    uiFeeUsd +\n    totalPendingImpactDeltaUsd +\n    priceImpactDiffUsd;\n\n  return pnlAfterFees;\n}\n\nexport function getLeverage(p: {\n  sizeInUsd: bigint;\n  collateralUsd: bigint;\n  pnl: bigint | undefined;\n  pendingFundingFeesUsd: bigint;\n  pendingBorrowingFeesUsd: bigint;\n}) {\n  const {\n    pnl,\n    sizeInUsd,\n    collateralUsd,\n    pendingBorrowingFeesUsd,\n    pendingFundingFeesUsd,\n  } = p;\n\n  const totalPendingFeesUsd = getPositionPendingFeesUsd({\n    pendingFundingFeesUsd,\n    pendingBorrowingFeesUsd,\n  });\n\n  const remainingCollateralUsd =\n    collateralUsd + (pnl ?? 0n) - totalPendingFeesUsd;\n\n  if (remainingCollateralUsd <= 0) {\n    return undefined;\n  }\n\n  return bigMath.mulDiv(\n    sizeInUsd,\n    BASIS_POINTS_DIVISOR_BIGINT,\n    remainingCollateralUsd\n  );\n}\n\nexport function getLiquidationPrice(p: {\n  sizeInUsd: bigint;\n  sizeInTokens: bigint;\n  collateralAmount: bigint;\n  collateralUsd: bigint;\n  collateralToken: TokenData;\n  marketInfo: MarketInfo;\n  pendingFundingFeesUsd: bigint;\n  pendingBorrowingFeesUsd: bigint;\n  pendingImpactAmount: bigint;\n  minCollateralUsd: bigint;\n  isLong: boolean;\n  useMaxPriceImpact?: boolean;\n  userReferralInfo: UserReferralInfo | undefined;\n}) {\n  const {\n    sizeInUsd,\n    sizeInTokens,\n    collateralUsd,\n    collateralAmount,\n    marketInfo,\n    collateralToken,\n    pendingFundingFeesUsd,\n    pendingBorrowingFeesUsd,\n    pendingImpactAmount,\n    minCollateralUsd,\n    isLong,\n    userReferralInfo,\n    useMaxPriceImpact,\n  } = p;\n\n  if (sizeInUsd <= 0 || sizeInTokens <= 0) {\n    return undefined;\n  }\n\n  const { indexToken } = marketInfo;\n\n  const closingFeeUsd = getPositionFee(\n    marketInfo,\n    sizeInUsd,\n    false,\n    userReferralInfo\n  ).positionFeeUsd;\n  const totalPendingFeesUsd = getPositionPendingFeesUsd({\n    pendingFundingFeesUsd,\n    pendingBorrowingFeesUsd,\n  });\n  const totalFeesUsd = totalPendingFeesUsd + closingFeeUsd;\n\n  const maxNegativePriceImpactUsd =\n    -1n *\n    applyFactor(sizeInUsd, marketInfo.maxPositionImpactFactorForLiquidations);\n\n  let priceImpactDeltaUsd = 0n;\n\n  if (useMaxPriceImpact) {\n    priceImpactDeltaUsd = maxNegativePriceImpactUsd;\n  } else {\n    const priceImpactForPosition = getPriceImpactForPosition(\n      marketInfo,\n      -sizeInUsd,\n      isLong,\n      { fallbackToZero: true }\n    );\n    priceImpactDeltaUsd = priceImpactForPosition.priceImpactDeltaUsd;\n\n    if (priceImpactDeltaUsd > 0) {\n      priceImpactDeltaUsd = capPositionImpactUsdByMaxPriceImpactFactor(\n        marketInfo,\n        sizeInUsd,\n        priceImpactDeltaUsd\n      );\n    }\n\n    const pendingImpactUsd = convertToUsd(\n      pendingImpactAmount,\n      marketInfo.indexToken.decimals,\n      pendingImpactAmount > 0\n        ? marketInfo.indexToken.prices.minPrice\n        : marketInfo.indexToken.prices.maxPrice\n    )!;\n\n    priceImpactDeltaUsd = priceImpactDeltaUsd + pendingImpactUsd;\n\n    if (priceImpactDeltaUsd > 0) {\n      priceImpactDeltaUsd = 0n;\n    } else if (priceImpactDeltaUsd < maxNegativePriceImpactUsd) {\n      priceImpactDeltaUsd = maxNegativePriceImpactUsd;\n    }\n  }\n\n  let liquidationCollateralUsd = applyFactor(\n    sizeInUsd,\n    marketInfo.minCollateralFactorForLiquidation\n  );\n  if (liquidationCollateralUsd < minCollateralUsd) {\n    liquidationCollateralUsd = minCollateralUsd;\n  }\n\n  let liquidationPrice: bigint;\n\n  if (getIsEquivalentTokens(collateralToken, indexToken)) {\n    if (isLong) {\n      const denominator = sizeInTokens + collateralAmount;\n\n      if (denominator == 0n) {\n        return undefined;\n      }\n\n      liquidationPrice =\n        ((sizeInUsd +\n          liquidationCollateralUsd -\n          priceImpactDeltaUsd +\n          totalFeesUsd) /\n          denominator) *\n        expandDecimals(1, indexToken.decimals);\n    } else {\n      const denominator = sizeInTokens - collateralAmount;\n\n      if (denominator == 0n) {\n        return undefined;\n      }\n\n      liquidationPrice =\n        ((sizeInUsd -\n          liquidationCollateralUsd +\n          priceImpactDeltaUsd -\n          totalFeesUsd) /\n          denominator) *\n        expandDecimals(1, indexToken.decimals);\n    }\n  } else {\n    if (sizeInTokens == 0n) {\n      return undefined;\n    }\n\n    const remainingCollateralUsd =\n      collateralUsd + priceImpactDeltaUsd - totalPendingFeesUsd - closingFeeUsd;\n\n    if (isLong) {\n      liquidationPrice =\n        ((liquidationCollateralUsd - remainingCollateralUsd + sizeInUsd) /\n          sizeInTokens) *\n        expandDecimals(1, indexToken.decimals);\n    } else {\n      liquidationPrice =\n        ((liquidationCollateralUsd - remainingCollateralUsd - sizeInUsd) /\n          -sizeInTokens) *\n        expandDecimals(1, indexToken.decimals);\n    }\n  }\n\n  if (liquidationPrice <= 0) {\n    return undefined;\n  }\n\n  return liquidationPrice;\n}\n\nexport function getNetPriceImpactDeltaUsdForDecrease({\n  marketInfo,\n  sizeInUsd,\n  pendingImpactAmount,\n  priceImpactDeltaUsd,\n  sizeDeltaUsd,\n}: {\n  marketInfo: MarketInfo;\n  sizeInUsd: bigint;\n  pendingImpactAmount: bigint;\n  sizeDeltaUsd: bigint;\n  priceImpactDeltaUsd: bigint;\n}) {\n  const { proportionalPendingImpactDeltaUsd } =\n    getProportionalPendingImpactValues({\n      sizeInUsd,\n      sizeDeltaUsd,\n      pendingImpactAmount,\n      indexToken: marketInfo.indexToken,\n    });\n\n  let totalImpactDeltaUsd =\n    priceImpactDeltaUsd + proportionalPendingImpactDeltaUsd;\n\n  const priceImpactDiffUsd = getPriceImpactDiffUsd({\n    totalImpactDeltaUsd,\n    marketInfo,\n    sizeDeltaUsd,\n  });\n\n  if (totalImpactDeltaUsd > 0) {\n    totalImpactDeltaUsd = capPositionImpactUsdByMaxPriceImpactFactor(\n      marketInfo,\n      sizeDeltaUsd,\n      totalImpactDeltaUsd\n    );\n  }\n\n  totalImpactDeltaUsd = capPositionImpactUsdByMaxImpactPool(\n    marketInfo,\n    totalImpactDeltaUsd\n  );\n\n  return {\n    totalImpactDeltaUsd,\n    proportionalPendingImpactDeltaUsd,\n    priceImpactDiffUsd,\n  };\n}\n\nexport function getPriceImpactDiffUsd({\n  totalImpactDeltaUsd,\n  marketInfo,\n  sizeDeltaUsd,\n}: {\n  totalImpactDeltaUsd: bigint;\n  marketInfo: MarketInfo;\n  sizeDeltaUsd: bigint;\n}) {\n  if (totalImpactDeltaUsd > 0) {\n    return 0n;\n  }\n\n  const { maxNegativeImpactFactor } = getMaxPositionImpactFactors(marketInfo);\n\n  const maxNegativeImpactUsd = -applyFactor(\n    sizeDeltaUsd,\n    maxNegativeImpactFactor\n  );\n\n  let priceImpactDiffUsd = 0n;\n\n  if (totalImpactDeltaUsd < maxNegativeImpactUsd) {\n    priceImpactDiffUsd = maxNegativeImpactUsd - totalImpactDeltaUsd;\n  }\n\n  return priceImpactDiffUsd;\n}\n\nexport function getMinCollateralFactorForPosition(\n  position: PositionInfoLoaded,\n  openInterestDelta: bigint\n) {\n  const marketInfo = position.marketInfo;\n\n  const isLong = position.isLong;\n  const openInterest =\n    getOpenInterestUsd(marketInfo, isLong) + openInterestDelta;\n  const minCollateralFactorMultiplier = isLong\n    ? marketInfo.minCollateralFactorForOpenInterestLong\n    : marketInfo.minCollateralFactorForOpenInterestShort;\n  let minCollateralFactor = bigMath.mulDiv(\n    openInterest,\n    minCollateralFactorMultiplier,\n    PRECISION\n  );\n  const minCollateralFactorForMarket = marketInfo.minCollateralFactor;\n\n  if (minCollateralFactorForMarket > minCollateralFactor) {\n    minCollateralFactor = minCollateralFactorForMarket;\n  }\n\n  return minCollateralFactor;\n}\n"]}