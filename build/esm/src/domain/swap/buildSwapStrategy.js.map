{"version":3,"sources":["../../../../../src/domain/swap/buildSwapStrategy.ts"],"names":["findSwapPath","swapPathStats"],"mappings":"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","file":"buildSwapStrategy.js","sourcesContent":["import { getAvailableExternalSwapPaths } from \"domain/externalSwap/externalSwapPath\";\nimport { getExternalSwapQuoteByPath } from \"domain/externalSwap/externalSwapQuoteByPath\";\nimport { ExternalSwapQuoteParams } from \"domain/externalSwap/types\";\nimport { MarketsInfoData } from \"domain/markets/types\";\nimport { SwapStrategyForSwapOrders } from \"domain/swap/types\";\nimport { SwapOptimizationOrderArray } from \"domain/swap/types\";\nimport { TokenData } from \"domain/tokens/types\";\nimport {\n  convertToTokenAmount,\n  convertToUsd,\n  getIsEquivalentTokens,\n  getIsStake,\n  getIsUnstake,\n  getMidPrice,\n} from \"domain/tokens/utils\";\nimport { bigMath } from \"lib/bigmath\";\n\n\nimport { createFindSwapPath } from \"./swapPath\";\n\n/*\n  Order/Priority of getting swap strategy:\n  1. Check if it needs a swap and return noSwap if tokens are equivalent, stake or unstake [noSwap]\n  2. Check if there is a swap path stats for the internal swap quote and return internalSwap if there is [internalSwap]\n  3. Check if there is a combined swap strategy and return combinedSwap if there is [combinedSwap]\n  4. Return defaultSwapStrategy (noSwap) if there is no other swap strategy [noSwap]\n*/\n\nexport function buildSwapStrategy({\n  amountIn,\n  tokenIn,\n  tokenOut,\n  marketsInfoData,\n  chainId,\n  swapOptimizationOrder,\n  externalSwapQuoteParams,\n}: {\n  chainId: number;\n  amountIn: bigint;\n  tokenIn: TokenData;\n  tokenOut: TokenData;\n  marketsInfoData: MarketsInfoData | undefined;\n  swapOptimizationOrder: SwapOptimizationOrderArray | undefined;\n  externalSwapQuoteParams: ExternalSwapQuoteParams;\n}): SwapStrategyForSwapOrders {\n  const priceIn = tokenIn.prices.minPrice;\n  const usdIn = convertToUsd(amountIn, tokenIn.decimals, priceIn)!;\n\n  if (amountIn < 0n) {\n    amountIn = 0n;\n  }\n\n  const defaultSwapStrategy: SwapStrategyForSwapOrders = {\n    type: \"noSwap\",\n    externalSwapQuote: undefined,\n    swapPathStats: undefined,\n    amountIn,\n    amountOut: convertToTokenAmount(\n      usdIn,\n      tokenOut.decimals,\n      tokenOut.prices.maxPrice\n    )!,\n    usdIn,\n    usdOut: usdIn,\n    priceIn,\n    priceOut: tokenOut.prices.maxPrice,\n    feesUsd: 0n,\n  };\n\n  if (\n    getIsEquivalentTokens(tokenIn, tokenOut) ||\n    getIsStake(tokenIn, tokenOut) ||\n    getIsUnstake(tokenIn, tokenOut)\n  ) {\n    return defaultSwapStrategy;\n  }\n\n  const findSwapPath = createFindSwapPath({\n    chainId,\n    fromTokenAddress: tokenIn.address,\n    toTokenAddress: tokenOut.address,\n    marketsInfoData,\n    isExpressFeeSwap: false,\n  });\n\n  const swapPathStats = findSwapPath(usdIn, { order: swapOptimizationOrder });\n\n  if (swapPathStats) {\n    return {\n      type: \"internalSwap\",\n      swapPathStats,\n      externalSwapQuote: undefined,\n      amountIn,\n      amountOut: swapPathStats.amountOut,\n      usdIn: usdIn,\n      usdOut: swapPathStats.usdOut,\n      priceIn: priceIn,\n      priceOut: tokenOut.prices.maxPrice,\n      feesUsd: usdIn - swapPathStats.usdOut,\n    };\n  }\n\n  const availableExternalSwapPaths = getAvailableExternalSwapPaths({\n    chainId,\n    fromTokenAddress: tokenIn.address,\n  });\n\n  const suitableSwapPath = availableExternalSwapPaths.find((path) => {\n    const findSwapPath = createFindSwapPath({\n      chainId,\n      fromTokenAddress: path.outTokenAddress,\n      toTokenAddress: tokenOut.address,\n      marketsInfoData,\n      isExpressFeeSwap: false,\n    });\n\n    const swapPathStats = findSwapPath(usdIn);\n\n    return Boolean(swapPathStats);\n  });\n\n  if (\n    suitableSwapPath &&\n    suitableSwapPath.outTokenAddress !== tokenOut.address\n  ) {\n    const externalSwapQuoteForCombinedSwap = getExternalSwapQuoteByPath({\n      amountIn,\n      externalSwapPath: suitableSwapPath,\n      externalSwapQuoteParams,\n    });\n    const findSwapPathForSuitableSwapPath = createFindSwapPath({\n      chainId,\n      fromTokenAddress: suitableSwapPath.outTokenAddress,\n      toTokenAddress: tokenOut.address,\n      marketsInfoData,\n      isExpressFeeSwap: false,\n    });\n\n    const swapPathStatsForCombinedSwap = externalSwapQuoteForCombinedSwap\n      ? findSwapPathForSuitableSwapPath(externalSwapQuoteForCombinedSwap.usdOut)\n      : undefined;\n\n    return externalSwapQuoteForCombinedSwap && swapPathStatsForCombinedSwap\n      ? {\n          type: \"combinedSwap\",\n          externalSwapQuote: externalSwapQuoteForCombinedSwap,\n          swapPathStats: swapPathStatsForCombinedSwap,\n          amountIn,\n          amountOut: swapPathStatsForCombinedSwap.amountOut,\n          usdIn: externalSwapQuoteForCombinedSwap.usdIn,\n          usdOut: swapPathStatsForCombinedSwap.usdOut,\n          priceIn: externalSwapQuoteForCombinedSwap.priceIn,\n          priceOut: tokenOut.prices.maxPrice,\n          feesUsd:\n            externalSwapQuoteForCombinedSwap.usdIn -\n            swapPathStatsForCombinedSwap.usdOut,\n        }\n      : defaultSwapStrategy;\n  }\n\n  return defaultSwapStrategy;\n}\n\n// Used for getting swap amounts by to value\nexport function buildReverseSwapStrategy({\n  amountOut,\n  tokenIn,\n  tokenOut,\n  marketsInfoData,\n  chainId,\n  externalSwapQuoteParams,\n  swapOptimizationOrder,\n}: {\n  chainId: number;\n  amountOut: bigint;\n  tokenIn: TokenData;\n  tokenOut: TokenData;\n  marketsInfoData: MarketsInfoData | undefined;\n  externalSwapQuoteParams: ExternalSwapQuoteParams;\n  swapOptimizationOrder: SwapOptimizationOrderArray | undefined;\n}): SwapStrategyForSwapOrders {\n  const priceIn = getMidPrice(tokenIn.prices);\n  const priceOut = getMidPrice(tokenOut.prices);\n\n  const preferredUsdOut = convertToUsd(\n    amountOut,\n    tokenOut.decimals,\n    getMidPrice(tokenOut.prices)\n  )!;\n  const approximateAmountIn = convertToTokenAmount(\n    preferredUsdOut,\n    tokenIn.decimals,\n    getMidPrice(tokenIn.prices)\n  )!;\n  const approximateUsdIn = preferredUsdOut;\n\n  const defaultSwapStrategy: SwapStrategyForSwapOrders = {\n    type: \"noSwap\",\n    externalSwapQuote: undefined,\n    swapPathStats: undefined,\n    amountIn: approximateAmountIn,\n    amountOut: amountOut,\n    usdIn: approximateUsdIn,\n    usdOut: preferredUsdOut,\n    priceIn,\n    priceOut,\n    feesUsd: 0n,\n  };\n\n  if (\n    getIsEquivalentTokens(tokenIn, tokenOut) ||\n    getIsStake(tokenIn, tokenOut) ||\n    getIsUnstake(tokenIn, tokenOut)\n  ) {\n    return defaultSwapStrategy;\n  }\n\n  const findSwapPath = createFindSwapPath({\n    chainId,\n    fromTokenAddress: tokenIn.address,\n    toTokenAddress: tokenOut.address,\n    marketsInfoData,\n    isExpressFeeSwap: false,\n  });\n\n  const approximateSwapPathStats = findSwapPath(approximateUsdIn, {\n    order: swapOptimizationOrder,\n  });\n\n  if (approximateSwapPathStats) {\n    // Increase or decrease usdIn the same way preferred usdOut is different from swapStrategy.usdOut\n    // preferred_in / approximate_in = preferred_out / approximate_out\n    // preferred_in = approximate_in * preferred_out / approximate_out\n    const adjustedUsdIn =\n      approximateSwapPathStats.usdOut > 0\n        ? bigMath.mulDiv(\n            approximateUsdIn,\n            preferredUsdOut,\n            approximateSwapPathStats.usdOut\n          )\n        : 0n;\n    const adjustedAmountIn = convertToTokenAmount(\n      adjustedUsdIn,\n      tokenIn.decimals,\n      getMidPrice(tokenIn.prices)\n    )!;\n\n    const adjustedSwapPathStats = findSwapPath(adjustedUsdIn, {\n      order: swapOptimizationOrder,\n    });\n\n    if (adjustedSwapPathStats) {\n      return {\n        type: \"internalSwap\",\n        swapPathStats: adjustedSwapPathStats,\n        externalSwapQuote: undefined,\n        amountIn: adjustedAmountIn,\n        amountOut: adjustedSwapPathStats.amountOut,\n        usdIn: adjustedUsdIn,\n        usdOut: adjustedSwapPathStats.usdOut,\n        priceIn: priceIn,\n        priceOut: priceOut,\n        feesUsd: adjustedUsdIn - adjustedSwapPathStats.usdOut,\n      };\n    }\n  }\n\n  const availableExternalSwapPaths = getAvailableExternalSwapPaths({\n    chainId,\n    fromTokenAddress: tokenIn.address,\n  });\n\n  const suitableSwapPath = availableExternalSwapPaths.find((path) => {\n    if (path.outTokenAddress !== tokenOut.address) return false;\n\n    const findSwapPath = createFindSwapPath({\n      chainId,\n      fromTokenAddress: tokenIn.address,\n      toTokenAddress: path.inTokenAddress,\n      marketsInfoData,\n      isExpressFeeSwap: false,\n    });\n\n    const swapPathStats = findSwapPath(approximateUsdIn);\n\n    return Boolean(swapPathStats);\n  });\n\n  if (suitableSwapPath) {\n    const approximateExternalSwapQuoteForCombinedSwap =\n      getExternalSwapQuoteByPath({\n        amountIn: approximateAmountIn,\n        externalSwapPath: suitableSwapPath,\n        externalSwapQuoteParams,\n      });\n\n    if (!approximateExternalSwapQuoteForCombinedSwap) {\n      return defaultSwapStrategy;\n    }\n\n    const findSwapPathForSuitableSwapPath = createFindSwapPath({\n      chainId,\n      fromTokenAddress: tokenIn.address,\n      toTokenAddress: suitableSwapPath.inTokenAddress,\n      marketsInfoData,\n      isExpressFeeSwap: false,\n    });\n\n    const approximateSwapPathStatsForCombinedSwap =\n      findSwapPathForSuitableSwapPath(\n        approximateExternalSwapQuoteForCombinedSwap.usdOut\n      );\n\n    if (!approximateSwapPathStatsForCombinedSwap) {\n      return defaultSwapStrategy;\n    }\n\n    const adjustedUsdIn =\n      approximateSwapPathStatsForCombinedSwap.usdOut > 0\n        ? bigMath.mulDiv(\n            approximateUsdIn,\n            preferredUsdOut,\n            approximateSwapPathStatsForCombinedSwap.usdOut\n          )\n        : 0n;\n\n    const adjustedAmountIn = convertToTokenAmount(\n      adjustedUsdIn,\n      tokenIn.decimals,\n      getMidPrice(tokenIn.prices)\n    )!;\n\n    const adjustedExternalSwapQuoteForCombinedSwap = getExternalSwapQuoteByPath(\n      {\n        amountIn: adjustedAmountIn,\n        externalSwapPath: suitableSwapPath,\n        externalSwapQuoteParams,\n      }\n    );\n\n    if (!adjustedExternalSwapQuoteForCombinedSwap) {\n      return defaultSwapStrategy;\n    }\n\n    const adjustedSwapPathStatsForCombinedSwap =\n      findSwapPathForSuitableSwapPath(\n        adjustedExternalSwapQuoteForCombinedSwap.usdOut\n      );\n\n    if (!adjustedSwapPathStatsForCombinedSwap) {\n      return defaultSwapStrategy;\n    }\n\n    return {\n      type: \"combinedSwap\",\n      externalSwapQuote: adjustedExternalSwapQuoteForCombinedSwap,\n      swapPathStats: adjustedSwapPathStatsForCombinedSwap,\n      amountIn: adjustedAmountIn,\n      amountOut: adjustedSwapPathStatsForCombinedSwap.amountOut,\n      usdIn: adjustedExternalSwapQuoteForCombinedSwap.usdIn,\n      usdOut: adjustedSwapPathStatsForCombinedSwap.usdOut,\n      priceIn: adjustedExternalSwapQuoteForCombinedSwap.priceIn,\n      priceOut: priceOut,\n      feesUsd:\n        adjustedExternalSwapQuoteForCombinedSwap.usdIn -\n        adjustedSwapPathStatsForCombinedSwap.usdOut,\n    };\n  }\n\n  return defaultSwapStrategy;\n}\n"]}