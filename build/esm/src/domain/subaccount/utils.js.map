{"version":3,"sources":["../../../../../src/domain/subaccount/utils.ts"],"names":[],"mappings":"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","file":"utils.js","sourcesContent":["import {\n  encodeAbiParameters,\n  keccak256,\n  maxUint256,\n  zeroAddress,\n  zeroHash,\n  type PublicClient,\n} from \"viem\";\n\nimport { abis } from \"abis\";\nimport type { AnyChainId, ContractsChainId } from \"configs/chains\";\nimport { getContract } from \"configs/contracts\";\nimport {\n  SUBACCOUNT_ORDER_ACTION,\n  maxAllowedSubaccountActionCountKey,\n  subaccountActionCountKey,\n  subaccountExpiresAtKey,\n  subaccountIntegrationIdKey,\n  subaccountListKey,\n} from \"configs/dataStore\";\nimport { isSourceChain } from \"configs/multichain\";\nimport { bigMath } from \"lib/bigmath\";\nimport { ZERO_DATA } from \"lib/hash\";\nimport { nowInSeconds } from \"lib/time\";\n\nimport type {\n  SignedSubaccountApproval,\n  Subaccount,\n  SubaccountApproval,\n  SubaccountOnchainData,\n  SubaccountValidations,\n} from \"./types\";\n\nexport function getSubaccountValidations({\n  requiredActions,\n  subaccount,\n  subaccountRouterAddress,\n}: {\n  requiredActions: number;\n  subaccount: Subaccount;\n  subaccountRouterAddress: string;\n}): SubaccountValidations {\n  return {\n    isExpired: getIsSubaccountExpired(subaccount),\n    isActionsExceeded: getIsSubaccountActionsExceeded(\n      subaccount,\n      requiredActions\n    ),\n    isNonceExpired: getIsSubaccountNonceExpired(subaccount),\n    isApprovalInvalid: getIsSubaccountApprovalInvalid({\n      chainId: subaccount.chainId,\n      signerChainId: subaccount.signerChainId,\n      onchainData: subaccount.onchainData,\n      signedApproval: subaccount.signedApproval,\n      subaccountRouterAddress,\n    }),\n    isValid: !getIsInvalidSubaccount({\n      subaccount,\n      requiredActions,\n      subaccountRouterAddress,\n    }),\n  };\n}\n\nexport function getMaxSubaccountActions(subaccount: {\n  onchainData: SubaccountOnchainData;\n  signedApproval: SignedSubaccountApproval | undefined;\n}): bigint {\n  if (\n    subaccount.signedApproval &&\n    !getIsEmptySubaccountApproval(subaccount.signedApproval)\n  ) {\n    return BigInt(subaccount.signedApproval.maxAllowedCount);\n  }\n\n  return subaccount.onchainData.maxAllowedCount;\n}\n\nexport function getSubaccountExpiresAt(subaccount: {\n  onchainData: SubaccountOnchainData;\n  signedApproval: SignedSubaccountApproval | undefined;\n}): bigint {\n  if (\n    subaccount.signedApproval &&\n    !getIsEmptySubaccountApproval(subaccount.signedApproval)\n  ) {\n    return BigInt(subaccount.signedApproval.expiresAt);\n  }\n\n  return subaccount.onchainData.expiresAt;\n}\n\nexport function getRemainingSubaccountActions(subaccount: {\n  onchainData: SubaccountOnchainData;\n  signedApproval: SignedSubaccountApproval | undefined;\n}): bigint {\n  const maxAllowedCount = getMaxSubaccountActions(subaccount);\n  const currentActionCount = subaccount.onchainData.currentActionsCount;\n\n  return maxAllowedCount - currentActionCount;\n}\n\nexport function getIsApprovalDeadlineExpired(\n  approval: SubaccountApproval\n): boolean {\n  const now = BigInt(nowInSeconds());\n  const deadline = approval.deadline;\n\n  return now >= deadline;\n}\n\nexport function getIsSubaccountActionsExceeded(\n  subaccount: Subaccount,\n  requiredActions: number\n) {\n  return (\n    getRemainingSubaccountActions(subaccount) <\n    bigMath.max(1n, BigInt(requiredActions))\n  );\n}\n\nexport function getRemainingSubaccountSeconds(subaccount: Subaccount): bigint {\n  const expiresAt = getSubaccountExpiresAt(subaccount);\n\n  const now = BigInt(nowInSeconds());\n\n  return bigMath.max(0n, expiresAt - now);\n}\n\nexport function getIsApprovalExpired(subaccount: Subaccount): boolean {\n  const { signedApproval } = subaccount;\n\n  if (getIsEmptySubaccountApproval(signedApproval)) {\n    return false;\n  }\n\n  const now = BigInt(nowInSeconds());\n\n  const expiresAt = signedApproval.expiresAt;\n  const deadline = signedApproval.deadline;\n\n  return now >= expiresAt || now >= deadline;\n}\n\nexport function getIsSubaccountNonceExpired({\n  chainId,\n  onchainData,\n  signedApproval,\n}: {\n  chainId: ContractsChainId;\n  onchainData: SubaccountOnchainData;\n  signedApproval: SignedSubaccountApproval;\n}): boolean {\n  if (getIsEmptySubaccountApproval(signedApproval)) {\n    return false;\n  }\n\n  if (chainId !== signedApproval.signatureChainId) {\n    return false;\n  }\n\n  let onChainNonce: bigint;\n  if (\n    signedApproval.subaccountRouterAddress ===\n    getContract(chainId, \"SubaccountGelatoRelayRouter\")\n  ) {\n    onChainNonce = onchainData.approvalNonce;\n  } else if (\n    signedApproval.subaccountRouterAddress ===\n    getContract(chainId, \"MultichainSubaccountRouter\")\n  ) {\n    onChainNonce = onchainData.multichainApprovalNonce;\n  } else if (!signedApproval.subaccountRouterAddress) {\n    if (isSourceChain(signedApproval.signatureChainId)) {\n      onChainNonce = onchainData.multichainApprovalNonce;\n    } else {\n      onChainNonce = onchainData.approvalNonce;\n    }\n  } else {\n    return false;\n  }\n\n  const signedNonce = signedApproval.nonce;\n\n  return signedNonce !== onChainNonce;\n}\n\nexport function getIsSubaccountApprovalInvalid({\n  chainId,\n  signerChainId,\n  signedApproval,\n  onchainData,\n  subaccountRouterAddress,\n}: {\n  chainId: ContractsChainId;\n  signerChainId: AnyChainId;\n  signedApproval: SignedSubaccountApproval;\n  onchainData: SubaccountOnchainData;\n  subaccountRouterAddress: string;\n}): boolean {\n  if (getIsEmptySubaccountApproval(signedApproval)) {\n    return false;\n  }\n\n  const isSignedSubaccountFresh = !onchainData.active;\n\n  let relatedOnchainNonce: bigint | undefined;\n  if (\n    signedApproval.subaccountRouterAddress ===\n    getContract(chainId, \"MultichainSubaccountRouter\")\n  ) {\n    relatedOnchainNonce = onchainData.multichainApprovalNonce;\n  } else if (\n    signedApproval.subaccountRouterAddress ===\n      getContract(chainId, \"SubaccountGelatoRelayRouter\") ||\n    !signedApproval.subaccountRouterAddress\n  ) {\n    relatedOnchainNonce = onchainData.approvalNonce;\n  } else {\n    return true;\n  }\n\n  const isSignedSubaccountPossibleUpdate =\n    signedApproval.nonce === relatedOnchainNonce;\n\n  const result =\n    (isSignedSubaccountFresh || isSignedSubaccountPossibleUpdate) &&\n    (signedApproval.signatureChainId !== signerChainId ||\n      signedApproval.subaccountRouterAddress !== subaccountRouterAddress);\n\n  return result;\n}\n\nexport function getIsSubaccountExpired(subaccount: Subaccount): boolean {\n  const now = BigInt(nowInSeconds());\n  const isApprovalExpired = getIsApprovalExpired(subaccount);\n\n  if (isApprovalExpired) {\n    return true;\n  }\n\n  const expiresAt = getSubaccountExpiresAt(subaccount);\n  const isExpired = now >= expiresAt;\n\n  return isExpired;\n}\n\nexport function getIsInvalidSubaccount({\n  subaccount,\n  requiredActions,\n  subaccountRouterAddress,\n}: {\n  subaccount: Subaccount;\n  requiredActions: number;\n  subaccountRouterAddress: string;\n}): boolean {\n  const isExpired = getIsSubaccountExpired(subaccount);\n  const isNonceExpired = getIsSubaccountNonceExpired(subaccount);\n  const actionsExceeded = getIsSubaccountActionsExceeded(\n    subaccount,\n    requiredActions\n  );\n  const isApprovalInvalid = getIsSubaccountApprovalInvalid({\n    chainId: subaccount.chainId,\n    signedApproval: subaccount.signedApproval,\n    subaccountRouterAddress,\n    signerChainId: subaccount.signerChainId,\n    onchainData: subaccount.onchainData,\n  });\n\n  return isExpired || isNonceExpired || actionsExceeded || isApprovalInvalid;\n}\n\nexport function getEmptySubaccountApproval(\n  chainId: ContractsChainId,\n  subaccountAddress: string\n): SignedSubaccountApproval {\n  return {\n    subaccount: subaccountAddress,\n    shouldAdd: false,\n    expiresAt: 0n,\n    maxAllowedCount: 0n,\n    actionType: SUBACCOUNT_ORDER_ACTION,\n    nonce: 0n,\n    deadline: maxUint256,\n    desChainId: BigInt(chainId),\n    signature: ZERO_DATA,\n    signedAt: 0,\n    integrationId: zeroHash,\n    subaccountRouterAddress: zeroAddress,\n    signatureChainId: chainId,\n  };\n}\n\nexport function getIsEmptySubaccountApproval(\n  subaccountApproval: SignedSubaccountApproval\n): boolean {\n  return (\n    subaccountApproval.signature === ZERO_DATA &&\n    subaccountApproval.nonce === 0n &&\n    subaccountApproval.expiresAt === 0n &&\n    subaccountApproval.maxAllowedCount === 0n &&\n    subaccountApproval.shouldAdd === false &&\n    subaccountApproval.integrationId === zeroHash\n  );\n}\n\nexport function hashSubaccountApproval(\n  subaccountApproval: SignedSubaccountApproval\n) {\n  if (!subaccountApproval) {\n    return zeroHash;\n  }\n\n  const encodedData = encodeAbiParameters(\n    [\n      {\n        type: \"tuple\",\n        components: [\n          { name: \"subaccount\", type: \"address\" },\n          { name: \"shouldAdd\", type: \"bool\" },\n          { name: \"expiresAt\", type: \"uint256\" },\n          { name: \"maxAllowedCount\", type: \"uint256\" },\n          { name: \"actionType\", type: \"bytes32\" },\n          { name: \"nonce\", type: \"uint256\" },\n          { name: \"desChainId\", type: \"uint256\" },\n          { name: \"deadline\", type: \"uint256\" },\n          { name: \"integrationId\", type: \"bytes32\" },\n          { name: \"signature\", type: \"bytes\" },\n        ],\n      },\n    ],\n    [subaccountApproval as any]\n  );\n\n  return keccak256(encodedData);\n}\n\nexport function getIsSubaccountApprovalSynced(params: {\n  chainId: ContractsChainId;\n  signedApproval: SignedSubaccountApproval;\n  onchainData: SubaccountOnchainData;\n}): boolean {\n  const { signedApproval, onchainData } = params;\n\n  if (getIsSubaccountNonceExpired(params)) {\n    return true;\n  }\n\n  return (\n    onchainData.maxAllowedCount === signedApproval.maxAllowedCount &&\n    onchainData.expiresAt === signedApproval.expiresAt &&\n    onchainData.active === true\n  );\n}\n\nexport async function getSubaccountOnchainData({\n  chainId,\n  signer,\n  publicClient,\n  subaccountAddress,\n}: {\n  chainId: ContractsChainId;\n  signer: { address: string };\n  publicClient: PublicClient;\n  subaccountAddress: string;\n}): Promise<SubaccountOnchainData> {\n  const account = signer.address;\n\n  const results = await publicClient.multicall({\n    contracts: [\n      {\n        address: getContract(\n          chainId,\n          \"SubaccountGelatoRelayRouter\"\n        ) as `0x${string}`,\n        abi: abis.AbstractSubaccountApprovalNonceable,\n        functionName: \"subaccountApprovalNonces\",\n        args: [account as `0x${string}`],\n      },\n      {\n        address: getContract(\n          chainId,\n          \"MultichainSubaccountRouter\"\n        ) as `0x${string}`,\n        abi: abis.AbstractSubaccountApprovalNonceable,\n        functionName: \"subaccountApprovalNonces\",\n        args: [account as `0x${string}`],\n      },\n      {\n        address: getContract(chainId, \"DataStore\") as `0x${string}`,\n        abi: abis.DataStore,\n        functionName: \"containsAddress\",\n        args: [\n          subaccountListKey(account) as `0x${string}`,\n          subaccountAddress as `0x${string}`,\n        ],\n      },\n      {\n        address: getContract(chainId, \"DataStore\") as `0x${string}`,\n        abi: abis.DataStore,\n        functionName: \"getUint\",\n        args: [\n          maxAllowedSubaccountActionCountKey(\n            account,\n            subaccountAddress,\n            SUBACCOUNT_ORDER_ACTION\n          ) as `0x${string}`,\n        ],\n      },\n      {\n        address: getContract(chainId, \"DataStore\") as `0x${string}`,\n        abi: abis.DataStore,\n        functionName: \"getUint\",\n        args: [\n          subaccountActionCountKey(\n            account,\n            subaccountAddress,\n            SUBACCOUNT_ORDER_ACTION\n          ) as `0x${string}`,\n        ],\n      },\n      {\n        address: getContract(chainId, \"DataStore\") as `0x${string}`,\n        abi: abis.DataStore,\n        functionName: \"getUint\",\n        args: [\n          subaccountExpiresAtKey(\n            account,\n            subaccountAddress,\n            SUBACCOUNT_ORDER_ACTION\n          ) as `0x${string}`,\n        ],\n      },\n      {\n        address: getContract(chainId, \"DataStore\") as `0x${string}`,\n        abi: abis.DataStore,\n        functionName: \"getBytes32\",\n        args: [\n          subaccountIntegrationIdKey(\n            account,\n            subaccountAddress\n          ) as `0x${string}`,\n        ],\n      },\n    ],\n  });\n\n  if (results.some((result) => result.status === \"failure\")) {\n    throw new Error(\"Multicall failed for subaccount onchain data\");\n  }\n\n  return {\n    approvalNonce: results[0].result as bigint,\n    multichainApprovalNonce: results[1].result as bigint,\n    active: results[2].result as boolean,\n    maxAllowedCount: results[3].result as bigint,\n    currentActionsCount: results[4].result as bigint,\n    expiresAt: results[5].result as bigint,\n    integrationId:\n      (results[6].result as `0x${string}`) === zeroHash\n        ? undefined\n        : (results[6].result as `0x${string}`),\n  };\n}\n"]}