{"version":3,"sources":["../../../../../src/transactions/express/relayParamsUtils.ts"],"names":[],"mappings":"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","file":"relayParamsUtils.js","sourcesContent":["import { Address, encodeAbiParameters, keccak256 } from \"viem\";\n\nimport { abis } from \"abis\";\nimport type { ContractsChainId, SourceChainId } from \"configs/chains\";\nimport { ContractName, getContract } from \"configs/contracts\";\nimport { ExternalSwapQuote } from \"domain/externalSwap/types\";\nimport { getBestSwapStrategy } from \"domain/externalSwap/utils\";\nimport { MarketsInfoData } from \"domain/markets/types\";\nimport { getSwapAmountsByToValue } from \"domain/swap/swapValues\";\nimport { FindSwapPath, SwapAmounts } from \"domain/swap/types\";\nimport type { SignedTokenPermit, TokenData } from \"domain/tokens/types\";\nimport { nowInSeconds } from \"lib/time\";\nimport {\n  combineExternalCalls,\n  ExternalCallsPayload,\n  getEmptyExternalCallsPayload,\n  getExternalCallsPayload,\n} from \"transactions/batch/payloads/orderTransactions\";\n\nimport { getOracleParamsForRelayParams } from \"./oracleParamsUtils\";\nimport type {\n  GasPaymentParams,\n  RawRelayParamsPayload,\n  RelayFeePayload,\n  RelayParamsPayload,\n} from \"./types\";\nimport type { SignatureDomain } from \"./utils\";\n\nexport function getExpressContractAddress(\n  chainId: ContractsChainId,\n  {\n    isSubaccount,\n    isMultichain,\n    scope,\n  }: {\n    isSubaccount?: boolean;\n    isMultichain?: boolean;\n    scope?: \"glv\" | \"gm\" | \"transfer\" | \"claims\" | \"order\" | \"subaccount\";\n  }\n): Address {\n  let contractName: ContractName;\n  if (isMultichain) {\n    switch (scope) {\n      case \"claims\":\n        contractName = \"MultichainClaimsRouter\";\n        break;\n      case \"order\":\n        contractName = \"MultichainOrderRouter\";\n        break;\n      case \"subaccount\":\n        contractName = \"MultichainSubaccountRouter\";\n        break;\n      case \"glv\":\n        contractName = \"MultichainGlvRouter\";\n        break;\n      case \"gm\":\n        contractName = \"MultichainGmRouter\";\n        break;\n      case \"transfer\":\n        contractName = \"MultichainTransferRouter\";\n        break;\n      default:\n        throw new Error(`Invalid scope: ${scope}`);\n    }\n  } else {\n    if (isSubaccount) {\n      contractName = \"SubaccountGelatoRelayRouter\";\n    } else {\n      contractName = \"GelatoRelayRouter\";\n    }\n  }\n\n  return getContract(chainId, contractName);\n}\n\nexport function getGelatoRelayRouterDomain(\n  chainId: SourceChainId | ContractsChainId,\n  relayRouterAddress: string\n): SignatureDomain {\n  const name = \"GmxBaseGelatoRelayRouter\";\n\n  return {\n    name,\n    version: \"1\",\n    chainId,\n    verifyingContract: relayRouterAddress as Address,\n  };\n}\n\nexport function getRelayerFeeParams({\n  chainId,\n  account,\n  gasPaymentToken,\n  relayerFeeToken,\n  relayerFeeAmount,\n  totalRelayerFeeTokenAmount,\n  gasPaymentTokenAsCollateralAmount,\n  transactionExternalCalls,\n  feeExternalSwapQuote,\n  findFeeSwapPath,\n}: {\n  chainId: ContractsChainId;\n  account: string;\n  relayerFeeAmount: bigint;\n  totalRelayerFeeTokenAmount: bigint;\n  relayerFeeToken: TokenData;\n  gasPaymentToken: TokenData;\n  gasPaymentTokenAsCollateralAmount: bigint;\n  findFeeSwapPath: FindSwapPath | undefined;\n  feeExternalSwapQuote: ExternalSwapQuote | undefined;\n  /**\n   * If transaction contains an external calls e.g. for collateral external swaps,\n   * it should also be included in relayParams\n   */\n  transactionExternalCalls: ExternalCallsPayload | undefined;\n}) {\n  const gasPaymentParams: GasPaymentParams = {\n    gasPaymentToken: gasPaymentToken,\n    relayFeeToken: relayerFeeToken,\n    gasPaymentTokenAddress: gasPaymentToken.address,\n    relayerFeeTokenAddress: relayerFeeToken.address,\n    relayerFeeAmount,\n    totalRelayerFeeTokenAmount,\n    gasPaymentTokenAmount: 0n,\n    gasPaymentTokenAsCollateralAmount,\n  };\n\n  let feeParams: RelayFeePayload;\n  let externalCalls =\n    transactionExternalCalls ?? getEmptyExternalCallsPayload();\n  let feeExternalSwapGasLimit = 0n;\n\n  if (relayerFeeToken.address === gasPaymentToken.address) {\n    feeParams = {\n      feeToken: relayerFeeToken.address,\n      feeAmount: totalRelayerFeeTokenAmount,\n      feeSwapPath: [],\n    };\n    gasPaymentParams.gasPaymentTokenAmount = totalRelayerFeeTokenAmount;\n  } else {\n    let feeSwapAmounts: SwapAmounts | undefined;\n\n    if (findFeeSwapPath) {\n      feeSwapAmounts = getSwapAmountsByToValue({\n        tokenIn: gasPaymentToken,\n        tokenOut: relayerFeeToken,\n        amountOut: totalRelayerFeeTokenAmount,\n        isLimit: false,\n        findSwapPath: findFeeSwapPath,\n        swapOptimizationOrder: [\"length\"],\n        uiFeeFactor: 0n,\n        marketsInfoData: undefined,\n        chainId,\n        externalSwapQuoteParams: undefined,\n      });\n    }\n\n    const bestFeeSwapStrategy = getBestSwapStrategy({\n      internalSwapAmounts: feeSwapAmounts,\n      externalSwapQuote: feeExternalSwapQuote,\n    });\n\n    if (bestFeeSwapStrategy?.swapPath) {\n      feeParams = {\n        feeToken: gasPaymentToken.address,\n        feeAmount: bestFeeSwapStrategy.amountIn,\n        feeSwapPath: bestFeeSwapStrategy.swapPath,\n      };\n      gasPaymentParams.gasPaymentTokenAmount = bestFeeSwapStrategy.amountIn;\n      gasPaymentParams.totalRelayerFeeTokenAmount =\n        bestFeeSwapStrategy.amountOut;\n    } else if (bestFeeSwapStrategy?.externalSwapQuote) {\n      externalCalls = combineExternalCalls([\n        externalCalls,\n        getExternalCallsPayload({\n          chainId,\n          account,\n          quote: bestFeeSwapStrategy.externalSwapQuote,\n        }),\n      ]);\n      feeExternalSwapGasLimit =\n        bestFeeSwapStrategy.externalSwapQuote.txnData.estimatedGas;\n      feeParams = {\n        feeToken: relayerFeeToken.address, // final token\n        feeAmount: 0n, // fee already sent in external calls\n        feeSwapPath: [],\n      };\n      gasPaymentParams.gasPaymentTokenAmount =\n        bestFeeSwapStrategy.externalSwapQuote.amountIn;\n      gasPaymentParams.totalRelayerFeeTokenAmount =\n        bestFeeSwapStrategy.externalSwapQuote.amountOut;\n    } else {\n      return undefined;\n    }\n  }\n\n  return {\n    feeParams,\n    externalCalls,\n    feeExternalSwapGasLimit,\n    gasPaymentParams,\n  };\n}\n\nexport function getRawRelayerParams({\n  chainId,\n  gasPaymentTokenAddress,\n  relayerFeeTokenAddress,\n  feeParams,\n  externalCalls,\n  tokenPermits,\n  marketsInfoData,\n}: {\n  chainId: ContractsChainId;\n  gasPaymentTokenAddress: string;\n  relayerFeeTokenAddress: string;\n  feeParams: RelayFeePayload;\n  externalCalls: ExternalCallsPayload;\n  tokenPermits: SignedTokenPermit[];\n  marketsInfoData: MarketsInfoData;\n}): RawRelayParamsPayload {\n  const oracleParams = getOracleParamsForRelayParams({\n    chainId,\n    externalCalls,\n    feeSwapPath: feeParams.feeSwapPath,\n    gasPaymentTokenAddress,\n    relayerFeeTokenAddress,\n    marketsInfoData,\n  });\n\n  const relayParamsPayload: RawRelayParamsPayload = {\n    oracleParams,\n    tokenPermits,\n    externalCalls,\n    fee: feeParams,\n    desChainId: BigInt(chainId),\n    userNonce: BigInt(nowInSeconds()),\n  };\n\n  return relayParamsPayload;\n}\n\nexport function hashRelayParams(relayParams: RelayParamsPayload) {\n  const encoded = encodeAbiParameters(abis.RelayParams, [\n    {\n      tokens: relayParams.oracleParams.tokens,\n      providers: relayParams.oracleParams.providers,\n      data: relayParams.oracleParams.data,\n    },\n    {\n      sendTokens: relayParams.externalCalls.sendTokens,\n      sendAmounts: relayParams.externalCalls.sendAmounts,\n      externalCallTargets: relayParams.externalCalls.externalCallTargets,\n      externalCallDataList: relayParams.externalCalls.externalCallDataList,\n      refundTokens: relayParams.externalCalls.refundTokens,\n      refundReceivers: relayParams.externalCalls.refundReceivers,\n    },\n    relayParams.tokenPermits,\n    {\n      feeToken: relayParams.fee.feeToken,\n      feeAmount: relayParams.fee.feeAmount,\n      feeSwapPath: relayParams.fee.feeSwapPath,\n    },\n    relayParams.userNonce,\n    relayParams.deadline,\n    relayParams.desChainId,\n  ]);\n\n  const hash = keccak256(encoded);\n\n  return hash;\n}\n"]}