{"version":3,"sources":["../../../../../src/transactions/express/expressOrderUtils.ts"],"names":[],"mappings":"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","file":"expressOrderUtils.js","sourcesContent":["import {\n  Address,\n  encodeFunctionData,\n  recoverTypedDataAddress,\n  size,\n  zeroAddress,\n  zeroHash,\n} from \"viem\";\n\nimport { abis } from \"abis\";\nimport { BOTANIX } from \"configs/chains\";\nimport type {\n  AnyChainId,\n  ContractsChainId,\n  SettlementChainId,\n  SourceChainId,\n} from \"configs/chains\";\nimport { ContractName, getContract } from \"configs/contracts\";\nimport { GMX_SIMULATION_ORIGIN } from \"configs/dataStore\";\nimport { DEFAULT_EXPRESS_ORDER_DEADLINE_DURATION } from \"configs/express\";\nimport { isSourceChain } from \"configs/multichain\";\nimport {\n  approximateL1GasBuffer,\n  estimateBatchGasLimit,\n  estimateRelayerGasLimit,\n} from \"domain/executionFee/executionFee\";\nimport type { GasLimitsConfig } from \"domain/executionFee/types\";\nimport type {\n  SignedSubaccountApproval,\n  Subaccount,\n} from \"domain/subaccount/types\";\nimport {\n  getSubaccountValidations,\n  hashSubaccountApproval,\n} from \"domain/subaccount/utils\";\nimport type {\n  SignedTokenPermit,\n  TokenData,\n  TokensAllowanceData,\n  TokensData,\n} from \"domain/tokens/types\";\nimport { setUiFeeReceiverIsExpress } from \"domain/uiFeeReceiver/uiFeeReceiver\";\nimport { bigMath } from \"lib/bigmath\";\nimport { extendError } from \"lib/errors\";\nimport { estimateGasLimit } from \"lib/gas/estimateGasLimit\";\nimport { gelatoRelay } from \"lib/gelatoRelay/gelatoRelay\";\nimport { emitMetricEvent } from \"lib/metrics\";\nimport { BASIS_POINTS_DIVISOR_BIGINT, applyFactor } from \"lib/numbers\";\nimport { getByKey } from \"lib/objects\";\nimport { iRpc } from \"lib/rpc/types\";\nimport { ISigner, signTypedData } from \"lib/signing/signing\";\nimport { nowInSeconds } from \"lib/time\";\nimport { ExpressTxnData } from \"lib/transactions/sendExpressTransaction\";\nimport {\n  getBatchExternalCalls,\n  getBatchExternalSwapGasLimit,\n  getBatchRequiredActions,\n  getBatchTotalExecutionFee,\n  getBatchTotalPayCollateralAmount,\n  getIsEmptyBatch,\n  type BatchOrderTxnParams,\n  type CreateOrderPayload,\n} from \"transactions/batch/payloads/orderTransactions\";\n\nimport {\n  getGelatoRelayRouterDomain,\n  getRawRelayerParams,\n  getRelayerFeeParams,\n  hashRelayParams,\n} from \"./relayParamsUtils\";\nimport type {\n  ExpressParamsEstimationMethod,\n  ExpressTransactionBuilder,\n  ExpressTransactionEstimatorParams,\n  ExpressTxnParams,\n  GasPaymentValidations,\n  GlobalExpressParams,\n  RawRelayParamsPayload,\n  RelayParamsPayload,\n  RelayParamsPayloadWithSignature,\n} from \"./types\";\nimport { getNeedTokenApprove, type SignatureDomain } from \"./utils\";\n\nexport type BridgeOutParams = {\n  token: string;\n  amount: bigint;\n  minAmountOut: bigint;\n  provider: string;\n  data: string;\n};\n\nexport type SignTypedDataParams = {\n  signer: ISigner;\n  domain: SignatureDomain;\n  types: Record<string, any>;\n  typedData: Record<string, any>;\n  shouldUseSignerMethod?: boolean;\n};\n\nexport async function estimateBatchExpressParams({\n  signer,\n  provider,\n  chainId,\n  batchParams,\n  isGmxAccount,\n  globalExpressParams,\n  requireValidations,\n  estimationMethod = \"approximate\",\n  subaccount,\n}: {\n  chainId: ContractsChainId;\n  isGmxAccount: boolean;\n  signer: ISigner;\n  provider: iRpc;\n  batchParams: BatchOrderTxnParams;\n  globalExpressParams: GlobalExpressParams | undefined;\n  estimationMethod: ExpressParamsEstimationMethod;\n  requireValidations: boolean;\n  subaccount: Subaccount | undefined;\n}): Promise<ExpressTxnParams | undefined> {\n  if (!globalExpressParams) {\n    return undefined;\n  }\n\n  const transactionParams = getBatchExpressEstimatorParams({\n    signer,\n    batchParams,\n    gasLimits: globalExpressParams.gasLimits,\n    gasPaymentToken: globalExpressParams.gasPaymentToken,\n    chainId,\n    tokensData: globalExpressParams.tokensData,\n    isGmxAccount,\n  });\n\n  if (!transactionParams) {\n    return undefined;\n  }\n\n  const expressParams = await estimateExpressParams({\n    chainId,\n    provider,\n    transactionParams,\n    globalExpressParams,\n    estimationMethod,\n    requireValidations,\n    isGmxAccount,\n    subaccount,\n  });\n\n  return expressParams;\n}\n\nfunction getBatchExpressEstimatorParams({\n  signer,\n  batchParams,\n  gasLimits,\n  gasPaymentToken,\n  chainId,\n  tokensData,\n  isGmxAccount,\n}: {\n  signer: ISigner;\n  batchParams: BatchOrderTxnParams;\n  gasLimits: GasLimitsConfig;\n  gasPaymentToken: TokenData;\n  isGmxAccount: boolean;\n  chainId: ContractsChainId;\n  tokensData: TokensData;\n}): ExpressTransactionEstimatorParams | undefined {\n  const payAmounts = getBatchTotalPayCollateralAmount(batchParams);\n  const gasPaymentTokenAsCollateralAmount =\n    getByKey(payAmounts, gasPaymentToken.address) ?? 0n;\n  const executionFeeAmount = getBatchTotalExecutionFee({\n    batchParams,\n    chainId,\n    tokensData,\n  });\n  const transactionExternalCalls = getBatchExternalCalls(batchParams);\n  const subaccountActions = getBatchRequiredActions(batchParams);\n  const transactionPayloadGasLimit = estimateBatchGasLimit({\n    gasLimits,\n    createOrdersCount: batchParams.createOrderParams.length,\n    updateOrdersCount: batchParams.updateOrderParams.length,\n    cancelOrdersCount: batchParams.cancelOrderParams.length,\n    externalCallsGasLimit: getBatchExternalSwapGasLimit(batchParams),\n    isGmxAccount,\n  });\n\n  if (!executionFeeAmount) {\n    return undefined;\n  }\n\n  const expressTransactionBuilder: ExpressTransactionBuilder = async ({\n    relayParams,\n    gasPaymentParams,\n    subaccount,\n  }) => {\n    return {\n      txnData: await buildAndSignExpressBatchOrderTxn({\n        chainId,\n        batchParams,\n        relayParamsPayload: relayParams,\n        relayerFeeTokenAddress: gasPaymentParams.relayerFeeTokenAddress,\n        relayerFeeAmount: gasPaymentParams.relayerFeeAmount,\n        subaccount,\n        signer,\n        emptySignature: true,\n        isGmxAccount,\n      }),\n    };\n  };\n\n  return {\n    account: signer.address,\n    gasPaymentTokenAsCollateralAmount,\n    executionFeeAmount: executionFeeAmount.feeTokenAmount,\n    executionGasLimit: executionFeeAmount.gasLimit,\n    transactionPayloadGasLimit,\n    transactionExternalCalls,\n    subaccountActions,\n    isValid: !getIsEmptyBatch(batchParams),\n    expressTransactionBuilder,\n  };\n}\n\nexport async function estimateExpressParams({\n  chainId,\n  isGmxAccount,\n  provider,\n  transactionParams,\n  globalExpressParams,\n  estimationMethod = \"approximate\",\n  requireValidations = true,\n  subaccount: rawSubaccount,\n}: {\n  chainId: ContractsChainId;\n  isGmxAccount: boolean;\n  provider: iRpc;\n  globalExpressParams: GlobalExpressParams;\n  transactionParams: ExpressTransactionEstimatorParams;\n  estimationMethod: \"approximate\" | \"estimateGas\";\n  requireValidations: boolean;\n  subaccount: Subaccount | undefined;\n}): Promise<ExpressTxnParams | undefined> {\n  if (requireValidations && !transactionParams.isValid) {\n    return undefined;\n  }\n\n  const {\n    findFeeSwapPath,\n    gasLimits,\n    gasPaymentToken,\n    relayerFeeToken,\n    l1Reference,\n    tokenPermits: rawTokenPermits,\n    gasPrice,\n    isSponsoredCall,\n    bufferBps,\n    marketsInfoData,\n    gasPaymentAllowanceData,\n  } = globalExpressParams;\n\n  const {\n    expressTransactionBuilder,\n    gasPaymentTokenAsCollateralAmount,\n    executionFeeAmount,\n    executionGasLimit,\n    transactionPayloadGasLimit,\n    transactionExternalCalls,\n    subaccountActions,\n    account,\n  } = transactionParams;\n\n  const subaccountValidations = rawSubaccount\n    ? getSubaccountValidations({\n        requiredActions: subaccountActions,\n        subaccount: rawSubaccount,\n        subaccountRouterAddress: getOrderRelayRouterAddress(\n          chainId,\n          true,\n          isGmxAccount\n        ),\n      })\n    : undefined;\n\n  const subaccount = subaccountValidations?.isValid ? rawSubaccount : undefined;\n\n  const tokenPermits = isGmxAccount ? [] : rawTokenPermits;\n\n  const baseRelayerGasLimit = estimateRelayerGasLimit({\n    gasLimits,\n    tokenPermitsCount: tokenPermits.length,\n    feeSwapsCount: 1,\n    feeExternalCallsGasLimit: 0n,\n    oraclePriceCount: 2,\n    l1GasLimit: l1Reference?.gasLimit ?? 0n,\n    transactionPayloadGasLimit,\n  });\n\n  const baseRelayerFeeAmount = baseRelayerGasLimit * gasPrice;\n\n  const baseTotalRelayerFeeTokenAmount =\n    baseRelayerFeeAmount + executionFeeAmount;\n\n  const baseRelayFeeParams = getRelayerFeeParams({\n    chainId,\n    account,\n    gasPaymentToken,\n    relayerFeeToken,\n    relayerFeeAmount: baseRelayerFeeAmount,\n    totalRelayerFeeTokenAmount: baseTotalRelayerFeeTokenAmount,\n    gasPaymentTokenAsCollateralAmount,\n    transactionExternalCalls,\n    feeExternalSwapQuote: undefined,\n    findFeeSwapPath,\n  });\n\n  if (!baseRelayFeeParams) {\n    return undefined;\n  }\n\n  const baseRelayParams = getRawRelayerParams({\n    chainId,\n    gasPaymentTokenAddress: gasPaymentToken.address,\n    relayerFeeTokenAddress: relayerFeeToken.address,\n    feeParams: baseRelayFeeParams.feeParams,\n    externalCalls: baseRelayFeeParams.externalCalls,\n    tokenPermits,\n    marketsInfoData,\n  });\n\n  const baseTxn = await expressTransactionBuilder({\n    relayParams: baseRelayParams,\n    gasPaymentParams: baseRelayFeeParams.gasPaymentParams,\n    subaccount,\n  });\n\n  const l1GasLimit = l1Reference\n    ? approximateL1GasBuffer({\n        l1Reference,\n        sizeOfData: BigInt(size(baseTxn.txnData.callData as `0x${string}`)),\n      })\n    : 0n;\n\n  let gasLimit: bigint;\n  if (estimationMethod === \"estimateGas\" && provider) {\n    const baseGasPaymentValidations = getGasPaymentValidations({\n      gasPaymentToken,\n      gasPaymentTokenAsCollateralAmount,\n      gasPaymentTokenAmount:\n        baseRelayFeeParams.gasPaymentParams.gasPaymentTokenAmount,\n      gasPaymentAllowanceData,\n      isGmxAccount,\n      tokenPermits,\n    });\n\n    if (\n      baseGasPaymentValidations.isOutGasTokenBalance ||\n      baseGasPaymentValidations.needGasPaymentTokenApproval ||\n      !transactionParams.isValid\n    ) {\n      // In this cases simulation will fail\n      return undefined;\n    }\n\n    try {\n      gasLimit = await estimateGasLimit(provider, {\n        from: GMX_SIMULATION_ORIGIN,\n        to: baseTxn.txnData.to,\n        data: baseTxn.txnData.callData,\n        value: 0n,\n      });\n    } catch (error) {\n      const extendedError = extendError(error, {\n        data: {\n          estimationMethod,\n        },\n      });\n\n      emitMetricEvent({\n        event: \"expressOrders.estimateGas\",\n        isError: true,\n        data: extendedError,\n      });\n\n      return undefined;\n    }\n  } else {\n    gasLimit = estimateRelayerGasLimit({\n      gasLimits,\n      tokenPermitsCount: tokenPermits.length,\n      feeSwapsCount: baseRelayFeeParams.feeParams.feeSwapPath.length,\n      feeExternalCallsGasLimit: baseRelayFeeParams.feeExternalSwapGasLimit,\n      oraclePriceCount: baseRelayParams.oracleParams.tokens.length,\n      l1GasLimit,\n      transactionPayloadGasLimit,\n    });\n  }\n\n  let relayerFeeAmount: bigint;\n  if (isSponsoredCall) {\n    relayerFeeAmount = applyFactor(\n      gasLimit * gasPrice,\n      gasLimits.gelatoRelayFeeMultiplierFactor\n    );\n  } else {\n    relayerFeeAmount = await gelatoRelay.getEstimatedFee(\n      BigInt(chainId),\n      relayerFeeToken.address,\n      gasLimit,\n      false\n    );\n  }\n\n  const buffer = bigMath.mulDiv(\n    relayerFeeAmount,\n    BigInt(bufferBps),\n    BASIS_POINTS_DIVISOR_BIGINT\n  );\n  relayerFeeAmount += buffer;\n\n  const totalRelayerFeeTokenAmount = relayerFeeAmount + executionFeeAmount;\n\n  const finalRelayFeeParams = getRelayerFeeParams({\n    chainId,\n    account,\n    gasPaymentToken,\n    relayerFeeToken,\n    relayerFeeAmount,\n    totalRelayerFeeTokenAmount,\n    gasPaymentTokenAsCollateralAmount,\n    transactionExternalCalls,\n    feeExternalSwapQuote: undefined,\n    findFeeSwapPath,\n  });\n\n  if (!finalRelayFeeParams) {\n    return undefined;\n  }\n\n  const finalRelayParams = getRawRelayerParams({\n    chainId,\n    gasPaymentTokenAddress: gasPaymentToken.address,\n    relayerFeeTokenAddress: relayerFeeToken.address,\n    feeParams: finalRelayFeeParams.feeParams,\n    externalCalls: finalRelayFeeParams.externalCalls,\n    tokenPermits,\n    marketsInfoData,\n  });\n\n  const gasPaymentValidations = getGasPaymentValidations({\n    gasPaymentToken,\n    gasPaymentTokenAmount:\n      finalRelayFeeParams.gasPaymentParams.gasPaymentTokenAmount,\n    gasPaymentTokenAsCollateralAmount,\n    gasPaymentAllowanceData,\n    isGmxAccount,\n    tokenPermits,\n  });\n\n  if (\n    requireValidations &&\n    !getIsValidExpressParams({\n      chainId,\n      gasPaymentValidations,\n      isSponsoredCall,\n    })\n  ) {\n    return undefined;\n  }\n\n  return {\n    chainId,\n    subaccount,\n    relayParamsPayload: finalRelayParams,\n    isSponsoredCall,\n    gasPaymentParams: finalRelayFeeParams.gasPaymentParams,\n    executionFeeAmount,\n    executionGasLimit,\n    estimationMethod,\n    gasLimit,\n    l1GasLimit,\n    gasPrice,\n    subaccountValidations,\n    gasPaymentValidations,\n    isGmxAccount,\n  };\n}\n\nexport function getIsValidExpressParams({\n  chainId,\n  gasPaymentValidations,\n  isSponsoredCall,\n}: {\n  chainId: number;\n  isSponsoredCall: boolean;\n  gasPaymentValidations: GasPaymentValidations;\n}): boolean {\n  if (chainId === BOTANIX && !isSponsoredCall) {\n    return false;\n  }\n\n  return gasPaymentValidations.isValid;\n}\n\nexport function getGasPaymentValidations({\n  gasPaymentToken,\n  gasPaymentTokenAmount,\n  gasPaymentTokenAsCollateralAmount,\n  gasPaymentAllowanceData,\n  tokenPermits,\n  isGmxAccount,\n}: {\n  gasPaymentToken: TokenData;\n  gasPaymentTokenAmount: bigint;\n  gasPaymentTokenAsCollateralAmount: bigint;\n  gasPaymentAllowanceData: TokensAllowanceData;\n  tokenPermits: SignedTokenPermit[];\n  isGmxAccount: boolean;\n}): GasPaymentValidations {\n  // Add buffer to onchain avoid out of balance errors in case quick of network fee increase\n  const gasTokenAmountWithBuffer = (gasPaymentTokenAmount * 13n) / 10n;\n  const totalGasPaymentTokenAmount =\n    gasPaymentTokenAsCollateralAmount + gasTokenAmountWithBuffer;\n\n  const tokenBalance = isGmxAccount\n    ? gasPaymentToken.gmxAccountBalance\n    : gasPaymentToken.walletBalance;\n  const isOutGasTokenBalance =\n    tokenBalance === undefined || totalGasPaymentTokenAmount > tokenBalance;\n\n  const needGasPaymentTokenApproval = isGmxAccount\n    ? false\n    : getNeedTokenApprove(\n        gasPaymentAllowanceData,\n        gasPaymentToken?.address,\n        totalGasPaymentTokenAmount,\n        tokenPermits\n      );\n\n  return {\n    isOutGasTokenBalance,\n    needGasPaymentTokenApproval,\n    isValid: !isOutGasTokenBalance && !needGasPaymentTokenApproval,\n  };\n}\n\nexport async function buildAndSignExpressBatchOrderTxn({\n  chainId,\n  batchParams,\n  relayParamsPayload,\n  relayerFeeTokenAddress,\n  relayerFeeAmount,\n  subaccount,\n  signer,\n  isGmxAccount,\n  emptySignature = false,\n}: {\n  signer: ISigner;\n  chainId: ContractsChainId;\n  batchParams: BatchOrderTxnParams;\n  relayerFeeTokenAddress: string;\n  relayerFeeAmount: bigint;\n  relayParamsPayload: RawRelayParamsPayload;\n  isGmxAccount: boolean;\n  subaccount: Subaccount | undefined;\n  emptySignature?: boolean;\n}): Promise<ExpressTxnData> {\n  const messageSigner = subaccount ? subaccount!.signer : signer;\n\n  const relayRouterAddress = getOrderRelayRouterAddress(\n    chainId,\n    subaccount !== undefined,\n    isGmxAccount\n  );\n\n  const params = {\n    account: signer.address,\n    messageSigner,\n    chainId,\n    relayPayload: {\n      ...(relayParamsPayload as RelayParamsPayload),\n      deadline: BigInt(\n        nowInSeconds() + DEFAULT_EXPRESS_ORDER_DEADLINE_DURATION\n      ),\n      userNonce: BigInt(nowInSeconds()),\n    } satisfies RelayParamsPayload,\n    subaccountApproval: subaccount?.signedApproval,\n    paramsLists: getBatchParamsLists(batchParams),\n  };\n\n  let signature: string;\n  if (emptySignature) {\n    signature = \"0x\";\n  } else {\n    const signatureParams = await getBatchSignatureParams({\n      signer: params.messageSigner,\n      relayParams: params.relayPayload,\n      batchParams,\n      chainId,\n      account: params.account,\n      subaccountApproval: params.subaccountApproval,\n      relayRouterAddress,\n    });\n\n    signature = await signTypedData(signatureParams);\n\n    validateSignature({\n      signatureParams,\n      signature,\n      expectedAccount: params.messageSigner.address,\n      errorSource: \"expressOrders.batch.signatureValidation\",\n      silent: true,\n    });\n  }\n\n  let batchCalldata: string;\n  if (isGmxAccount) {\n    const srcChainId =\n      (await getMultichainInfoFromSigner(signer, chainId)) ?? chainId;\n\n    if (!srcChainId) {\n      throw new Error(\"No srcChainId\");\n    }\n\n    if (subaccount) {\n      batchCalldata = encodeFunctionData({\n        abi: abis.MultichainSubaccountRouter,\n        functionName: \"batch\",\n        args: [\n          {\n            ...params.relayPayload,\n            signature,\n          } satisfies RelayParamsPayloadWithSignature,\n          subaccount.signedApproval,\n          params.account,\n          BigInt(srcChainId),\n          subaccount.signedApproval?.subaccount,\n          params.paramsLists,\n        ],\n      });\n    } else {\n      batchCalldata = encodeFunctionData({\n        abi: abis.MultichainOrderRouter,\n        functionName: \"batch\",\n        args: [\n          {\n            ...params.relayPayload,\n            signature,\n          },\n          params.account,\n          BigInt(srcChainId),\n          params.paramsLists,\n        ],\n      });\n    }\n  } else {\n    if (subaccount) {\n      batchCalldata = encodeFunctionData({\n        abi: abis.SubaccountGelatoRelayRouter,\n        functionName: \"batch\",\n        args: [\n          {\n            ...params.relayPayload,\n            signature,\n          },\n          subaccount.signedApproval,\n          params.account,\n          subaccount.signedApproval?.subaccount,\n          params.paramsLists,\n        ],\n      });\n    } else {\n      batchCalldata = encodeFunctionData({\n        abi: abis.GelatoRelayRouter,\n        functionName: \"batch\",\n        args: [\n          {\n            ...params.relayPayload,\n            signature,\n          },\n          params.account,\n          params.paramsLists,\n        ],\n      });\n    }\n  }\n\n  return {\n    callData: batchCalldata,\n    to: relayRouterAddress,\n    feeToken: relayerFeeTokenAddress,\n    feeAmount: relayerFeeAmount,\n  };\n}\n\nexport async function getBatchSignatureParams({\n  signer,\n  relayParams,\n  batchParams,\n  chainId,\n  account,\n  subaccountApproval,\n  relayRouterAddress,\n}: {\n  account: string;\n  subaccountApproval: SignedSubaccountApproval | undefined;\n  signer: ISigner;\n  relayParams: RelayParamsPayload | RelayParamsPayload;\n  batchParams: BatchOrderTxnParams;\n  chainId: ContractsChainId;\n  relayRouterAddress: string;\n}): Promise<SignTypedDataParams> {\n  const types = {\n    Batch: [\n      { name: \"account\", type: \"address\" },\n      { name: \"createOrderParamsList\", type: \"CreateOrderParams[]\" },\n      { name: \"updateOrderParamsList\", type: \"UpdateOrderParams[]\" },\n      { name: \"cancelOrderKeys\", type: \"bytes32[]\" },\n      { name: \"relayParams\", type: \"bytes32\" },\n      { name: \"subaccountApproval\", type: \"bytes32\" },\n    ],\n    CreateOrderParams: [\n      { name: \"addresses\", type: \"CreateOrderAddresses\" },\n      { name: \"numbers\", type: \"CreateOrderNumbers\" },\n      { name: \"orderType\", type: \"uint256\" },\n      { name: \"decreasePositionSwapType\", type: \"uint256\" },\n      { name: \"isLong\", type: \"bool\" },\n      { name: \"shouldUnwrapNativeToken\", type: \"bool\" },\n      { name: \"autoCancel\", type: \"bool\" },\n      { name: \"referralCode\", type: \"bytes32\" },\n      { name: \"dataList\", type: \"bytes32[]\" },\n    ],\n    CreateOrderAddresses: [\n      { name: \"receiver\", type: \"address\" },\n      { name: \"cancellationReceiver\", type: \"address\" },\n      { name: \"callbackContract\", type: \"address\" },\n      { name: \"uiFeeReceiver\", type: \"address\" },\n      { name: \"market\", type: \"address\" },\n      { name: \"initialCollateralToken\", type: \"address\" },\n      { name: \"swapPath\", type: \"address[]\" },\n    ],\n    CreateOrderNumbers: [\n      { name: \"sizeDeltaUsd\", type: \"uint256\" },\n      { name: \"initialCollateralDeltaAmount\", type: \"uint256\" },\n      { name: \"triggerPrice\", type: \"uint256\" },\n      { name: \"acceptablePrice\", type: \"uint256\" },\n      { name: \"executionFee\", type: \"uint256\" },\n      { name: \"callbackGasLimit\", type: \"uint256\" },\n      { name: \"minOutputAmount\", type: \"uint256\" },\n      { name: \"validFromTime\", type: \"uint256\" },\n    ],\n    UpdateOrderParams: [\n      { name: \"key\", type: \"bytes32\" },\n      { name: \"sizeDeltaUsd\", type: \"uint256\" },\n      { name: \"acceptablePrice\", type: \"uint256\" },\n      { name: \"triggerPrice\", type: \"uint256\" },\n      { name: \"minOutputAmount\", type: \"uint256\" },\n      { name: \"validFromTime\", type: \"uint256\" },\n      { name: \"autoCancel\", type: \"bool\" },\n      { name: \"executionFeeIncrease\", type: \"uint256\" },\n    ],\n  };\n\n  const srcChainId = await getMultichainInfoFromSigner(signer, chainId);\n  const domain = getGelatoRelayRouterDomain(\n    srcChainId ?? chainId,\n    relayRouterAddress\n  );\n\n  const paramsLists = getBatchParamsLists(batchParams);\n\n  const typedData = {\n    account: subaccountApproval ? account : zeroAddress,\n    createOrderParamsList: paramsLists.createOrderParamsList,\n    updateOrderParamsList: paramsLists.updateOrderParamsList,\n    cancelOrderKeys: paramsLists.cancelOrderKeys,\n    relayParams: hashRelayParams(relayParams as RelayParamsPayload),\n    subaccountApproval: subaccountApproval\n      ? hashSubaccountApproval(subaccountApproval)\n      : zeroHash,\n  };\n\n  return {\n    signer,\n    types,\n    typedData,\n    domain,\n    shouldUseSignerMethod: subaccountApproval !== undefined,\n  };\n}\n\nfunction getBatchParamsLists(batchParams: BatchOrderTxnParams) {\n  return {\n    createOrderParamsList: batchParams.createOrderParams.map((p) => ({\n      addresses: updateExpressOrdersAddresses(p.orderPayload.addresses),\n      numbers: p.orderPayload.numbers,\n      orderType: p.orderPayload.orderType,\n      decreasePositionSwapType: p.orderPayload.decreasePositionSwapType,\n      isLong: p.orderPayload.isLong,\n      shouldUnwrapNativeToken: p.orderPayload.shouldUnwrapNativeToken,\n      autoCancel: p.orderPayload.autoCancel,\n      referralCode: p.orderPayload.referralCode,\n      dataList: p.orderPayload.dataList,\n    })),\n    updateOrderParamsList: batchParams.updateOrderParams.map((p) => ({\n      key: p.updatePayload.orderKey,\n      sizeDeltaUsd: p.updatePayload.sizeDeltaUsd,\n      acceptablePrice: p.updatePayload.acceptablePrice,\n      triggerPrice: p.updatePayload.triggerPrice,\n      minOutputAmount: p.updatePayload.minOutputAmount,\n      validFromTime: p.updatePayload.validFromTime,\n      autoCancel: p.updatePayload.autoCancel,\n      executionFeeIncrease: p.updatePayload.executionFeeTopUp,\n    })),\n    cancelOrderKeys: batchParams.cancelOrderParams.map((p) => p.orderKey),\n  };\n}\n\nexport async function getMultichainInfoFromSigner(\n  signer: ISigner,\n  chainId: ContractsChainId\n): Promise<SourceChainId | undefined> {\n  const srcChainId = await signer\n    .getNetwork()\n    .then((n) => Number(n.chainId) as AnyChainId);\n\n  if (!isSourceChain(srcChainId)) {\n    return undefined;\n  }\n\n  const isMultichain = srcChainId !== (chainId as SourceChainId);\n\n  if (!isMultichain) {\n    return undefined;\n  }\n\n  return srcChainId;\n}\n\nexport function getOrderRelayRouterAddress(\n  chainId: ContractsChainId,\n  isSubaccount: boolean,\n  isMultichain: boolean\n): string {\n  let contractName: ContractName;\n  if (isMultichain) {\n    if (isSubaccount) {\n      contractName = \"MultichainSubaccountRouter\";\n    } else {\n      contractName = \"MultichainOrderRouter\";\n    }\n  } else {\n    if (isSubaccount) {\n      contractName = \"SubaccountGelatoRelayRouter\";\n    } else {\n      contractName = \"GelatoRelayRouter\";\n    }\n  }\n\n  return getContract(chainId, contractName);\n}\n\nexport async function buildAndSignBridgeOutTxn({\n  chainId,\n  srcChainId,\n  relayParamsPayload,\n  params,\n  signer,\n  account,\n  emptySignature = false,\n  relayerFeeTokenAddress,\n  relayerFeeAmount,\n}: {\n  chainId: SettlementChainId;\n  srcChainId: SourceChainId;\n  relayParamsPayload: RawRelayParamsPayload;\n  params: BridgeOutParams;\n  signer: ISigner | undefined;\n  account: string;\n  emptySignature?: boolean;\n  relayerFeeTokenAddress: string;\n  relayerFeeAmount: bigint;\n}): Promise<ExpressTxnData> {\n  let signature: string;\n\n  const relayParams: RelayParamsPayload = {\n    ...relayParamsPayload,\n    deadline: BigInt(nowInSeconds() + DEFAULT_EXPRESS_ORDER_DEADLINE_DURATION),\n  };\n\n  if (emptySignature) {\n    signature = \"0x\";\n  } else {\n    if (!signer) {\n      throw new Error(\"Signer is required\");\n    }\n\n    signature = await signBridgeOutPayload({\n      relayParams,\n      params,\n      signer,\n      chainId,\n      srcChainId,\n    });\n  }\n\n  const bridgeOutCallData = encodeFunctionData({\n    abi: abis.MultichainTransferRouter,\n    functionName: \"bridgeOut\",\n    args: [\n      {\n        ...relayParams,\n        signature,\n      },\n      account,\n      BigInt(srcChainId),\n      params,\n    ],\n  });\n\n  return {\n    callData: bridgeOutCallData,\n    to: getContract(chainId, \"MultichainTransferRouter\"),\n    feeToken: relayerFeeTokenAddress,\n    feeAmount: relayerFeeAmount,\n  };\n}\n\nasync function signBridgeOutPayload({\n  signer,\n  relayParams,\n  params,\n  chainId,\n  srcChainId,\n}: {\n  signer: ISigner;\n  relayParams: RelayParamsPayload;\n  params: BridgeOutParams;\n  chainId: SettlementChainId;\n  srcChainId: SourceChainId;\n}): Promise<string> {\n  const types = {\n    BridgeOut: [\n      { name: \"token\", type: \"address\" },\n      { name: \"amount\", type: \"uint256\" },\n      { name: \"minAmountOut\", type: \"uint256\" },\n      { name: \"provider\", type: \"address\" },\n      { name: \"data\", type: \"bytes\" },\n      { name: \"relayParams\", type: \"bytes32\" },\n    ],\n  };\n\n  const typedData = {\n    token: params.token,\n    amount: params.amount,\n    minAmountOut: params.minAmountOut,\n    provider: params.provider,\n    data: params.data,\n    relayParams: hashRelayParams(relayParams),\n  };\n\n  const domain = getGelatoRelayRouterDomain(\n    srcChainId,\n    getContract(chainId, \"MultichainTransferRouter\")\n  );\n\n  return signTypedData({ signer, domain, types, typedData });\n}\n\nexport async function buildAndSignSetTraderReferralCodeTxn({\n  chainId,\n  relayParamsPayload,\n  params,\n  signer,\n  emptySignature = false,\n  relayerFeeTokenAddress,\n  relayerFeeAmount,\n}: {\n  chainId: SettlementChainId;\n  relayParamsPayload: RelayParamsPayload;\n  params: BridgeOutParams;\n  signer: ISigner;\n  emptySignature?: boolean;\n  relayerFeeTokenAddress: string;\n  relayerFeeAmount: bigint;\n}): Promise<ExpressTxnData> {\n  const srcChainId = await getMultichainInfoFromSigner(signer, chainId);\n  if (!srcChainId) {\n    throw new Error(\"No srcChainId\");\n  }\n\n  const address = signer.address;\n\n  let signature: string;\n\n  if (emptySignature) {\n    signature = \"0x\";\n  } else {\n    signature = await signBridgeOutPayload({\n      relayParams: relayParamsPayload,\n      params,\n      signer,\n      chainId,\n      srcChainId,\n    });\n  }\n\n  const bridgeOutCallData = encodeFunctionData({\n    abi: abis.MultichainTransferRouter,\n    functionName: \"bridgeOut\",\n    args: [\n      {\n        ...relayParamsPayload,\n        signature,\n      },\n      address,\n      BigInt(srcChainId),\n      params,\n    ],\n  });\n\n  return {\n    callData: bridgeOutCallData,\n    to: getContract(chainId, \"MultichainTransferRouter\"),\n    feeToken: relayerFeeTokenAddress,\n    feeAmount: relayerFeeAmount,\n  };\n}\n\nexport async function signSetTraderReferralCode({\n  signer,\n  relayParams,\n  referralCode,\n  chainId,\n  srcChainId,\n  shouldUseSignerMethod,\n}: {\n  signer: ISigner;\n  relayParams: RelayParamsPayload;\n  referralCode: string;\n  chainId: ContractsChainId;\n  srcChainId: SourceChainId;\n  shouldUseSignerMethod?: boolean;\n}) {\n  const types = {\n    SetTraderReferralCode: [\n      { name: \"referralCode\", type: \"bytes32\" },\n      { name: \"relayParams\", type: \"bytes32\" },\n    ],\n  };\n\n  const domain = getGelatoRelayRouterDomain(\n    srcChainId ?? chainId,\n    getContract(chainId, \"MultichainOrderRouter\")\n  );\n  const typedData = {\n    referralCode: referralCode,\n    relayParams: hashRelayParams(relayParams),\n  };\n\n  return signTypedData({\n    signer,\n    domain,\n    types,\n    typedData,\n    shouldUseSignerMethod,\n  });\n}\n\nfunction updateExpressOrdersAddresses(\n  addresses: CreateOrderPayload[\"addresses\"]\n) {\n  return {\n    ...addresses,\n    receiver: addresses.receiver ?? zeroAddress,\n    uiFeeReceiver: setUiFeeReceiverIsExpress(addresses.uiFeeReceiver, true),\n  };\n}\n\nexport async function validateSignature({\n  signatureParams,\n  signature,\n  expectedAccount,\n  silent = false,\n  errorSource = \"validateSignature\",\n}: {\n  signatureParams: {\n    domain: SignatureDomain;\n    types: Record<string, any>;\n    typedData: Record<string, any>;\n  };\n  signature: string;\n  expectedAccount: string;\n  silent?: boolean;\n  errorSource?: string;\n}) {\n  try {\n    // Validate the signature\n    const recoveredAddress = await recoverTypedDataAddress({\n      domain: {\n        ...signatureParams.domain,\n        verifyingContract: signatureParams.domain.verifyingContract as Address,\n      },\n      types: signatureParams.types,\n      primaryType: \"Batch\",\n      message: signatureParams.typedData,\n      signature: signature as `0x${string}`,\n    });\n\n    const isValid =\n      recoveredAddress.toLowerCase() === expectedAccount.toLowerCase();\n\n    if (!isValid) {\n      throw extendError(new Error(\"Signature validation failed\"), {\n        data: {\n          recoveredAddress,\n          expectedAccount,\n          signature,\n        },\n      });\n    }\n  } catch (error: any) {\n    emitMetricEvent({\n      event: errorSource || \"unknown\",\n      isError: true,\n      data: error,\n    });\n\n    if (silent) {\n      return;\n    }\n\n    throw extendError(error, {\n      data: {\n        signature,\n        expectedAccount,\n      },\n    });\n  }\n}\n"]}